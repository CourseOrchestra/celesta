= Введение и основные понятия
:lang: ru
:is-main-doc:
include::_doc_general_attributes.adoc[]
:toclevels: 3
:doctype: book
:img: img
:lupa: icon:search[]
:source-highlighter: highlightjs
:toc: left

//image::{img}/

//tag::intro[]
== Введение
=== Описание и функциональные возможности

Система Celesta упрощает работу с реляционной базой данных из сервисов, реализующих бизнес-логику, и предоставляет следующее:

. Независимость от типа базы данных. Решение, сделанное в Celesta, можно прозрачно переносить между любыми базами данных поддерживаемых типов.
. Database-first проектирование структуры базы данных либо интеграцию с уже сложившейся базой данных.
. Автоматически генерируемый на основе структуры БД промежуточный слой доступа к таблицам для написания бизнес-логики.
. Автоматическую миграцию структуры базы данных на основе https://dzone.com/articles/trouble-free-database-migration-idempotence-and-co[идемпонтентного DDL].
. Элементарное модульное тестирование сервисов, работающих с базой данных.
. Распределение прав доступа к таблицам.
. При необходимости — аудит изменений, производимых в таблицах.

Система настолько, насколько это возможно прозрачно для разработчиков решения поддерживает следующие типы СУБД (в перспективе данный список может расширяться):

* MS SQL Server
* Oracle
* Postgre SQL
* H2

== Основные понятия

image::{img}/640px-Duke2-2.png[width=300]

Партитура (Score):: совокупность гранул, с ко
торыми работает данный экземпляр Celesta.

Гранула (Grain):: функциональная гранула (схема) БД. 

Имя гранулы (Grain name):: уникальный (для всех решений, когда-либо созданных на Celesta) набор латинских букв и цифр, начинающийся с буквы. Рекомендовано использование только строчных букв. Служит для идентификации гранул и разделения таблиц на пространства имён. Примеры имён: `bc`, `skk`, `sor`, `skp`. Используется, во-первых, для создания пространства имён таблиц (например, через schema в SQL Server), а во-вторых, для создания пакетов, в которых находятся классы слоя доступа к данным. Таким образом, не существует ограничения на глобальную уникальность имени таблицы среди всех гранул — достаточно уникальности имени таблицы внутри гранулы, т. е. могут одновременно существовать, например, таблицы `skk.application` и `sor.application`. Имя гранулы должно быть, по возможности, кратким: во-первых, из-за того, что имя каждой гранулы часто используется в коде, а во-вторых, из-за ограничений реализации в СУБД Oracle, суммарная длина имени гранулы и имени таблицы не может превышать 29 символов.

Скрипт создания гранулы (Grain creation script):: текстовый файл, содержащий скрипт на языке <<1050_celesta_sql.adoc#CelestaSQL,CelestaSQL>>. Возможна разработка и модификация скрипта гранулы <<2020_dbschema.adoc#DBSchema,с помощью программы DbSchema>>. Этот файл содержит информацию о
. таблицах, включая информацию о
.. полях и их типах (подмножество допустимых типов выбрано таким образом, чтобы обеспечить универсальную поддержку во всех поддерживаемых типах баз данных)
.. первичном ключе (primary key) таблицы – его наличие обязательно требуется для работы промежуточного слоя,
.. DEFAULT-значениях на полях,
.. ограничениях NOT NULL на полях,
. индексах,
. последовательностях (SEQUENCEs),
. связях между таблицами (Foreign Keys),
. представлениях (VIEWs).

Версия гранулы (Grain version tag):: идентификатор версии в виде перечисленных через запятую компонент, явно проставляемый разработчиком гранулы в команде `CREATE GRAIN ... VERSION ...` скрипта гранулы. Служит для защиты от непроизвольного автоматического даунгрейда базы данных при запуске старой версии гранулы на более свежей версии базы данных. Автообновление базы данных никогда не будет выполняться, если version tag в базе данных больше, чем version tag скрипта гранулы, либо если версии не согласованы.

IMPORTANT: Версия состоит из перечисленных через запятую компонент и может выглядеть таким образом: `1.23,TITAN3.34`. Читать это нужно следующим образом: базовая версия 1.23, доработка для проекта TITAN – 3.34. Регулярное выражение для проверки формата компонента: `([A-Z_]*)([0-9]+\\.[0-9]+)`. Требуется, чтобы каждая из составляющих версии имела двухкомпонентный (и только  двухкомпонентный!) формат, а префикс либо отсутствовал, либо состоял из заглавных латинских букв и знака подчёркивания. Когда  система определяет возможность автоапгрейда, сравниваются все тэги версии последовательно. 

В этом смысле, по отношению к тэгу «1.23,TITAN3.34»:

* «1.23,TITAN3.35» – более свежая версия (обновилась модификация), можно выполнять автоапдейт
* «1.24,TITAN3.34» – более свежая версия (обновилась базовая версия), можно выполнять автоапдейт
* «1.23,TITAN3.34,PLUTO1.00» – более свежая версия (добавилась ещё одна модификация), можно выполнять автоапдейт
* «TITAN3.34,1.23» – та же самая версия (порядок следования тэгов не играет роли), автоапдейт выполняться будет лишь при несовпадении контрольных сумм, ошибки не произойдёт
* «1.22,TITAN3.34» – более старая базовая версия, автоапдейт выполняться не будет, произойдёт ошибка и Celesta остановится.
* «1.22,TITAN3.36» – несогласующаяся версия, апдейт выполняться не будет, ошибка. Версии «1.23,PLUTO1.00», «1.25» также будут несогласующимся с версией «1.23,TITAN3.34» и не станут накатываться автоматически (для самоконтроля попробуйте объяснить себе, почему).

Каждая из версий сравнивается, как число с плавающей запятой.

Контрольная сумма гранулы (Grain checksum):: автоматически вычисляемая контрольная сумма скрипта гранулы. Служит для различения гранул по структуре базы данных. Следует осознавать, что скрипты создания гранул, имеющие одинаковый version tag, могут преднамеренно (в процессе разработки) или непреднамеренно (из-за неаккуратности разработчика) иметь различное содержание. База данных, автоматически сформированная по grain creation script, помимо version tag, хранит и контрольную сумму grain creation script'а, чтобы отследить момент, когда к ней установило контакт приложение с изменённым метаописанием гранулы. Одновременное равенство version tag и grain checksum является достаточным условием для того, чтобы продолжать работу без попыток обновления структуры базы данных.  Ради лёгкости проверки и открытости алгоритма контрольная сумма состоит из двух значений: длины файла скрипта (записываемой в формате десятичного числа) и его CRC32 (записываемом в виде 8 шестнадцатеричных цифр).

Score path:: аналог CLASSPATH для Java, т. е. набор перечисленных через разделитель папок с наборами гранул. Папка с набором гранул — это папка, подпапки которой имеют имена гранул, и содержат скрипты создания гранул с расширением .sql.

Гранулы из папок с наборами для Celesta собираются в единый список, т. е. в процессе работы Celesta нет никакой возможности (и необходимости) определить, к какому из наборов принадлежит та или иная гранула. Каждая гранула в системе должна иметь уникальное имя, и если мы работаем всего с одним набором гранул, то уникальность имени обеспечивается файловой системой. Однако используя несколько наборов гранул через точку с запятой, мы не застрахованы от случая, когда гранула с одним и тем же именем через разные наборы входит в систему дважды. В этом случае при инициализации Celesta произойдёт ошибка. Score path задаётся в настроечном .properties-файле, см. раздел <<1030_basic_settings.adoc#,Базовая настройка Celesta>>.

Системная гранула celesta:: особая гранула, структура таблиц которой не подлежит изменению. Таблицы этой гранулы используются системой во внутренних целях. При этом запись и редактирование данных в части из этих таблиц является частью стандартной настройки системы. Описание гранулы "celesta" см. в разделе «<<1040_system_tables.adoc#,Системные таблицы Celesta>>».

Таблица celesta.grains:: системная таблица Celesta в базе данных. Наличие данной таблицы указывает на то, что Celesta подсоединена к «своей» базе данных, в противном случае Celesta будет пытаться развернуть базу «с нуля». Таблица содержит информацию о состоянии гранул, развёрнутых в базе. Описание полей таблицы содержится в разделе <<1040_system_tables.adoc#celesta_grains_table,«Системные таблицы Celesta»>>. Информация в этой таблице активно используется во время Grain startup sequence (см. далее).

Статус гранулы в базе данных (Grain database state):: сохраняемое таблице grains состояние гранулы по отношению к базе, наполненной данными. Может быть одним из следующих:

** 0 – *ready* — гранула развёрнута и готова к использованию (при этом её version tag и контрольная сумма записаны в соответствующих полях таблицы grains).
** 1 – *upgrading* — гранула находится в процессе создания или апгрейда другим приложением Celesta, подключённым к базе данных.
** 2 – *error* — последняя попытка автообновления завершилась неудачно, в этом случае в поле message находится сообщение об ошибке
** 3 – *recover* (эквивалент — отсутствие записи в таблице grains при наличии гранулы в папке score) — гранула отсутствует или нуждается в регенерации (например, после ошибки апгрейда)
** 4 – *lock* — гранула не нуждается в автоматическом обновлении структуры ни при каких обстоятельствах.

Необходимость статуса upgrading определяется тем, что СУБД Oracle не поддерживает DDL-транзакций. В то же время, мы предполагаем возможность одновременного подключения нескольких серверов приложений Celesta к одной базе данных. Выставление статуса upgrading, поэтому, влияет на grain startup sequence и предотвращает конфликты при автоматическом обновлении.

Последовательность запуска гранулы (Grain startup sequence):: операции, выполняемые системой Celesta для каждой гранулы при запуске. При этом, при необходимости, происходит перегенерация классов доступа к данным, а также, при необходимости и возможности, автоапгрейд базы данных (см. далее отдельно про автоапгрейд и activity-диаграммы).

Автоапргейд базы данных:: составная часть Grain startup sequence, при которой происходит сравнение структуры существующей базы данных со структурой, заданной метаданными в Celesta при помощи скриптов создания гранул. После сравнения разница устраняется с помощью автоматически создаваемых и исполняемых CLREATE/ALTER команд.

//end::basic_terms[]

//end::intro[]
