properties(
[
	pipelineTriggers([
		triggers: [
			 [
				  $class: 'hudson.triggers.SCMTrigger',
				  scmpoll_spec : 'H/10 * * * *'
			 ]
		]
  ])
]
)

node {
    def server = Artifactory.server 'ART'
    def rtMaven = Artifactory.newMavenBuild()
    def buildInfo

    stage ('Clone') {
        checkout scm
        sh '''git reset --hard origin/dev'''
    }

    stage ('Old release branches cleanup') {
        sh '''git branch | grep release/ | xargs --no-run-if-empty git branch -D'''
    }

    stage ('Artifactory configuration') {
        rtMaven.tool = 'M3'
        rtMaven.deployer releaseRepo: 'libs-release-local', snapshotRepo: 'libs-snapshot-local', server: server
        rtMaven.resolver releaseRepo: 'libs-release', snapshotRepo: 'libs-snapshot', server: server
        rtMaven.deployer.artifactDeploymentPatterns.addExclude("*celesta-test*")
    }

    stage ('Make release') {
        withCredentials([usernamePassword(credentialsId: 'd2156430-3faf-426d-8648-c6ec26e7da37', passwordVariable: 'gitPassword', usernameVariable: 'gitUserName')]) {
            rtMaven.run pom: 'pom.xml', goals: '-Dgit.username=${gitUserName} -Dgit.password=${gitPassword} -B jgitflow:release-start -P corchestra-release'
            rtMaven.run pom: 'pom.xml', goals: '-Dmaven.test.skip=true -Dgit.username=${gitUserName} -Dgit.password=${gitPassword} jgitflow:release-finish -P corchestra-release'
            sh '''git checkout master'''
            buildInfo = Artifactory.newBuildInfo()
            buildInfo.env.capture = true
            rtMaven.run pom: 'pom.xml', goals: '-Dmaven.test.skip=true clean install -P corchestra-release', buildInfo: buildInfo
        }

        def distributionConfig = [
            // Mandatory parameters
            'buildName'             : buildInfo.name,
            'buildNumber'           : buildInfo.number,
            'targetRepo'            : 'libs-release-local',
                    // Optional parameters
            'overrideExistingFiles' : true // Default: false. If true, Artifactory overwrites builds already existing in the target path in Bintray.
        ]
        server.distribute distributionConfig
    }
}