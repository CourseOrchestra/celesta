<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Руководство пользователя Celesta</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Руководство пользователя Celesta</h1>
<div id="toc" class="toc2">
<div id="toctitle">Содержание</div>
<ul class="sectlevel1">
<li><a href="#_что_такое_celesta">Что такое Celesta?</a>
<ul class="sectlevel2">
<li><a href="#_основные_возможности">Основные возможности</a></li>
</ul>
</li>
<li><a href="#_часть_1_быстрый_старт">1. Часть 1. Быстрый старт</a>
<ul class="sectlevel2">
<li><a href="#_демонстрационный_пример">1.1. Демонстрационный пример</a>
<ul class="sectlevel3">
<li><a href="#quick_start_demo">1.1.1. Celesta и Spring Boot</a></li>
<li><a href="#_использование_celesta_совместно_со_spring_jdbc">1.1.2. Использование Celesta совместно со Spring-JDBC</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_часть_2_технические_детали_и_настройка_celesta">2. Часть 2. Технические детали и настройка Celesta</a>
<ul class="sectlevel2">
<li><a href="#_словарь_основных_понятий">2.1. Словарь основных понятий</a></li>
<li><a href="#_maven_плагин">2.2. Maven-плагин</a></li>
<li><a href="#_операции_выполняемые_при_инициализации_celesta">2.3. Операции, выполняемые при инициализации Celesta</a>
<ul class="sectlevel3">
<li><a href="#startup_sequence">2.3.1. Общая последовательность операций</a></li>
<li><a href="#_автоматическая_миграция_базы_данных">2.3.2. Автоматическая миграция базы данных</a></li>
<li><a href="#_полное_или_частичное_отключение_автоматической_миграции">2.3.3. Полное или частичное отключение автоматической миграции</a></li>
</ul>
</li>
<li><a href="#basic_settings_section">2.4. Параметры конфигурации Celesta</a></li>
<li><a href="#system_tables">2.5. Системные таблицы Celesta</a>
<ul class="sectlevel3">
<li><a href="#_структура_системной_схемы_celesta">2.5.1. Структура системной схемы <code>celesta</code></a></li>
<li><a href="#celesta_grains_table">2.5.2. Таблица celesta.grains</a></li>
<li><a href="#access_rights_granting">2.5.3. Система распределения прав доступа</a></li>
<li><a href="#_система_логирования">2.5.4. Система логирования</a></li>
<li><a href="#profiling_mode">2.5.5. Система профилирования</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_часть_3_проектирование_базы_данных_в_celesta">3. Часть 3. Проектирование базы данных в Celesta</a>
<ul class="sectlevel2">
<li><a href="#CelestaSQL">3.1. CelestaSQL</a>
<ul class="sectlevel3">
<li><a href="#_язык_celestasql_определения_объектов_базы_данных">3.1.1. Язык CelestaSQL определения объектов базы данных</a></li>
<li><a href="#_комментарии_в_языке_celestasql">3.1.2. Комментарии в языке CelestaSQL</a></li>
<li><a href="#_идентификаторы_объектов_в_языке_celestasql">3.1.3. Идентификаторы объектов в языке CelestaSQL</a></li>
<li><a href="#create_schema_statement">3.1.4. Конструкция CREATE SCHEMA (GRAIN)</a></li>
<li><a href="#create_sequence_statement">3.1.5. Конструкция CREATE SEQUENCE</a></li>
<li><a href="#create_table_statement">3.1.6. Конструкция CREATE TABLE</a></li>
<li><a href="#create_index_statement">3.1.7. Конструкция CREATE INDEX</a></li>
<li><a href="#create_view_statement">3.1.8. Конструкция CREATE VIEW</a></li>
<li><a href="#create_materialized_view_statement">3.1.9. Конструкция CREATE MATERIALIZED VIEW</a></li>
<li><a href="#create_function_statement">3.1.10. Конструкция CREATE FUNCTION</a></li>
</ul>
</li>
<li><a href="#CelestaDoc">3.2. CelestaDoc</a></li>
</ul>
</li>
<li><a href="#_часть_4_создание_и_тестирование_методов_обращающихся_к_данным">4. Часть 4. Создание и тестирование методов, обращающихся к данным</a>
<ul class="sectlevel2">
<li><a href="#celesta_instantiation">4.1. Создание экземпляра класса <code>Celesta</code></a>
<ul class="sectlevel3">
<li><a href="#_методы_celesta_createinstance">4.1.1. Методы <code>Celesta.createInstance</code></a></li>
</ul>
</li>
<li><a href="#_контекст_вызова">4.2. Контекст вызова</a>
<ul class="sectlevel3">
<li><a href="#_создание_и_жизненный_цикл_контекста_вызова">4.2.1. Создание и жизненный цикл контекста вызова</a></li>
<li><a href="#_использование_контекста_вызова">4.2.2. Использование контекста вызова</a></li>
</ul>
</li>
<li><a href="#data_accessors_section">4.3. Работа с данными через классы доступа к данным (курсоры)</a>
<ul class="sectlevel3">
<li><a href="#_классы_доступа_и_их_стандартные_методы">4.3.1. Классы доступа и их стандартные методы</a></li>
<li><a href="#setFilter_usage">4.3.2. Использование метода setFilter</a></li>
<li><a href="#setIn_usage">4.3.3. Использование метода setIn</a></li>
<li><a href="#_класс_sequence">4.3.4. Класс Sequence</a></li>
<li><a href="#_распределение_прав_доступа_и_протоколирование_изменений">4.3.5. Распределение прав доступа и протоколирование изменений</a></li>
<li><a href="#BLOB_fields">4.3.6. BLOB-поля</a></li>
<li><a href="#Option_fields">4.3.7. Option-поля</a></li>
<li><a href="#dynamic_access">4.3.8. Динамический доступ к данным</a></li>
</ul>
</li>
<li><a href="#triggers_section">4.4. Триггеры</a></li>
<li><a href="#xrec_section">4.5. Объект xRec</a></li>
<li><a href="#Lost_updates_protection">4.6. Защита от потерянных обновлений</a>
<ul class="sectlevel3">
<li><a href="#_что_такое_потерянное_обновление_lost_update">4.6.1. Что такое потерянное обновление (lost update)?</a></li>
<li><a href="#_способы_защиты_от_потерянных_обновлений">4.6.2. Способы защиты от потерянных обновлений</a></li>
<li><a href="#_защита_от_потерянных_обновлений_в_celesta">4.6.3. Защита от потерянных обновлений в Celesta</a></li>
</ul>
</li>
<li><a href="#celestaunit_section">4.7. CelestaUnit</a>
<ul class="sectlevel3">
<li><a href="#_пример_пользования">4.7.1. Пример пользования</a></li>
<li><a href="#_изменение_настроек_celestaunit_по_умолчанию">4.7.2. Изменение настроек CelestaUnit по умолчанию</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_часть_5_работа_с_метаданными_celesta">5. Часть 5. Работа с метаданными Celesta</a>
<ul class="sectlevel2">
<li><a href="#Celesta_metadata">5.1. Метаданные Celesta</a>
<ul class="sectlevel3">
<li><a href="#_метаданные_и_их_динамическое_изменение">5.1.1. Метаданные и их динамическое изменение</a></li>
<li><a href="#_состав_метаданных">5.1.2. Состав метаданных</a></li>
<li><a href="#_модификация_метаданных">5.1.3. Модификация метаданных</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_приложение">6. Приложение</a>
<ul class="sectlevel2">
<li><a href="#best_practices">6.1. Лучшие практики написания кода</a>
<ul class="sectlevel3">
<li><a href="#_явно_закрывайте_курсоры_создаваемые_в_цикле">6.1.1. Явно закрывайте курсоры, создаваемые в цикле</a></li>
<li><a href="#_избегайте_создания_курсора_в_цикле">6.1.2. Избегайте создания курсора в цикле</a></li>
<li><a href="#_используйте_ограничение_количества_полей_в_курсоре">6.1.3. Используйте ограничение количества полей в курсоре</a></li>
<li><a href="#_методы_не_обращающиеся_к_базе_данных_работают_быстро">6.1.4. Методы, не обращающиеся к базе данных, работают быстро</a></li>
<li><a href="#_понимайте_семантику_метода_get">6.1.5. Понимайте семантику метода get</a></li>
<li><a href="#_не_производите_лишних_чтений_перед_удалением">6.1.6. Не производите лишних чтений перед удалением</a></li>
<li><a href="#_не_используйте_count_только_для_того_чтобы_определить_что_набор_данных_не_пуст">6.1.7. Не используйте count() только для того, чтобы определить, что набор данных не пуст</a></li>
<li><a href="#_пользуйтесь_сортировкой_на_уровне_базы_данных_для_того_чтобы_найти_минимальныемаксимальные_значения">6.1.8. Пользуйтесь сортировкой на уровне базы данных для того, чтобы найти минимальные/максимальные значения</a></li>
<li><a href="#_используйте_правильный_тип_фильтрации">6.1.9. Используйте правильный тип фильтрации</a></li>
<li><a href="#_применяйте_индексы">6.1.10. Применяйте индексы</a></li>
<li><a href="#_эффективно_кэшируйте_значения_при_работе_в_циклах">6.1.11. Эффективно кэшируйте значения при работе в циклах</a></li>
<li><a href="#_не_используйте_try_методы_без_необходимости">6.1.12. Не используйте try-методы без необходимости</a></li>
<li><a href="#_в_циклах_используйте_итерацию_вместо_навигации">6.1.13. В циклах используйте итерацию вместо навигации</a></li>
</ul>
</li>
<li><a href="#RDBMS_peculiarities">6.2. Особенности работы Celesta с поддерживаемыми типами СУБД</a>
<ul class="sectlevel3">
<li><a href="#_ms_sql_server">6.2.1. MS SQL Server</a></li>
<li><a href="#_oracle">6.2.2. Oracle</a></li>
<li><a href="#_postgresql">6.2.3. PostgreSQL</a></li>
<li><a href="#_firebird">6.2.4. Firebird</a></li>
<li><a href="#_h2">6.2.5. H2</a></li>
</ul>
</li>
<li><a href="#DBSchema">6.3. Проектирование базы данных Celesta в DBSchema</a>
<ul class="sectlevel3">
<li><a href="#_синхронизация_метаданных_celesta_и_проекта_dbschema">6.3.1. Синхронизация метаданных Celesta и проекта DBSchema</a></li>
<li><a href="#_создание_celestasql_скриптов_на_основе_структуры_существующей_бд">6.3.2. Создание CelestaSQL-скриптов на основе структуры существующей БД</a></li>
<li><a href="#_выгрузка_в_plantuml">6.3.3. Выгрузка в PlantUML</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_что_такое_celesta">Что такое Celesta?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/CourseOrchestra/celesta">Celesta</a>&#8201;&#8212;&#8201;инструмент для Java backend-разработчиков, ищущих более быстрые и простые способы разработки приложений на основе реляционных баз данных.</p>
</div>
<div class="paragraph">
<p>Это Java-библиотека и Maven-плагин, предоставляющие возможности миграций базы данных, ORM и тестирования.</p>
</div>
<div class="paragraph">
<p>В отличие от, например, Hibernate + Liquibase, Celesta не отделяет  задачи дизайна схемы базы данных и миграций схемы, и предоставляет быстрый и легковесный способ юнит-тестирования кода, работающего с базой данных.</p>
</div>
<div class="paragraph">
<p>Может быть использована путём подключения внешней зависимости через <a href="https://search.maven.org/search?q=a:celesta-parent">Maven Central</a>, также имеет собственный <a href="https://github.com/CourseOrchestra/spring-boot-starter-celesta">Spring Boot starter</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/640px-Duke2-2.png" alt="640px Duke2 2" width="300">
</div>
</div>
<div class="sect2">
<h3 id="_основные_возможности">Основные возможности</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Независимость от типа базы данных.</strong> Решение, сделанное в Celesta, может переноситься между любыми базами данных поддерживаемых типов с сохранением функциональности.
Мы по возможности прозрачно для разработчиков решений поддерживаем следующие типы СУБД (список не окончательный):</p>
<div class="ulist">
<ul>
<li>
<p>MS SQL Server,</p>
</li>
<li>
<p>Oracle,</p>
</li>
<li>
<p>Postgre SQL,</p>
</li>
<li>
<p>H2,</p>
</li>
<li>
<p>Firebird (beta).</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Database-first проектирование структуры данных.</strong> В Celesta проектируются таблицы, связи между ними и представления, а не классы.</p>
</li>
<li>
<p><strong>Автоматическая миграция структуры базы данных</strong> на основе <a href="https://dzone.com/articles/trouble-free-database-migration-idempotence-and-co">идемпотентного DDL</a>.</p>
</li>
<li>
<p>Упрощённое <strong>модульное тестирование</strong>: быстрые тесты классов, работающих с базой данных, на основе in-memory режима базы данных H2.</p>
</li>
<li>
<p>Автоматически генерируемый на основе структуры БД промежуточный слой доступа к таблицам для написания бизнес-логики.</p>
</li>
<li>
<p>Взаимодействие приложения с уже сложившейся базой данных (интеграция приложений через базу данных).</p>
</li>
<li>
<p>Распределение прав доступа к таблицам.</p>
</li>
<li>
<p>Аудит изменений, производимых в таблицах.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_часть_1_быстрый_старт">1. Часть 1. Быстрый старт</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_демонстрационный_пример">1.1. Демонстрационный пример</h3>
<div class="sect3">
<h4 id="quick_start_demo">1.1.1. Celesta и Spring Boot</h4>
<div class="paragraph">
<p>Тестовый пример, демонстрирующий возможности Celesta в проекте на основе Spring Boot, доступен здесь: <a href="https://github.com/inponomarev/celesta-demo/" class="bare">https://github.com/inponomarev/celesta-demo/</a>.</p>
</div>
<div class="paragraph">
<p>Для создания проекта Spring Boot с помощью Maven необходимо указать следующие зависимости:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    &lt;properties&gt;
       &lt;!-- Проверьте свежую версию ru.curs:spring-boot-starter-web на Maven Central --&gt;
       &lt;spring.boot.starter.celesta.version&gt;3.0.0&lt;/spring.boot.starter.celesta.version&gt;
       &lt;!-- Проверьте свежую версию ru.curs:celesta-parent на Maven Central --&gt;
       &lt;celesta.version&gt;8.0.1&lt;/celesta.version&gt;
    &lt;/properties&gt;

. . .
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;ru.curs&lt;/groupId&gt;
            &lt;!-- Собственный Spring Boot starter облегчает конфигурацию Celesta в Spring Boot приложениях --&gt;
            &lt;artifactId&gt;spring-boot-starter-celesta&lt;/artifactId&gt;
            &lt;version&gt;${spring.boot.starter.celesta.version}&lt;/version&gt;
            &lt;!-- Исключаем зависимость от Celesta, указанную в Celesta spring boot starter,
                 чтобы ниже указать более актуальный номер версии Celesta --&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;ru.curs&lt;/groupId&gt;
                    &lt;artifactId&gt;celesta-system-services&lt;/artifactId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;!-- Подключаем Celesta более свежей версии, чем предлагает Spring Boot Starter--&gt;
            &lt;groupId&gt;ru.curs&lt;/groupId&gt;
            &lt;artifactId&gt;celesta-system-services&lt;/artifactId&gt;
            &lt;version&gt;${celesta.version}&lt;/version&gt;
        &lt;/dependency&gt;
    ...
    &lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Также для кодогенерации <a href="#data_accessors_section">классов доступа к данным</a> понадобится <code>ru.curs:celesta-maven-plugin</code>.
В его настройках необходимо указать путь к папке <code>score</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;ru.curs&lt;/groupId&gt;
                &lt;artifactId&gt;celesta-maven-plugin&lt;/artifactId&gt;
                &lt;version&gt;${celesta.version}&lt;/version&gt;

                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;gen-cursors&lt;/goal&gt;
                            &lt;goal&gt;gen-score-resources&lt;/goal&gt;
                            &lt;goal&gt;gen-test-cursors&lt;/goal&gt;
                            &lt;goal&gt;gen-test-score-resources&lt;/goal&gt;
                        &lt;/goals&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>В папке <code>src/main/celestasql</code> следует разместить скрипты определения базы данных на языке <a href="#CelestaSQL">CelestaSQL</a>.
Например,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">-- celestasql/ru/curs/demo/demo.sql
CREATE SCHEMA demo VERSION '1.0';

/**Заголовок счёта*/
CREATE TABLE OrderHeader(
  id VARCHAR(30) NOT NULL,
  date DATETIME,
  customer_id VARCHAR(30),

  /**Название клиента */
  customer_name VARCHAR(50),
  manager_id VARCHAR(30),
  CONSTRAINT Pk_OrderHeader PRIMARY KEY (id)
);

/**Строка счёта*/
CREATE TABLE OrderLine(
  order_id VARCHAR(30) NOT NULL,
  line_no INT NOT NULL,
  item_id VARCHAR(30) NOT NULL,
  item_name VARCHAR(100),
  qty INT NOT NULL DEFAULT 0,
  cost REAL NOT NULL DEFAULT 0.0,
  CONSTRAINT Idx_OrderLine PRIMARY KEY (order_id, line_no)
);

ALTER TABLE OrderLine ADD CONSTRAINT fk_OrderLine FOREIGN KEY (order_id) REFERENCES OrderHeader(id);
create materialized view OrderedQty as
select item_id, sum(qty) as qty from OrderLine group by item_id;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Команда <code>mvn verify</code> приведёт к появлению Java-файлов <code>OrderHeaderCursor.java</code>
 и <code>OrderLineCursor.java</code> с <a href="#data_accessors_section">классами курсоров</a> в папке  <code>target/generated-sources/celesta/&#8230;&#8203;</code>.</p>
</div>
<div class="paragraph">
<p>Эти классы можно использовать при создании сервисов (см. также более полный <a href="https://github.com/inponomarev/celesta-demo/blob/master/src/main/java/ru/curs/demo/service/DocumentService.java#L17">демонстрационный пример</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Service
public class DocumentService {
    @CelestaTransaction
    public void postOrder(CallContext context, OrderDto doc) {
        try (OrderHeaderCursor header = new OrderHeaderCursor(context);
             OrderLineCursor line = new OrderLineCursor(context)) {
             . . .
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Управление <a href="#basic_settings_section">настройками</a> проекта осуществляется любым <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-properties-and-configuration.html">доступным для Spring Boot способом</a>, в частности, с помощью файла <a href="https://github.com/inponomarev/celesta-demo/blob/master/src/main/resources/application.yml">application.yml</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_использование_celesta_совместно_со_spring_jdbc">1.1.2. Использование Celesta совместно со Spring-JDBC</h4>
<div class="paragraph">
<p>Celesta использует свой собственный пул соединений JDBC, если не предоставлено иной альтернативы.
Если вам необходимо использовать какой-либо особенный пул соединений, или если вы желаете использовать  <a href="https://docs.oracle.com/javase/8/docs/api/javax/sql/DataSource.html"><code>DataSource</code></a>, предоставляемый фреймворком Spring, вы также можете это сделать.</p>
</div>
<div class="paragraph">
<p>В самостоятельном приложении вы можете использовать метод <a href="#celesta_instantiation"><code>Celesta.createInstance</code></a>, подставив <code>DataSource</code> в качестве параметра.</p>
</div>
<div class="paragraph">
<p><code>spring-boot-starter-celesta</code> будет автоматически использовать <code>DataSorce</code>, если он предоставлен Spring-ом.</p>
</div>
<div class="paragraph">
<p>Например, если добавить в проект следующую зависимость:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>и прописать следующие аргументы в <code>application.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  datasource:
    url: jdbc:postgresql://&lt;DATABASE&gt;
    username: &lt;USER&gt;
    password: &lt;PWD&gt;
    hikari:
      auto-commit: false
celesta:
  jdbc:
    url: jdbc:postgresql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Celesta запустится с <a href="https://github.com/brettwooldridge/HikariCP">Hikari Connection Pool</a>, предоставленным Spring-ом. Обратите внимание на следующее:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Важно"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Внешний пул соединений должен быть сконфигурирован так, чтобы возвращать соединения с <code>autoCommit</code> установленным в <code>false</code>.</p>
</li>
<li>
<p>Вам всё ещё необходимо прописать параметр <code>celesta.jdbc.url</code> для того, чтобы Celesta определила тип базы данных, с которой она работает. Но т. к. этот параметр не будет использоваться для того, чтобы подключаться к базе данных, достаточно указать только префикс, например <code>jdbc:postgresql</code>, <code>jdbc:sqlserver</code> и т. д.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_часть_2_технические_детали_и_настройка_celesta">2. Часть 2. Технические детали и настройка Celesta</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_словарь_основных_понятий">2.1. Словарь основных понятий</h3>
<div id="celesta_vocabulary" class="dlist">
<dl>
<dt class="hdlist1">Партитура (Score)</dt>
<dd>
<p>совокупность схем базы данных, с которыми работает данный экземпляр Celesta, представленных в виде <a href="#CelestaSQL">CelestaSQL</a> скриптов.</p>
</dd>
<dt class="hdlist1"><a href="#CelestaSQL">CelestaSQL</a> скрипт</dt>
<dd>
<p>текстовый файл, который содержит информацию о</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>схемах базы данных.
Внимание: по историческим причинам, синонимом понятию «схема» (schema) в Celesta также является слово «гранула» (grain).</p>
</li>
<li>
<p>таблицах, включая информацию о</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>полях и их типах (подмножество допустимых типов выбрано таким образом, чтобы обеспечить универсальную поддержку во всех поддерживаемых типах баз данных)</p>
</li>
<li>
<p>первичном ключе (primary key) таблицы – его наличие обязательно требуется для работы <a href="#data_accessors_section">классов доступа к данным</a>,</p>
</li>
<li>
<p><code>DEFAULT</code>-значениях на полях,</p>
</li>
<li>
<p>ограничениях <code>NOT NULL</code> на полях,</p>
</li>
</ol>
</div>
</li>
<li>
<p>индексах,</p>
</li>
<li>
<p>последовательностях (sequences),</p>
</li>
<li>
<p>связях между таблицами (foreign keys),</p>
</li>
<li>
<p>представлениях (views), включая материализованные представления (materialized views) и параметризованные (functions).</p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>В процессе работы <a href="#maven_plugin_section">Celesta Maven Plugin</a> на основе данных скриптов кодогенерируются классы доступа к данным, а сами эти файлы  копируются в ресурсы компилируемых jar-файлов.</p>
</div>
<div class="paragraph">
<p>В процессе запуска Celesta происходит автоматическое обновление схем базы данных до вида, заданного в CelestaSQL-скриптах.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Версия схемы (Schema version tag)</dt>
<dd>
<p>идентификатор версии в виде перечисленных через запятую компонент, явно проставляемый разработчиком гранулы в команде <a href="#version_tags"><code>CREATE GRAIN &#8230;&#8203; VERSION &#8230;&#8203;</code></a> скрипта гранулы.
Служит для защиты от непроизвольного автоматического даунгрейда базы данных при запуске старой версии гранулы на более свежей версии базы данных.
Автообновление базы данных никогда не будет выполняться, если version tag в базе данных больше, чем version tag скрипта гранулы, либо если версии не согласованы.</p>
</dd>
<dt class="hdlist1">Контрольная сумма схемы (Grain checksum)</dt>
<dd>
<p>автоматически вычисляемая контрольная сумма скрипта гранулы.
Служит для различения CelestaSQL-скриптов по их содержанию.
Скрипты CelestaSQL, имеющие одинаковый version tag, могут преднамеренно (в процессе разработки) или непреднамеренно (из-за неаккуратности разработчика) иметь различное содержание.
База данных, автоматически сформированная по grain creation script, помимо version tag, хранит и контрольную сумму grain creation script&#8217;а, чтобы отследить момент, когда к ней установило контакт приложение с изменённым метаописанием гранулы.
Одновременное равенство version tag и grain checksum является достаточным условием для того, чтобы продолжать работу без попыток обновления структуры базы данных.  Ради лёгкости проверки и открытости алгоритма контрольная сумма состоит из двух значений: длины файла скрипта (записываемой в формате десятичного числа) и его <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check#CRC-32_algorithm">CRC32</a> (записываемом в виде 8 шестнадцатеричных цифр).</p>
</dd>
<dt class="hdlist1">Системная гранула celesta</dt>
<dd>
<p>особая гранула, структура таблиц которой не подлежит изменению.
Таблицы этой гранулы используются системой во внутренних целях.
При этом запись и редактирование данных в части из этих таблиц является частью стандартной настройки системы.
Описание гранулы "celesta" см. в разделе <a href="#system_tables">Системные таблицы Celesta</a>.</p>
</dd>
<dt class="hdlist1">Таблица celesta.grains</dt>
<dd>
<p>центральная системная таблица Celesta в базе данных.
Наличие данной таблицы указывает на то, что Celesta подсоединена к «своей» базе данных, в противном случае Celesta будет пытаться развернуть базу «с нуля».
Таблица содержит информацию о состоянии гранул, развёрнутых в базе.
Описание полей таблицы содержится в разделе <a href="#celesta_grains_table">«Системные таблицы Celesta»</a>.
Информация в этой таблице активно используется во время <a href="#startup_sequence">startup sequence</a>.</p>
</dd>
<dt class="hdlist1">Последовательность запуска гранулы (Grain startup sequence)</dt>
<dd>
<p><a href="#startup_sequence">операции</a>, выполняемые системой Celesta для каждой гранулы при запуске.
При этом, при наличии необходимости и возможности, происходит автоматическая миграция базы данных.</p>
</dd>
<dt class="hdlist1">Автоматическая миграция базы данных</dt>
<dd>
<p>составная часть startup sequence, при которой происходит сравнение структуры существующей базы данных со структурой, заданной метаданными в Celesta при помощи скриптов создания гранул.
После сравнения разница устраняется с помощью автоматически создаваемых и исполняемых CREATE/ALTER команд.</p>
</dd>
<dt class="hdlist1">Класс доступа к данным (курсор)</dt>
<dd>
<p>автоматически кодогенерируемый на основе CelestaSQL-скрипта класс, через который можно осуществлять взаимодействие с данными таблицы, представления или последовательности.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_maven_плагин">2.2. Maven-плагин</h3>
<div id="maven_plugin_section" class="paragraph">
<p>Celesta-maven-plugin осуществляет кодогенерацию классов доступа к данным на основе CelestaSQL-скриптов.
Подключение этого плагина обязательно для проектов, использующих Celesta.</p>
</div>
<div class="paragraph">
<p>Пример использования:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
    &lt;groupId&gt;ru.curs&lt;/groupId&gt;
    &lt;artifactId&gt;celesta-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;${celesta.version}&lt;/version&gt;
    &lt;configuration&gt;
        &lt;scores&gt;
            &lt;score&gt;. . .&lt;/score&gt;
        &lt;/scores&gt;
        &lt;testScores&gt;
            &lt;testScore&gt;. . .&lt;/testScore&gt;
        &lt;/testScores&gt;
        &lt;!-- unnecessary, true by default --&gt;
        &lt;snakeToCamel&gt;true&lt;/snakeToCamel&gt;
    &lt;/configuration&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;goals&gt;
                &lt;goal&gt;gen-cursors&lt;/goal&gt;
                &lt;goal&gt;gen-score-resources&lt;/goal&gt;
                &lt;goal&gt;gen-test-cursors&lt;/goal&gt;
                &lt;goal&gt;gen-test-score-resources&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Параметры конфигурации плагина:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>scores</code> — пути к папкам в проекте, где размещены <a href="#CelestaSQL">CelestaSQL</a>-скрипты, описывающие рабочую базу данных.
По умолчанию содержит путь <code>src/main/celestasql</code>.</p>
</li>
<li>
<p><code>testScores</code> — пути к папкам в проекте, где размещены <a href="#CelestaSQL">CelestaSQL</a>-скрипты, описывающие базу данных, используемую только для <a href="#celestaunit_section">модульного тестирования</a>.
По умолчанию содержит путь <code>src/test/celestasql</code>.</p>
</li>
<li>
<p><code>snakeToCamel</code> (boolean-параметр, по умолчанию равен true) – следует ли конвертировать имена таблиц и полей, заданные в "snake_case" в CelestaSQL, в "CamelCase" в <a href="#data_accessors_section">классах доступа к данным</a>, чтобы соответствовать стандартам именования в Java.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Celesta Maven Plugin производит следующие операции:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Кодогенерирует <a href="#data_accessors_section">курсоры</a> на основе <a href="#CelestaSQL">CelestaSQL</a>:</p>
<div class="ulist">
<ul>
<li>
<p>На фазе <code>generate-sources</code> происходит кодогенерация курсоров из <code>scores</code> и опционально папки <code>score</code> в <code>target/generated-sources/celesta</code>,</p>
</li>
<li>
<p>На фазе <code>generate-test-sources</code>&#8201;&#8212;&#8201;из <code>testScores</code> в <code>target/generated-test-sources/celesta</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Копирует CelestaSQL файлы в ресурсы:</p>
<div class="ulist">
<ul>
<li>
<p>На фазе <code>generate-resources</code> происходит копирование файлов CelestaSQL из <code>scores</code> и опционально папки <code>score</code> в <code>generated-resources/score</code></p>
</li>
<li>
<p>На фазе <code>generate-test-resources</code>&#8201;&#8212;&#8201;из <code>testScores</code> в <code>generated-test-resources/score</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Генерирует индекс <code>score.files</code> с перечнем относительных путей к .sql-файлам в ресурсах:</p>
<div class="ulist">
<ul>
<li>
<p>На фазе <code>generate-resources</code> &#8594; <code>generated-resources/score/score.files</code></p>
</li>
<li>
<p>На фазе <code>generate-test-resources</code> &#8594; <code>generated-test-resources/score/score.files</code></p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>Эти файлы используются во время выполнения Celesta для того, чтобы найти пути ко всем CelestaSQL-файлам внутри jar-файлов на classpath.</p>
</div>
</div>
<div class="sect2">
<h3 id="_операции_выполняемые_при_инициализации_celesta">2.3. Операции, выполняемые при инициализации Celesta</h3>
<div class="sect3">
<h4 id="startup_sequence">2.3.1. Общая последовательность операций</h4>
<div class="paragraph">
<p>Инициализация Celesta происходит в несколько этапов, о чём сообщает вывод в лог:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Celesta ver. 7.2.4
Celesta pre-initialization: system settings reading...
done.
Celesta initialization: score parsing...
done.
Celesta initialization: database upgrade...
done.</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>В процессе <strong>чтения системных настроек</strong> Celesta анализирует состояние <a href="#basic_settings_section">параметров конфигурации</a>, проверяет тот факт, что все обязательные параметры заданы, и что все параметры заданы корректно.
При обнаружении ошибки в настройках запуск системы не будет продолжен.</p>
</li>
<li>
<p>При <strong>разборе метаданных</strong> происходит чтение всех доступных файлов *.sql, их синтаксический анализ и построение внутренней объектной модели базы данных (метаданных).
Система собирает из скриптов CelestaSQL информацию о гранулах, таблицах и полях.
Вычисляются их контрольные суммы, находятся версии.
При возникновении ошибок синтаксиса или несогласованности CelestaSQL-скриптов на данном этапе запуск системы прерывается.</p>
</li>
<li>
<p>Процедура <strong>авто-миграции</strong> базы данных.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_автоматическая_миграция_базы_данных">2.3.2. Автоматическая миграция базы данных</h4>
<div class="paragraph">
<p>На этом этапе сервер приложений соединяется с базой данных и проверяет наличие в ней системной таблицы <code>celesta.grains</code>.
Если таблица не найдена, она автоматически создаётся (<code>CREATE</code>-командой), однако это происходит лишь в следующих случаях: 1) база данных совершенно пустая 2) в параметрах конфигурации выставлено свойство <code>force.dbinitialize</code> (это защищает от «порчи» существующих, непустых баз данных при ошибочном присоединении к ним системы Celesta).
Если в процессе проверки наличия/создания таблицы celesta.grains возникла ошибка, то генерируется фатальная ошибка и система не запускается.</p>
</div>
<div class="sect4">
<h5 id="_определение_необходимости_миграции_гранулы_схемы">Определение необходимости миграции гранулы (схемы)</h5>
<div class="paragraph">
<p>Далее идёт цикл по всем доступным в метаданных гранулам (схемам) и всем доступным в <code>celesta.grains</code> гранулам. (При этом из процесса миграции исключаются гранулы, объявленные с опцией <code>WITH NO AUTOUPDATE</code> в CelestaSQL-скрипте).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Если гранула есть в метаданных, но её нет в таблице <code>celesta.grains</code> — выполняется апдейт по CelestaSQL-скрипту (т. е. предполагается, что соответствующие таблицы в базе данных могут и присутствовать).</p>
</li>
<li>
<p>Если гранула есть в <code>celesta.grains</code>, но её нет в метаданных — ничего не происходит.
Автоматически гранулы из базы данных не удаляются, т. к. их таблицы могут содержать важную информацию.
Просто для этих таблиц не будут сформированы классы доступа к данным.</p>
</li>
<li>
<p>Если гранула есть и там, и там: сервер приложений находит в таблице <code>celesta.grains</code> запись про состояние, версию и контрольную сумму метаданных, которые были «накатаны» на базу данных при последнем запуске и сравнивает с версией метаданных, которыми сервер располагает.
Записанное в таблице <code>celesta.grains</code> состояние может принимать одно из этих значений:</p>
<div class="ulist">
<ul>
<li>
<p><strong>recover (3)</strong> — действуем аналогично отсутствию записи (см. п. 1).</p>
</li>
<li>
<p><strong>lock (4)</strong> — структура не обновляется, переходим к следующей грануле.</p>
</li>
<li>
<p><strong>upgrading (1)</strong> или <strong>error (2)</strong> — останов процесса с ошибкой  “Cannot proceed with database upgrade: there are grains not in 'ready', 'recover' or 'lock' state”.</p>
</li>
<li>
<p><strong>ready (0)</strong> — продолжение процесса.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>Если версия и контрольная сумма совпадают — ничего не происходит.
Система полагает, что структура соответствующей гранулы базы данных уже соответствует CelestaSQL-скрипту и экономит время на анализе существующей структуры.</p>
</li>
<li>
<p>Если версия различна: если версия изменилась в сторону увеличения — апгрейд вне зависимости от контрольной суммы.
Если в сторону уменьшения либо если версия несовместима (см.  <a href="#version_tags">описание логики работы</a> с version tags) — вне зависимости от контрольной суммы останов с ошибкой: “Grain '&#8230;&#8203;' version '&#8230;&#8203;' is lower than / is inconsistent with database grain version '&#8230;&#8203;'. Will not proceed with auto-upgrade.”</p>
</li>
<li>
<p>Если версия совпадает, а контрольная сумма различна – апгрейд.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_процедура_миграции_гранулы_схемы">Процедура миграции гранулы (схемы).</h5>
<div class="paragraph">
<p>Если на основании описанного выше алгоритма система решает, что апгрейд гранулы необходим — начинается процесс синхронизации структуры БД и структуры данных, описанных в CelestaSQL-скрипте.
Все недостающие объекты&#8201;&#8212;&#8201;таблицы, поля, ключи, индексы, представления и т. п.&#8201;&#8212;&#8201;создаются.
Объекты, требующие модификации (например, типы данных полей, состав полей в индексе, SQL-запросы представлений)&#8201;&#8212;&#8201;модифицируются.
При этом система прикладывает максимальные усилия для того, чтобы модификация прошла автоматически и без ошибок.
Если в ряде случаев этого можно достичь всегда (например, в случае замены SQL-запроса в представлении на другой корректный, или при изменении состава полей в индексе), иногда без ручного вмешательства в процесс и выполнения ad hoc скрипта автоматически мигрировать схему невозможно (см. на эту тему <a href="https://dzone.com/articles/trouble-free-database-migration-idempotence-and-co">пост</a> об идемпотентных миграциях).
Ошибки на данном этапе приводят к переводу гранулы в состояние <strong>error</strong> и требуют ручного вмешательства администратора базы данных.</p>
</div>
<div class="paragraph">
<p>Если объект был удалён из CelestaSQL-скрипта, во избежание потери данных автоматический мигратор удаляет из БД лишь те объекты, которые не содержат данных (т. е. таблицы и поля автоматически не удаляются и могут быть удалены вручную в ad hoc-миграционном скрипте, с удалённых полей удаляются внешние ключи).</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_полное_или_частичное_отключение_автоматической_миграции">2.3.3. Полное или частичное отключение автоматической миграции</h4>
<div class="paragraph">
<p>В Celesta имеется несколько способов отключить процесс автомиграции:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>на уровне всей базы данных</strong> — с помощью опции <code>skip.dbupdate</code> в <a href="#basic_settings_section">параметрах конфигурации</a>,</p>
</li>
<li>
<p><strong>на уровне схемы</strong> — выставив её статус в <a href="#celesta_grains_table">таблице celesta.grains</a> в 4 либо объявив опцию <code>WITH NO AUTOUPDATE</code> в <a href="#create_schema_statement">выражении создания гранулы</a> (схемы),</p>
</li>
<li>
<p><strong>на уровне таблицы</strong> — объявив <a href="#celestasql_with_options">опцию <code>WITH NO AUTOUPDATE</code></a> в выражении создания таблицы.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="basic_settings_section">2.4. Параметры конфигурации Celesta</h3>
<div class="paragraph">
<p>К параметрам конфигурации Celesta относятся общесистемные параметры, такие как параметры подключения к базе данных.</p>
</div>
<div class="paragraph">
<p>Эти настройки в виде экземпляра <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Properties.html"><code>Properties</code></a> передаются в конструктор класса <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/BaseAppSettings.html"><code>BaseAppSettings</code></a>, который,
в свою очередь, является параметром конструктора класса <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/Celesta.html"><code>Celesta</code></a>.</p>
</div>
<div class="paragraph">
<p>При использовании <a href="https://github.com/CourseOrchestra/spring-boot-starter-celesta">Celesta Spring Boot starter</a>
эти настройки транслируются через конфигурацию любым из способов <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-properties-and-configuration.html">способов конфигурации</a> Spring Boot приложений, например, через файл
<code>application.yml</code>.
В последнем случае корневым ключом YAML-файла должен быть <code>celesta</code>, а остальные свойства записываются в иерархической структуре.</p>
</div>
<div class="paragraph">
<p>Например, для задания свойств <code>jdbc.url</code>, <code>jdbc.username</code> и <code>jdbc.password</code> структура файла <code>application.yml</code> будет следующей:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">celesta:
  jdbc:
    url: jdbc:postgresql://127.0.0.1:5432/celesta
    # url: jdbc:sqlserver://172.16.1.114:52836;databaseName=celesta
    # url: jdbc:oracle:thin:192.168.110.128:1521:XE
    username: foo
    password: bar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Некоторые IDE, например, IntelliJ IDEA, выполняют контекстную подсказку при редактировании файла <code>application.yml</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col style="width: 40%;">
<col style="width: 20%;">
<col style="width: 10%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Параметр</th>
<th class="tableblock halign-center valign-middle">Назначение</th>
<th class="tableblock halign-center valign-middle">Обязательный</th>
<th class="tableblock halign-center valign-middle">Значение по умолчанию</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>rdbms.connection.url</code></p>
</div>
<div class="paragraph">
<p>(<code>jdbc.url</code> в <code>application.yml</code>)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>URL подключения к JDBC-драйверу</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>Да</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>-</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>rdbms.connection.username</code></p>
</div>
<div class="paragraph">
<p>(<code>jdbc.username</code> в <code>application.yml</code>)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Логин для подключения к базе данных</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>Нет (если не заполнен, используется информация из JDBC URL)</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>-</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>rdbms.connection.password</code></p>
</div>
<div class="paragraph">
<p>(<code>jdbc.password</code> в <code>application.yml</code>)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Пароль для подключения к базе данных</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>Нет (если не заполнен, используется информация из JDBC URL)</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>-</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>skip.dbupdate</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Заставляет систему при инициализации полностью пропустить фазу обновления базы данных (включая создание системных таблиц).</p>
</div>
<div class="paragraph">
<p>Этот параметр требуется при некоторых сценариях разворачивания Celesta на заранее существующей базе данных.</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>Нет</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>force.dbinitialize</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Заставляет систему при инициализации создавать системные объекты Celesta даже в том случае, если база данных не пустая (уже содержит таблицы).
Этот параметр рекомендуется использовать с осторожностью, чтобы не повредить существующую базу данных.</p>
</div>
<div class="paragraph">
<p>Этот параметр требуется при некоторых сценариях разворачивания Celesta на заранее существующей базе данных.</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>Нет</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>h2.in-memory</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Значение <code>true</code> заставляет Celesta использовать базу H2 в in-memory режиме.
Параметры JDBC подключения при этом игнорируются.
Режим необходим, прежде всего, для автоматических тестов.</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>Нет</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>h2.port</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Если указано целочисленное значение, и при этом <code>h2.in-memory</code> установлено в <code>true</code>, то база H2 запускается в виде сервера на указанном порту.
Данный режим позволяет присоединяться к базе данных H2 внешним приложениям, читать и модифицировать данные.
Параметры JDBC подключения при этом игнорируются.
Этот режим необходим для UI и приёмочных автоматических тестов.</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>Нет</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>h2.referential.integrity</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Использовать ли контроль ссылочной целостности (контроль Foreign Keys), работая с базой H2 в in-memory режиме (для всех других БД данный параметр игнорируется).
По умолчанию при работе с H2 in-memory, ссылочная целостность отключается для упрощения создания автоматических тестов.</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>Нет</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="system_tables">2.5. Системные таблицы Celesta</h3>
<div class="sect3">
<h4 id="_структура_системной_схемы_celesta">2.5.1. Структура системной схемы <code>celesta</code></h4>
<div class="paragraph">
<p>Помимо таблиц и схем, определённых пользователем, система Celesta добавляет в базу данных таблицы в собственной системной схеме <code>celesta</code>, структура которой представлена на диаграмме ниже.</p>
</div>
<div class="paragraph">
<p>Структура (в том числе состав полей) таблиц, относящихся к системной грануле "celesta", не подлежит изменению, а для доступа к их данным используются встроенные классы из пакета <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/syscursors/package-summary.html">ru.curs.celesta.syscursors</a>.
Тем не менее, изменение данных в части из этих таблиц является частью штатной настройки системы.</p>
</div>
<div class="paragraph">
<p>Системные таблицы предназначены для:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Координирования автоматической миграции (таблица <code>grains</code>).</p>
</li>
<li>
<p>Распределения прав доступа к таблицам и представлениям (<code>permissions</code>, <code>roles</code>, <code>userroles</code>).</p>
</li>
<li>
<p>Настройки системы логирования (<code>logsetup</code>) и хранения логов (<code>log</code>, <code>calllog</code>).</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="systemtables.png" alt="systemtables" width="975" height="668">
</div>
</div>
<div class="paragraph">
<p>Назначение таблиц:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">celesta.grains</dt>
<dd>
<p>перечень гранул со статусами.
Ведётся автоматически, ручные изменения разработчиком решений сводятся к выставлению статуса "recover" на грануле после неудавшейся попытки автообновления и к удалению записи об удалённой грануле.</p>
</dd>
<dt class="hdlist1">celesta.tables</dt>
<dd>
<p>перечень таблиц и представлений.
Содержимое данной таблицы автоматически синхронизируется с перечнем таблиц и представлений, доступных в гранулах Celesta, пользователю не следует вмешиваться в данные этой таблицы (в любом случае изменения будут потеряны при следующей синхронизации).
Поле tabletype указывает на то, является запись таблицей ("T") или представлением ("V").</p>
</dd>
<dt class="hdlist1">celesta.roles</dt>
<dd>
<p>перечень ролей celesta.
Сюда следует добавлять роли, в том числе здесь находятся роли с системными именами "reader", "editor" и т. д. (о ролях с системными именами см. в разделе <a href="#access_rights_granting">«Распределение прав доступа»</a>).</p>
</dd>
<dt class="hdlist1">celesta.userroles</dt>
<dd>
<p>связь идентификаторов пользователей (логинов) с ролями.
Заполняется администратором системы.</p>
</dd>
<dt class="hdlist1">celesta.permissions</dt>
<dd>
<p>разрешения ролям на таблицы.
Заполняется администратором.</p>
</dd>
<dt class="hdlist1">celesta.logsetup</dt>
<dd>
<p>настройки логирования.
Заполняется администратором.</p>
</dd>
<dt class="hdlist1">celesta.log</dt>
<dd>
<p>лог изменений.
Заполняется системой автоматически при каждом изменении данных, однако данные пишутся лишь по таблицам и действиям, указанным в <code>celesta.logsetup</code>.</p>
</dd>
<dt class="hdlist1">celesta.calllog</dt>
<dd>
<p>лог вызовов методов.
Заполняется в <a href="#profiling_mode">режиме профилирования</a>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="celesta_grains_table">2.5.2. Таблица celesta.grains</h4>
<div class="paragraph">
<p>Данная таблица является важнейшей из системных таблиц Celesta, т. к. её содержимое управляет синхронизацией структуры базы данных с метаданными в момент запуска системы.
Таблица содержит следующие поля:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 66.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Имя поля</th>
<th class="tableblock halign-center valign-middle">Тип поля</th>
<th class="tableblock halign-center valign-middle">Значение поля</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(30)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">имя (код) гранулы</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(2000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">version tag гранулы</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>length</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">длина CelestaSQL-скрипта гранулы в байтах</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>checksum</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(8)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CRC32 CelestaSQL-скрипта гранулы</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>state</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INT</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>статус гранулы:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0 – <strong>ready</strong> — гранула развёрнута и готова к использованию (при этом её version tag и контрольная сумма записаны в полях <code>version</code>, <code>length</code>, <code>checksum</code>).</p>
</li>
<li>
<p>1 – <strong>upgrading</strong> — гранула находится в процессе создания или апгрейда другим приложением Celesta, подключённым к базе данных.</p>
</li>
<li>
<p>2 – <strong>error</strong> — последняя попытка автообновления завершилась неудачно, в этом случае в поле <code>message</code> находится сообщение об ошибке</p>
</li>
<li>
<p>3 – <strong>recover</strong> (эквивалент — отсутствие записи в таблице <code>grains</code> при наличии гранулы в папке <code>score</code>) — гранула отсутствует или нуждается в регенерации (например, после ошибки апгрейда)</p>
</li>
<li>
<p>4 – <strong>lock</strong> — гранула не нуждается в автоматическом обновлении структуры ни при каких обстоятельствах</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lastmodified</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DATETIME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">дата и время последнего обновления статуса гранулы</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>message</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TEXT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">комментарий (например, сообщение об ошибке при последнем неудавшемся автообновлении)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="access_rights_granting">2.5.3. Система распределения прав доступа</h4>
<div class="paragraph">
<p>Как видно из структуры таблиц, права на таблицы раздаются ролям, прямой раздачи прав пользователям не предусмотрено.</p>
</div>
<div class="paragraph">
<p>В поле <code>roleid</code> указывается идентификатор роли, в полях <code>grainid</code> и <code>tablename</code> — ссылка на таблицу.
В битовых полях r, i, m, d выставляются флаги, если необходимы права, соответственно, на чтение, вставку, модификацию и удаление.</p>
</div>
<div class="paragraph">
<p>Предусмотрены также специальные, системные имена ролей: <strong>reader</strong> и <strong>editor</strong>, а также роли вида <strong>&lt;имя гранулы&gt;.reader</strong> и <strong>&lt;имя гранулы&gt;.editor</strong>.</p>
</div>
<div class="paragraph">
<p>Роль <strong>reader</strong> даёт право на чтение всех без исключения таблиц, роль <strong>&lt;имя гранулы&gt;.reader</strong> (например, "foo.reader") даёт право на чтение всех таблиц в соответствующей грануле.</p>
</div>
<div class="paragraph">
<p>Роль <strong>editor</strong> даёт полные права (на чтение, вставку, модификацию и удаление) всех таблиц.
Роль <strong>&lt;имя гранулы&gt;.editor</strong> (например, "foo.editor") даёт полные права на все таблиц в соответствующей грануле.</p>
</div>
</div>
<div class="sect3">
<h4 id="_система_логирования">2.5.4. Система логирования</h4>
<div class="paragraph">
<p>При любом изменении данных, производимых через курсоры Celesta, работает не только система распределения прав доступа, но также и система логирования изменений данных, записывая все изменения в таблицу <strong>celesta.log</strong>.
Однако, чтобы <strong>celesta.log</strong> не засорялась потенциально огромным количеством ненужных данных, логируются лишь изменения на таблицах, явно указанных в таблице <strong>celesta.logsetup</strong>.
Более того, имеется возможность отдельно включать логирование вставки, модификации и удаления записи.</p>
</div>
<div class="paragraph">
<p>Для того, чтобы включить логирование изменений данных таблиц, производимых через систему Celesta, необходимо занести соответствующие настройки в таблицу <strong>celesta.logsetup</strong>.
При этом в полях grainid и tablename указывается ссылка на таблицу, а в битовых полях i, m, d выставляются флаги, если необходимо логирование, соответственно, вставки, модификации и удаления.</p>
</div>
<div class="paragraph">
<p>Таблица <code>celesta.log</code> состоит из следующих полей:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 66.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Имя поля</th>
<th class="tableblock halign-center valign-middle">Тип поля</th>
<th class="tableblock halign-center valign-middle">Значение поля</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entryno</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">автоинкрементируемый целочисленный номер записи в таблице лога</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entry_time</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DATETIME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">время записи</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>userid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(250)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">идентификатор пользователя, от имени которого произведено изменение</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sessionid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(250)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">идентификатор пользовательской сессии, в рамках которой произведено изменение</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>grainid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(30)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">идентификатор гранулы</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tablename</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(30)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">имя таблицы</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>action_type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(1)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">тип действия (I для вставки, M для модификации, D для удаления)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pkvalue1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(100)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">значение первого поля первичного ключа (сведённое к текстовому типу)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pkvalue2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(100)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">значение второго поля первичного ключа (если есть, сведённое к текстовому типу)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pkvalue3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(100)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">значение третьего поля первичного ключа (если есть, сведённое к текстовому типу)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>oldvalues</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(2000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">прежнее состояние записи (поля сведены к тексту и перечислены через запятую в формате CSV, информация обрезана по длине поля).
Значение поля заполняется для действий M и D</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>newvalues</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(2000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">текущее состояние записи в том же формате, что и в поле <code>oldvalues</code>.
Заполняется для действий M и I</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="profiling_mode">2.5.5. Система профилирования</h4>
<div class="paragraph">
<p>Для поиска и устранения проблем, связанных с быстродействием, Celesta может работать в режиме профилирования, включаемом при помощи метода <code>setProfilemode(true)</code> экземпляра <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/Celesta.html"><code>Celesta</code></a>.</p>
</div>
<div class="paragraph">
<p>В режиме профилирования информация обо всех вызовах процедур записывается в таблицу calllog, состоящую из следующих полей:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 66.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Имя поля</th>
<th class="tableblock halign-center valign-middle">Тип поля</th>
<th class="tableblock halign-center valign-middle">Значение поля</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entryno</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">автоинкрементируемый целочисленный номер записи в таблице лога</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sessionid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(250)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">идентификатор пользовательской сессии, в которой была запущена процедура</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>userid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(250)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">идентификатор пользователя, от имени которого работала пользовательская сессия</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>procname</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(250)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">имя выполнявшейся процедуры</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>starttime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DATETIME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">время начала выполнения процедуры</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>duration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">общее время выполнения процедуры (в миллисекундах)</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_часть_3_проектирование_базы_данных_в_celesta">3. Часть 3. Проектирование базы данных в Celesta</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="CelestaSQL">3.1. CelestaSQL</h3>
<div class="sect3">
<h4 id="_язык_celestasql_определения_объектов_базы_данных">3.1.1. Язык CelestaSQL определения объектов базы данных</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Внимание"></i>
</td>
<td class="content">
Скрипты на языке CelestaSQL должны иметь кодировку UTF-8.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>На языке Celesta SQL пишутся скрипты определения гранул.
Скрипт на языке CelestaSQL состоит из конструкций</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#create_schema_statement">CREATE GRAIN</a>,</p>
</li>
<li>
<p><a href="#create_sequence_statement">CREATE SEQUENCE</a>,</p>
</li>
<li>
<p><a href="#create_table_statement">CREATE TABLE</a>,</p>
</li>
<li>
<p><a href="#foreign_keys_statements">ALTER TABLE &#8230;&#8203; ADD &#8230;&#8203; FOREIGN KEY</a>,</p>
</li>
<li>
<p><a href="#create_index_statement">CREATE INDEX</a>,</p>
</li>
<li>
<p><a href="#create_view_statement">CREATE VIEW</a>,</p>
</li>
<li>
<p><a href="#create_materialized_view_statement">CREATE MATERIALIZED VIEW</a>,</p>
</li>
<li>
<p><a href="#create_function_statement">CREATE FUNCTION</a>,</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>в обязательном порядке разделённых точкой с запятой, начиная с <code>CREATE GRAIN</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<object type="image/svg+xml" data="script.svg" width="488" height="264"><span class="alt">script</span></object>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_комментарии_в_языке_celestasql">3.1.2. Комментарии в языке CelestaSQL</h4>
<div class="paragraph">
<p>CelestaSQL поддерживает стандартные однострочные и многострочные комментарии, а также комментарии <a href="#CelestaDoc">CelestaDoc</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">-- однострочный комментарий
/*многострочный
    комментарий*/
 /**комментарий CelestaDoc*/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Обычные комментарии могут использоваться в любом месте текста, комментарии CelestaDoc — только непосредственно перед определением гранулы, таблицы, поля или индекса.</p>
</div>
</div>
<div class="sect3">
<h4 id="_идентификаторы_объектов_в_языке_celestasql">3.1.3. Идентификаторы объектов в языке CelestaSQL</h4>
<div class="paragraph">
<p>Идентификаторы объектов — это, иначе говоря, имена гранул, таблиц, полей, индексов, ограничений и представлений, их синтаксис в Celesta имеет ряд строгих ограничений.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>В обычных СУБД дозволяется, чтобы идентификаторы объектов содержали знаки пробела и неалфавитные знаки, если эти имена заключены в обрамляющие символы, например «[]» для MS SQL Server.
Т. е. в MS SQLServer допустимо, например, такое имя таблицы: [Long Table$Name]. Celesta, однако, не может поддерживать пробелы и неалфавитные знаки в идентификаторах потому, что имя каждой Celesta-таблицы должно являться именем Java-класса, а имя каждого Celesta-поля — именем Java-переменной.
Поэтому идентификатор любого именованного объекта CelestaSQL должен как минимум удовлетворять правилам наименования переменной в Java, т. е. <strong>может состоять только из больших и малых букв латинского алфавита, цифр и знаков подчёркивания, при этом не может начинаться с цифры</strong>.</p>
</li>
<li>
<p><strong>Заключение идентификаторов Celesta в кавычки</strong> в скриптах CelestaSQL <strong>не допускается</strong> на уровне синтаксиса, т. к. практической надобности в этом нет (имена никогда не содержат пробелов).
На системном уровне при формировании запросов к СУБД Celesta, однако, всегда заключает имена своих объектов в прямые кавычки ("ANSI quotes"), чтобы гарантировать, что базы данных Oracle, PostgreSQL и H2 не будут нарушать регистр букв, составляющих идентификатор.</p>
</li>
<li>
<p><strong>Идентификаторы</strong> в Celesta <strong>являются чувствительными к регистру</strong>, однако нельзя создавать две таблицы, имена которых отличаются только регистром.</p>
</li>
<li>
<p><strong>Длина</strong> любого идентификатора в Celesta <strong>не может быть больше 30 символов</strong>.</p>
</li>
<li>
<p><strong>Идентификаторы (префиксы) гранул, кроме того, не могут содержать в себе знаков подчёркивания</strong>.
Это связано с тем, что комбинация имени гранулы со знаком подчёркивания и другим идентификатором зачастую используется во внутрисистемных целях Celesta, и запрет на использование знака подчёркивания в именах гранул необходим для исключения возможных неоднозначностей.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Замечание"></i>
</td>
<td class="content">
Обычной практикой является написание идентификаторов в CelestaSQL в "snake_case"&#8201;&#8212;&#8201;в процессе трансформации в Java-классы они конвертируются в 'CamelCase'.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="create_schema_statement">3.1.4. Конструкция CREATE SCHEMA (GRAIN)</h4>
<div class="paragraph">
<p>С выражения <code>CREATE SCHEMA</code> должен начинаться любой скрипт определения гранулы.
Используется следующий синтаксис (слова <code>GRAIN</code> и <code>SCHEMA</code> являются синонимами):</p>
</div>
<div id="create_grain" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="create_schema.svg" width="534" height="241"><span class="alt">create schema</span></object>
</div>
</div>
<div class="paragraph">
<p>Опция <code>WITH NO AUTOUPDATE</code> исключает схему целиком из процесса автообновления базы данных.
Как и соответствующая <a href="#celestasql_with_options">опция таблицы</a>, может быть использована в ситуации, когда структура схемы находится под внешним управлением.</p>
</div>
<div class="paragraph">
<p>Указание версии обязательно для исключения непроизвольного автоматического даунгрейда базы данных при запуске старой версии гранулы на более свежей версии базы данных.</p>
</div>
<div id="version_tags" class="paragraph">
<p>Версия состоит из перечисленных через запятую компонент и может выглядеть таким образом: <code>1.23,TITAN3.34</code>.
Читать это нужно следующим образом: базовая версия 1.23, доработка для проекта TITAN – 3.34.
Регулярное выражение для проверки формата компонента: <code>([A-Z_]*)(<span class="0-9">\\.[0-9]</span>)</code>.
Требуется, чтобы каждая из составляющих версии имела двухкомпонентный (и только  двухкомпонентный!) формат, а префикс либо отсутствовал, либо состоял из заглавных латинских букв и знака подчёркивания.
Когда  система определяет возможность автоапгрейда, сравниваются все тэги версии последовательно.</p>
</div>
<div class="paragraph">
<p>В этом смысле, по отношению к тэгу «1.23,TITAN3.34»:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>«1.23,TITAN3.35» – более свежая версия (обновилась модификация), можно выполнять автоапгрейд</p>
</li>
<li>
<p>«1.24,TITAN3.34» – более свежая версия (обновилась базовая версия), можно выполнять автоапгрейд</p>
</li>
<li>
<p>«1.23,TITAN3.34,PLUTO1.00» – более свежая версия (добавилась ещё одна модификация), можно выполнять автоапгрейд</p>
</li>
<li>
<p>«TITAN3.34,1.23» – та же самая версия (порядок следования тэгов не играет роли), автоапгрейд выполняться будет лишь при несовпадении контрольных сумм, ошибки не произойдёт</p>
</li>
<li>
<p>«1.22,TITAN3.34» – более старая базовая версия, автоапгрейд выполняться не будет, произойдёт ошибка и Celesta остановится.</p>
</li>
<li>
<p>«1.22,TITAN3.36» – несогласующаяся версия, апдейт выполняться не будет, ошибка.
Версии «1.23,PLUTO1.00», «1.25» также будут несогласующимся с версией «1.23,TITAN3.34» и не станут накатываться автоматически.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Каждая из версий сравнивается, как число с плавающей запятой.</p>
</div>
</div>
<div class="sect3">
<h4 id="create_sequence_statement">3.1.5. Конструкция CREATE SEQUENCE</h4>
<div class="paragraph">
<p>Используется следующий синтаксис:</p>
</div>
<div id="create_sequence" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="create_sequence.svg" width="558" height="268"><span class="alt">create sequence</span></object>
</div>
</div>
<div class="paragraph">
<p>Основными ограничениями и отличиями этой конструкции от аналогичной конструкции в различных СУБД являются:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Если не указано значение <code>MINVALUE</code>, то оно автоматически выставляется равным значению <code>START WITH</code> (по умолчанию 1).</p>
</li>
<li>
<p>Если не указано значение <code>MAXVALUE</code>, то оно автоматически выставляется равным значению <code>Long.MAX_VALUE</code>.</p>
</li>
<li>
<p>Значение <code>START WITH</code> не обновляется для созданных ранее последовательностей, даже если было изменено в файле гранулы (связано с тем, что Oracle разрешает данную операцию только через удаление и пересоздание последовательности, а идеология Celesta не предусматривает удаление stateful объектов из БД).</p>
</li>
<li>
<p>Если в грануле присутствует таблица с именем, например, <code>A</code>, то является недопустимым создание последовательности с именем <code>A_seq</code>, так как это имя зарезервировано системой.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="create_table_statement">3.1.6. Конструкция CREATE TABLE</h4>
<div class="paragraph">
<p>Используется следующий синтаксис:</p>
</div>
<div id="create_table" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="create_table.svg" width="627" height="171"><span class="alt">create table</span></object>
</div>
</div>
<div id="table_constituent" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="table_constituent.svg" width="617" height="142"><span class="alt">table constituent</span></object>
</div>
</div>
<div class="paragraph">
<p>Иными словами, в конструкции <code>CREATE TABLE</code> в скобках через запятую в любом порядке могут быть перечислены определения полей, определения первичных ключей или определения внешних ключей, а за скобками, возможно, перечислены опции.
На практике определения всех полей идут подряд в самом начале, далее — определения составных первичных ключей (первичные ключи, состоящие из одного поля, можно определять на самом поле) и определения составных внешний ключей (опять же, внешние ключи, состоящие из одного поля, можно определять на самом поле).</p>
</div>
<div class="sect4">
<h5 id="_определения_полей">Определения полей</h5>
<div id="field_definition" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="field_definition.svg" width="664" height="365"><span class="alt">field definition</span></object>
</div>
</div>
<div class="paragraph">
<p><strong>field_definition</strong> (Определение поля) — конструкция, задающая тип поля, название поля, его свойства <code>NULL</code>/<code>NOT NULL</code> и <code>DEFAULT</code>, опционально может заканчиваться конструкцией <code>PRIMARY KEY</code> и/или <code>FOREIGN KEY</code>.</p>
</div>
<div class="paragraph">
<p>Сокращенное определение внешнего ключа (<strong>inline_fk_definition</strong>) имеет следующий синтаксис:</p>
</div>
<div id="inline_fk_definition" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="inline_fk_definition.svg" width="486" height="138"><span class="alt">inline fk definition</span></object>
</div>
</div>
<div class="paragraph">
<p>Здесь <strong>table_ref</strong> — ссылка на таблицу, которая может быть однокомпонентной (если таблица, на которую указывает внешний ключ, находится в текущей грануле) или двухкомпонентной, с явным указанием имени гранулы:</p>
</div>
<div id="table_ref" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="table_ref.svg" width="397" height="75"><span class="alt">table ref</span></object>
</div>
</div>
<div class="paragraph">
<p>Определение синтаксиса правил внешних ключей (<strong>fk_rules</strong>) см. в разделе <a href="#foreign_keys_statements">«Внешние ключи»</a>.</p>
</div>
</div>
<div class="sect4">
<h5 id="datatypes_mapping">Типы данных</h5>
<div class="paragraph">
<p>Используется следующая система типов данных.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle"></th>
<th class="tableblock halign-center valign-middle">Celesta</th>
<th class="tableblock halign-center valign-middle">Microsoft SQL Server</th>
<th class="tableblock halign-center valign-middle">Oracle</th>
<th class="tableblock halign-center valign-middle">PostgreSQL</th>
<th class="tableblock halign-center valign-middle">Firebird</th>
<th class="tableblock halign-center valign-middle">H2</th>
<th class="tableblock halign-center valign-middle">Java type for cursor</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer (32-bit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INT4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Floating point (64-bit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FLOAT(53)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FLOAT8
[= DOUBLE PRECISION]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DOUBLE PRECISION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DOUBLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ava.lang.Double</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fixed point (decimal)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DECIMAL(p,s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DECIMAL(p,s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NUMBER(p,s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NUMERIC(p,s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DECIMAL(p,s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DECIMAL(p,s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.math.BigDecimal</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">String (Unicode)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARCHAR(n)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVARCHAR(n)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVARCHAR(n)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARCHAR(n)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARCHAR(n)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARCHAR(n)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long string (Unicode)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVARCHAR(MAX)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NCLOB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BLOB SUB_TYPE TEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CLOB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BLOB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARBINARY(MAX)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BLOB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BYTEA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BLOB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARBINARY(MAX)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date/time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATETIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATETIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.util.Date</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date/time with time zone</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATETIME WITH TIME ZONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATETIMEOFFSET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP WITH TIME ZONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMPZ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP WITH TIME ZONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP WITH TIME ZONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.time.ZonedDateTime</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NUMBER
[check in (0, 1)]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BOOL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMALLINT
[check in (0, 1)]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BOOLEAN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>См. также раздел «<a href="#RDBMS_peculiarities">Особенности работы Celesta с поддерживаемыми типами СУБД</a>».</p>
</div>
<div class="paragraph">
<p>Для каждого типа поля имеется свой вариант определения:</p>
</div>
<div id="nullability" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="nullability.svg" width="283" height="78"><span class="alt">nullability</span></object>
</div>
</div>
<div id="int_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="int_field.svg" width="835" height="108"><span class="alt">int field</span></object>
</div>
</div>
<div class="paragraph">
<p>Вместо конструкции <code>DEFAULT &lt;целое число&gt;</code> для поля с типом <code>INT</code> может использоваться конструкция <code>NEXTVAL(&lt;sequence name&gt;)</code>.
Таким образом значение колонки будет инкрементироваться при вставке в зависимости от указанной последовательности.
Стоит отметить, что можно использовать только последовательности, объявленные в той же грануле, что и таблица, к которой принадлежит колонка.</p>
</div>
<div id="floating_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="floating_field.svg" width="576" height="74"><span class="alt">floating field</span></object>
</div>
</div>
<div id="decimal_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="decimal_field.svg" width="626" height="141"><span class="alt">decimal field</span></object>
</div>
</div>
<div id="text_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="text_field.svg" width="641" height="173"><span class="alt">text field</span></object>
</div>
</div>
<div id="blob_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="blob_field.svg" width="540" height="74"><span class="alt">blob field</span></object>
</div>
</div>
<div class="paragraph">
<p>Здесь <strong>&lt;binary literal&gt;</strong> — шестнадцатеричное представление последовательности байтов, начинающееся с 0x и не заключённые в кавычки, например: 0xFFAAFFAAFF.</p>
</div>
<div id="datetime_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="datetime_field.svg" width="711" height="109"><span class="alt">datetime field</span></object>
</div>
</div>
<div class="paragraph">
<p>В качестве значения <code>DEFAULT</code> для поля с типом <code>DATETIME</code> может использоваться функция <code>GETDATE()</code> (текущий момент времени).</p>
</div>
<div id="datetime_with_time_zone_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="datetime_with_time_zone_field.svg" width="535" height="70"><span class="alt">datetime with time zone field</span></object>
</div>
</div>
<div id="bit_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="bit_field.svg" width="534" height="106"><span class="alt">bit field</span></object>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_первичные_ключи">Первичные ключи</h5>
<div id="primary_key_definition" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="primary_key_definition.svg" width="482" height="104"><span class="alt">primary key definition</span></object>
</div>
</div>
<div class="paragraph">
<p><strong>primary_key_definition</strong> (определение первичного ключа) — конструкция, задающая состав полей, входящих в первичный ключ таблицы.
Возможно в двух вариантах:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>сокращённый вариант — когда ключевые слова “<code>PRIMARY KEY</code>” идут сразу после определения поля, это даёт возможность более короткой и наглядной записи в случае, когда первичный ключ состоит всего из одного поля,</p>
</li>
<li>
<p>полный вариант — когда конструкция <code>PRIMARY KEY</code> находится в определении таблицы среди определения полей, и может содержать как одно поле, так и любое количество полей.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ограничения:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Не допускается создание таблиц без <code>PRIMARY KEY</code> (за исключением <code>READ ONLY</code>-таблиц).
Это необходимо для работоспособности классов доступа к данным.</p>
</li>
<li>
<p>В таблице может быть не более одного упоминания <code>PRIMARY KEY</code>, будь то сокращённое выражение в конце определения поля или составное выражение в определении таблицы.</p>
</li>
<li>
<p>Не допускается создание PK по полям с типами <code>BLOB</code> и <code>TEXT</code>.</p>
</li>
<li>
<p>Не допускается создание PK по nullable-полям.</p>
</li>
<li>
<p>Не допускается более одного вхождения одного и того же поля в определение PRIMARY KEY.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="foreign_keys_statements">Внешние ключи</h5>
<div id="foreign_key_definition" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="foreign_key_definition.svg" width="734" height="205"><span class="alt">foreign key definition</span></object>
</div>
</div>
<div class="paragraph">
<p><strong>foreign_key_definition</strong> (Определение внешнего ключа) — конструкция, задающая связь между таблицами по одному или нескольким полям.
Как и в случае с конструкцией <code>PRIMARY KEY</code>, возможно использование в двух вариантах — сокращённом (встроенном в определение поля, связь по одному полю) и полном (перечисляется среди определений полей).
Кроме того, внешний ключ можно создать вне определения таблицы при помощи конструкции "alter table add constraint":</p>
</div>
<div id="add_foreign_key" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="add_foreign_key.svg" width="673" height="136"><span class="alt">add foreign key</span></object>
</div>
</div>
<div class="paragraph">
<p>Ограничения:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Foreign key, простой или составной, может ссылаться только на Primary Key, причём полностью. (В Celesta SQL не допускаются ограничения <code>UNIQUE</code>, поэтому из двух возможностей, стандартно предлагаемых в СУБД для Foreign Keys, остаётся только возможность ссылки на Primary Key).</p>
</li>
<li>
<p>Типы полей должны в точности совпадать (если поле – строковое, длина ссылающегося поля должна быть точно равна длине поля, на которое ссылаются).</p>
</li>
<li>
<p>Нельзя создать более одного определения Foreign Key на одном и том же наборе столбцов (частный случай – не может быть двух FK, определённых для одного и того же столбца).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>fk_rules</strong> — ссылочные действия:</p>
</div>
<div id="fk_rules" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="fk_rules.svg" width="609" height="272"><span class="alt">fk rules</span></object>
</div>
</div>
<div class="paragraph">
<p>Поддерживаемые ссылочные действия:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NO ACTION</code> – запрет удаления/модификации родительской записи, если на неё есть ссылки.</p>
</li>
<li>
<p><code>SET NULL</code> – выставление <code>NULL</code> в ссылках.
Естественно, использовать это действие запрещено для <code>NOT NULL</code>-able полей.</p>
</li>
<li>
<p><code>CASCADE</code> – каскадное удаление/обновление полей.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>В момент создания foreign key сослаться можно только</p>
</div>
<div class="ulist">
<ul>
<li>
<p>на таблицу, определённую в текущей грануле выше по тексту,</p>
</li>
<li>
<p>на таблицу, определённую с другой грануле.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Внимание"></i>
</td>
<td class="content">
«Зацикленные» ссылки по foreign key (например, вида A&#8594;B&#8594;C&#8594;A) при разработке структуры базы данных в действительности нужны крайне редко и обычно говорят об ошибке проектировщика.
Единственный широко применимый практически значимый пример «зацикливания» — ссылка таблицы на саму себя при организации иерархического перечня по принципу parent-child.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>В Celesta не допускается создание «зацикленных» ссылок между таблицами, принадлежащими разным гранулам.
Если надо организовать ссылки по кругу между несколькими таблицами внутри гранулы, то это можно сделать, воспользовавшись конструкцией "alter table add constraint foreign key".</p>
</div>
<div class="paragraph">
<p>В частности, работает следующий пример:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE aa(idaa INT NOT NULL PRIMARY KEY, idc INT , textvalue nvarchar(10));</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE a (ida INT NOT NULL PRIMARY KEY, descr nvarchar(2), parent INT
                FOREIGN KEY REFERENCES a(ida), --ссылка таблицы на саму себя
                fff INT FOREIGN KEY REFERENCES aa(idaa) --первая часть круговой ссылки</code></pre>
</div>
</div>
<div class="paragraph">
<p>внешний ключ, создаваемый вне таблицы:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">ALTER TABLE aa ADD CONSTRAINT fk1
  FOREIGN KEY (idc) REFERENCES a(ida); --вторая часть круговой ссылки</code></pre>
</div>
</div>
<div class="paragraph">
<p>Пример создания составного ключа, состоящего из двух полей:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE empfiles(
  id INT NOT NULL PRIMARY KEY,
  user_id varchar(200) NOT NULL,
  orgtype_id varchar(255) NOT NULL,
  question_id varchar(30) NOT NULL,
  FOREIGN KEY (orgtype_id, question_id) REFERENCES schema.table(field, field)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="celestasql_with_options">Опции</h5>
<div class="paragraph">
<p>Celesta позволяет указывать следующие опции после определения таблицы:</p>
</div>
<div id="table_options" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="table_options.svg" width="510" height="177"><span class="alt">table options</span></object>
</div>
</div>
<div class="paragraph">
<p>Таким образом, поддерживаются следующие возможности:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>WITH VERSION CHECK</code> — режим по умолчанию: включение механизма отслеживания версий записей для исключения потерянных обновлений (см. раздел <a href="#Lost_updates_protection">«Защита от потерянных обновлений»</a>).
Указывать данную опцию явно не требуется.</p>
</li>
<li>
<p><code>WITH NO VERSION CHECK</code> — отключение механизма отслеживания версий записей.
Требуется в случаях, когда нет необходимости в защите от потерянных обновлений&#8201;&#8212;&#8201;например, в таблицах, используемых только для добавления записей.
Возможность модифицировать данные в таблице при этой опции сохраняется, но возможны «потерянные обновления».</p>
</li>
<li>
<p><code>WITH READ ONLY</code> — режим «только чтение».
Требуется в случаях, когда данные таблицы поступают из внешних источников, а не заносятся средствами Celesta, либо если необходимо подключиться к таблице, относящейся к иному приложению, и потому нежелательно вносить в её данные какие-либо изменения.
В этом режиме механизм отслеживания версий записей отключается, а класс для доступа к таблице генерируется без методов модификации данных.
Кроме того, для таких таблиц не требуется указывать первичный ключ.</p>
</li>
<li>
<p>Опция <code>NO AUTOUPDATE</code>, которая может применяться совместно с данными опциями, отключает таблицу от процесса автообновления базы данных.
Используется в случае, когда структура какой-либо таблицы изменяется в базе данных иными средствами и система не должна пытаться синхронизировать структуру этой таблицы с описанием на языке CelestaSQL автоматически.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="create_index_statement">3.1.7. Конструкция CREATE INDEX</h4>
<div class="paragraph">
<p>Индексы применяются для ускорения фильтрации по полям таблиц и создаются при помощи следующей синтаксической конструкции:</p>
</div>
<div id="create_index" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="create_index.svg" width="581" height="171"><span class="alt">create index</span></object>
</div>
</div>
<div class="paragraph">
<p>Имена индексов должны быть уникальны в пределах гранулы.
Все индексы в Celesta допускают повторяющиеся значения.</p>
</div>
</div>
<div class="sect3">
<h4 id="create_view_statement">3.1.8. Конструкция CREATE VIEW</h4>
<div class="paragraph">
<p>Представления (views) служат для доступа только на чтение к данным, собранным из одной или нескольких таблиц при помощи SQL-запроса <code>SELECT</code>.
Для каждого своего представления Celesta создаёт объект-представление в базе данных, транслируя при этом SQL-запрос на языке CelestaSQL в соответствующий диалект языка SQL.</p>
</div>
<div class="paragraph">
<p>Представления создаются при помощи синтаксической конструкции</p>
</div>
<div id="create_view" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="create_view.svg" width="507" height="70"><span class="alt">create view</span></object>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>&lt;view name&gt;</strong> (имя представления) должно быть уникальным в пределах гранулы и не совпадать с именем таблицы.</p>
</li>
<li>
<p><strong>query</strong> (запрос) представляет собой SQL-запрос, имеющий следующий синтаксис:</p>
</li>
</ul>
</div>
<div id="query" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="query.svg" width="199" height="104"><span class="alt">query</span></object>
</div>
</div>
<div class="paragraph">
<p><code>SELECT</code>-запросы в CelestaSQL могут быть объединены в цепочку при помощи <code>UNION ALL</code>.
Как обычно, требуется, чтобы каждый из запросов в цепочке возвращал одинаковое количество столбцов, и столбцы были совпадающих типов.</p>
</div>
<div class="paragraph">
<p>В качестве названий столбцов, возвращаемых выражением <code>UNION ALL</code>, принимаются названия столбцов первого <code>SELECT</code>-запроса.
Nullability возвращаемых столбцов вычисляется по правилу: выражение столбца может возвращать <code>null</code>, если хотя бы в одном из запросов в цепочке <code>UNION ALL</code> соответствующий столбец может возвращать <code>null</code>.</p>
</div>
<div id="select_qry" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="select_qry.svg" width="700" height="224"><span class="alt">select qry</span></object>
</div>
</div>
<div id="from_clause" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="from_clause.svg" width="880" height="278"><span class="alt">from clause</span></object>
</div>
</div>
<div class="paragraph">
<p>Основными ограничениями и отличиями такого запроса от SQL-запросов в различных СУБД являются:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Запросы строятся только на таблицах и материализованных представлениях (текущей гранулы или соседних гранул).
Во избежание выстраивания неэффективных конструкций невозможно построение запросов на обычных представлениях.</p>
</li>
</ol>
</div>
<div id="no_select_all_fields" class="olist arabic">
<ol class="arabic">
<li>
<p>Конструкция <code>SELECT *</code> не поддерживается, и всякое поле запроса, если только это не ссылка на поле таблицы с уникальным в рамках запроса именем, должно иметь определённый и уникальный псевдоним.
Это нужно для возможности однозначного создания класса-курсора, поля которого соответствуют именам столбцов запроса.</p>
</li>
<li>
<p>Не поддерживается конструкция <code>ORDER BY</code>, т. к. при необходимости определённым образом отсортировать результирующий набор следует воспользоваться методом orderBy(&#8230;&#8203;) соответствующего курсора.</p>
</li>
<li>
<p>Не поддерживается конструкция <code>GROUP BY</code>&#8230;&#8203;<code>HAVING</code>.</p>
</li>
<li>
<p>Не поддерживаются <code>FULL JOIN</code> (объединения <code>LEFT</code> и <code>RIGHT</code> joins) и <code>CROSS JOIN</code> (декартовы произведения таблиц).</p>
</li>
<li>
<p>Не поддерживается конструкция <code>WITH</code> и вложенные запросы.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Большая часть из функциональности, не поддерживаемой на уровне CelestaSQL, эффективно эмулируется в API классов доступа к данным.</p>
</div>
<div class="paragraph">
<p>Ссылка на таблицу (<strong>table_ref</strong>) имеет синтаксис</p>
</div>
<div class="imageblock">
<div class="content">
<object type="image/svg+xml" data="table_ref.svg" width="397" height="75"><span class="alt">table ref</span></object>
</div>
</div>
<div class="paragraph">
<p>Имя гранулы указывать не обязательно, если таблица находится в той же грануле, что и текущее представление.</p>
</div>
<div class="paragraph">
<p>Терм, определяющий поле представления, имеет следующий синтаксис:</p>
</div>
<div id="term" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="term.svg" width="461" height="339"><span class="alt">term</span></object>
</div>
</div>
<div class="paragraph">
<p>Над выражениям типа <code>INT</code> и <code>REAL</code> допустимы обычные арифметические операции с обычным приоритетом: максимальный приоритет у унарного минуса, далее — умножение и деление («*», «/»), далее — сложение и вычитание («+», «-»).
Над выражениями типа <code>VARCHAR</code> допустима операция конкатенации «||», а также функции <code>UPPER</code> и <code>LOWER</code>, сводящие текст к верхнему и нижнему регистру, соответственно.
Операции над выражениями прочих типов недопустимы.</p>
</div>
<div id="primary_term" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="primary_term.svg" width="495" height="332"><span class="alt">primary term</span></object>
</div>
</div>
<div class="paragraph">
<p>Ссылки на поля могут быть однокомпонентными (если они однозначно указывают на поле определённой таблицы) либо двухкомпонентными, в этом случае в качестве первой компоненты следует указывать псевдоним таблицы из конструкции <code>FROM</code> либо — если явный псевдоним отсутствует — имя таблицы.</p>
</div>
<div class="paragraph">
<p>Специальный вид идентификатора <strong>&lt;$param id&gt;</strong>&#8201;&#8212;&#8201;знак $, за которым следует идентификатор&#8201;&#8212;&#8201;служит для ссылок на параметры <a href="#create_function_statement">функций</a>.</p>
</div>
<div class="paragraph">
<p>Наконец, синтаксис логического выражения <strong>condition</strong>, используемого в конструкциях <code>JOIN</code> &#8230;&#8203; <code>ON</code> и <code>WHERE</code>:</p>
</div>
<div id="condition" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="condition.svg" width="445" height="168"><span class="alt">condition</span></object>
</div>
</div>
<div id="predicate" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="predicate.svg" width="516" height="404"><span class="alt">predicate</span></object>
</div>
</div>
<div id="aggregate" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="aggregate.svg" width="608" height="168"><span class="alt">aggregate</span></object>
</div>
</div>
<div class="paragraph">
<p>Следует отметить, что <strong>term</strong> внутри конструкции <code>SUM</code> должен являться числом.</p>
</div>
<div id="group_by" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="group_by.svg" width="400" height="136"><span class="alt">group by</span></object>
</div>
</div>
<div class="paragraph">
<p>Особенность конструкции <code>GROUP BY</code> в CelestaSQL заключается в необходимости всегда перечислять в ней все неагрегатные колонки из выборки.</p>
</div>
</div>
<div class="sect3">
<h4 id="create_materialized_view_statement">3.1.9. Конструкция CREATE MATERIALIZED VIEW</h4>
<div class="paragraph">
<p>Материализованные представления (materialized views) служат для доступа только на чтение к агрегатным данным, собранным из одной таблицы и объединенным при помощи выражения <code>GROUP BY</code>.
Для каждого своего материализованного представления Celesta создаёт таблицу в базе данных, модифицируемую триггерами базы данных при изменении родительской таблицы.</p>
</div>
<div class="paragraph">
<p>Материализованные представления создаются при помощи синтаксической конструкции</p>
</div>
<div id="create_materialized_view" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="create_materialized_view.svg" width="618" height="272"><span class="alt">create materialized view</span></object>
</div>
</div>
<div class="paragraph">
<p>Основными ограничениями и отличиями такого запроса от SQL-запросов в различных СУБД являются:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Запросы строятся только на таблице текущей гранулы.</p>
</li>
<li>
<p>Конструкция <code>SELECT *</code> <a href="#no_select_all_fields">не поддерживается</a>.</p>
</li>
<li>
<p>В выборке обязательно должен участвовать хотя бы один агрегатный и хотя бы один неагрегатный столбец.</p>
</li>
<li>
<p>Неагрегатные колонки должны ссылаться на <code>NOT NULL</code> колонки родительской таблицы.</p>
</li>
<li>
<p>Если в <code>GROUP BY</code> выражении участвует колонка типа <code>DATETIME</code>, то ее значения будут округляться в точности до дня (часы, минуты и более точные измерения отсекаются).</p>
</li>
<li>
<p>Из агрегирующих операций доступны только <code>SUM</code> и <code>COUNT</code>.</p>
</li>
</ol>
</div>
<div id="materialized_aggregate" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="materialized_aggregate.svg" width="543" height="105"><span class="alt">materialized aggregate</span></object>
</div>
</div>
</div>
<div class="sect3">
<h4 id="create_function_statement">3.1.10. Конструкция CREATE FUNCTION</h4>
<div class="paragraph">
<p>Данная конструкция определяет функции — они же параметризованные представления.
Они служат для доступа только на чтение к данным, собранным из одной или нескольких таблиц при помощи SQL-запроса <code>SELECT</code> с учетом переданных параметров.</p>
</div>
<div class="paragraph">
<p>Функции создаются при помощи синтаксической конструкции</p>
</div>
<div id="create_function" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="create_function.svg" width="570" height="171"><span class="alt">create function</span></object>
</div>
</div>
<div class="paragraph">
<p>Параметры декларируются через запятую, с заданием имени и типа параметра:</p>
</div>
<div id="param_definition" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="param_definition.svg" width="363" height="230"><span class="alt">param definition</span></object>
</div>
</div>
<div class="paragraph">
<p>Чтобы сослаться на параметр в выражении функции, необходимо перед именем параметра ставить знак <code>$</code> (например, <code>param1</code> будет фигурировать в выражении запроса как <code>$param1</code>).</p>
</div>
<div class="paragraph">
<p>Основными ограничениями и отличиями такого запроса от SQL-запросов в различных СУБД являются:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Конструкция <code>SELECT *</code> <a href="#no_select_all_fields">не поддерживается</a>.</p>
</li>
<li>
<p>В объявлении обязательно должен иметься хотя бы один параметр.</p>
</li>
<li>
<p>Все объявленные параметры обязательно должны использоваться.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>В остальном синтаксическое выражение аналогично обычному View.</p>
</div>
<div class="paragraph">
<p>Пример функции:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE FUNCTION pView2(param int, param2 varchar) AS
  select f1, f2, f3 from t1
  where f2 = $param AND f3 = $param2;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="CelestaDoc">3.2. CelestaDoc</h3>
<div class="paragraph">
<p>Аналогично тому, как в языке Java можно документировать объекты кода при помощи JavaDoc, или в языке Python использовать документирующую константу, доступную затем во время выполнения, объекты базы данных, определённые в CelestaSQL, могут быть задокументированы при помощи комментариев в специальном формате: /** &#8230;&#8203; */ (две звёздочки после первого слэша, в отличие от одной звёздочки в простом комментарии).
Эти комментарии называются CelestaDoc-комментариями (по аналогии с JavaDoc), и могут находиться в коде CelestaSQL-скрипта непосредственно перед определениями соответствующих объектов, как в примере:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">/**описание гранулы*/
CREATE SCHEMA test1 VERSION '1.0';

/**описание последовательности*/
CREATE SEQUENCE test_entryno;

/**описание таблицы*/
CREATE TABLE table2(
    /**описание первой колонки*/
    column1 INT NOT NULL DEFAULT NEXTVAL(test_entryno) PRIMARY KEY,
    /**описание второй колонки*/
    column2 INT
);

/**описание индекса idx1*/
CREATE INDEX idx1 ON  table2 (column2);

/**описание представления v1*/
CREATE VIEW v1 AS
  SELECT DISTINCT column2 FROM table2;</code></pre>
</div>
</div>
<div class="paragraph">
<p>В отличие от простых комментариев, которые можно использовать в любом месте CelestaSQL-скрипта, CelestaDoc-комментарии допустимо использовать только перед определением соответствующего объекта, в противном случае возникает ошибка синтаксиса.</p>
</div>
<div class="paragraph">
<p>Синтаксический анализатор прочитывает CelestaDoc, и эта информация доступна в объектах метаданных в процессе выполнения при помощи метода <strong>getCelestaDoc()</strong> (см. раздел <a href="#Celesta_metadata">Метаданные Celesta</a>).</p>
</div>
<div class="paragraph">
<p>Цель комментариев CelestaDoc — снабжение объектов Celesta документацией и дополнительной метаинформацией во время выполнения — например, human readable названиями полей, информацией о том, как представлять поля в пользовательском интерфейсе и т. п.</p>
</div>
<div class="paragraph">
<p>Общепринятой практикой является запись в комментарии CelestaDoc мета-информации в формате JSON-объекта.
При этом CelestaDoc может содержать как обычный текст, так и JSON-объект.
С помощью утилитного метода <code>getCelestaDocJSON</code> класса <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/CelestaDocUtils.html"><code>CelestaDocUtils</code></a> можно извлечь первый валидный JSON-объект из CelestaDoc-строки.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_часть_4_создание_и_тестирование_методов_обращающихся_к_данным">4. Часть 4. Создание и тестирование методов, обращающихся к данным</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="celesta_instantiation">4.1. Создание экземпляра класса <code>Celesta</code></h3>
<div class="sect3">
<h4 id="_методы_celesta_createinstance">4.1.1. Методы <code>Celesta.createInstance</code></h4>
<div class="paragraph">
<p>Чтобы начать работать с Celesta, должен быть создан экземпляр класса <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/Celesta.html"><code>Celesta</code></a>.
Обычно создаётся всего один объект с типом <code>Celesta</code> на всё приложение, поэтому он должен быть сохранён в синглетоне либо управляться фреймворком Spring.</p>
</div>
<div class="paragraph">
<p>Если вы используете <a href="#quick_start_demo"><code>spring-boot-starter-celesta</code></a>, экземпляр <code>Celesta</code> создаётся автоматически и доступен как Spring bean.</p>
</div>
<div class="paragraph">
<p>Если вы создаёте экземпляр Celesta самостоятельно, вы должны создать  <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Properties.html"><code>Properties</code></a>, содержащие <a href="#basic_settings_section">настройки Celesta</a>  и затем использовать один из следующих статических методов класса <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/Celesta.html"><code>Celesta</code></a>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>Celesta createInstance(Properties properties)</code></dt>
<dd>
<p>Создаёт Celesta с использованием предоставленных параметров и и собственным пулом соединений.</p>
</dd>
<dt class="hdlist1"><code>Celesta createInstance(Properties properties, DataSource dataSource)</code></dt>
<dd>
<p>Создаёт Celesta с использованием предоставленных параметров и  <a href="https://docs.oracle.com/javase/8/docs/api/javax/sql/DataSource.html"><code>DataSource</code></a>. Вы можете использовать данный метод если хотите предоставить внешний пул соединений для Celesta.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Важно"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>Внешний пул соединений должен быть сконфигурирован так, чтобы возвращать соединения с <code>autoCommit</code> установленным в <code>false</code>.</p>
</li>
<li>
<p>Вам всё ещё необходимо прописать параметр  <code>rdbms.connection.url</code>, чтобы Celesta определила тип базы данных, с которой она работает. Но т. к. этот параметр не будет использоваться для того, чтобы подключаться к базе данных, достаточно указать только префикс, например <code>jdbc:postgresql</code>, <code>jdbc:sqlserver</code> и т. д.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_контекст_вызова">4.2. Контекст вызова</h3>
<div class="sect3">
<h4 id="_создание_и_жизненный_цикл_контекста_вызова">4.2.1. Создание и жизненный цикл контекста вызова</h4>
<div class="paragraph">
<p>Для того, чтобы можно было реализовать требования распределения прав доступа и логирования действий, любая операция над данными в Celesta производится от имени некоторого пользователя, «анонимных» операций быть не может.
Поэтому любой Celesta-код выполняется в некотором контексте вызова, определяемом экземпляром класса (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/CallContext.html"><code>CallContext</code></a>).</p>
</div>
<div class="paragraph">
<p>Контекст вызова содержит в себе имя пользователя, а привязка имени пользователя к роли определяет разрешения на доступ к таблицам, а также обеспечивает возможность логирования изменений, производимых от его имени.</p>
</div>
<div class="paragraph">
<p>Создание контекста вызова производится на уровне контроллера, где предполагается известным
(по переданному в запрос токену, цифровой подписи или каким-либо ещё способом) имя пользователя, выполняющего операции.</p>
</div>
<div class="paragraph">
<p>Контекст создаётся с помощью конструктора</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">CallContext(String userId)</code></pre>
</div>
</div>
<div class="paragraph">
<p>При отсутствии необходимости как-либо учитывать имя пользователя, а также использовать распределение прав доступа
к таблицам, можно воспользоваться субклассом <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/SystemCallContext.html"><code>SystemCallContext</code></a>,
конструктор которого не принимает параметров.
В этом случае создаётся контекст «системного пользователя», имеющего полные
права доступа ко всем таблицам.</p>
</div>
<div class="paragraph">
<p>Любой созданный таким образом контекст далее проходит следующий жизненный цикл:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Активация</strong>.
Вызов метода <code>activate(..)</code>, в который передаётся ссылка на объект <code>Celesta</code> и имя выполняемой процедуры.
В этот момент
 открывается неявная транзакция в базе данных и начинается отсчёт времени выполнения вызова.</p>
</li>
<li>
<p><strong>Вызов сервисного метода</strong>.
Контекст передаётся в качестве параметра в сервисный метод и используется для создания курсоров.</p>
</li>
<li>
<p><strong>Закрытие</strong>.
Вызов метода <code>close()</code>, фиксирующего транзакцию и закрывающего все незакрытые курсоры с высвобождением всех ресурсов JDBC.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Разработчику обычно <strong>не требуется</strong> выполнять активацию и закрытие контекста самостоятельно, т. к. они выполняются автоматически фреймворком Celesta.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>При использовании <a href="https://github.com/CourseOrchestra/spring-boot-starter-celesta">Celesta Spring Boot starter</a> активация и
 закрытие курсора выполняются при вызове методов сервисов, помеченных аннотацией
<code>@CelestaTransaction</code>.
Таким образом на этапе разработки достаточно передавать в них неактивированный контекст.
Прокси-объект,
создаваемый фреймворком Spring вокруг экземпляра сервисного класса, будет выполнять активацию, закрытие контекста и
откат транзакции базы данных в случае необработанного исключения.</p>
</li>
<li>
<p>При использовании <a href="#celestaunit_section">CelestaUnit</a> в параметры тестов, имеющих тип <code>CallContext</code>, будет передан
уже активированный системный контекст на базе Celesta, запущенной с базой данных H2 в in-memory режиме.
Закрытие контекста,
а также фиксация/откат изменений также обеспечиваются в CelestaUnit прозрачно для разработчика.</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_использование_контекста_вызова">4.2.2. Использование контекста вызова</h4>
<div class="paragraph">
<p>Каждый из методов сервисного слоя, использующих Celesta, принимает в качестве аргумента объект <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/CallContext.html"><code>ru.curs.celesta.CallContext</code></a>.
Этот объект предназначен, в первую очередь, чтобы быть аргументом конструкторов курсоров.
Однако и сам по себе контекст вызова имеет публично доступные методы и свойства, которые могут быть использованы внутри сервисного метода:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">commit()</dt>
<dd>
<p>фиксирует текущую транзакцию.
Вызывать данный метод требуется только в редких случаях, когда транзакцию обработки данных необходимо разбить на несколько частей.
Обычно в вызове этого метода необходимости нет, т. к. транзакция фиксируется автоматически по завершении процедуры.</p>
</dd>
<dt class="hdlist1">rollback()</dt>
<dd>
<p>откатывает текущую транзакцию.</p>
</dd>
<dt class="hdlist1">getCelesta()</dt>
<dd>
<p>вызывает текущий экземпляр объекта Celesta.
Необходимо, например, для получения информации о метаданных.</p>
</dd>
<dt class="hdlist1">getUserId()</dt>
<dd>
<p>возвращает имя пользователя, от лица которого производятся действия.</p>
</dd>
<dt class="hdlist1">getStartTime()</dt>
<dd>
<p>возвращает время создания контекста вызова (время начала работы Celesta-процедуры, полученное с помощью <code>System.currentTimeMillis()</code>).</p>
</dd>
<dt class="hdlist1">getDurationNs()</dt>
<dd>
<p>возвращает время жизни контекста вызова в наносекундах, измеренное как разница между значениями, возвращаемыми вызовами <code>System.nanoTime()</code>.</p>
</dd>
<dt class="hdlist1">getProcName()</dt>
<dd>
<p>возвращает имя процедуры, которая была изначально вызвана из контроллера (используется для нужд отладки).</p>
</dd>
<dt class="hdlist1">getDBPid()</dt>
<dd>
<p>возвращает PID (process identifier) текущего соединения с базой данных (используется для нужд отладки).</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="data_accessors_section">4.3. Работа с данными через классы доступа к данным (курсоры)</h3>
<div class="sect3">
<h4 id="_классы_доступа_и_их_стандартные_методы">4.3.1. Классы доступа и их стандартные методы</h4>
<div class="paragraph">
<p>Для каждой из таблиц и представлений, объявленных в CelestaSQL, генерируются классы доступа к данным.</p>
</div>
<div class="paragraph">
<p>Каждый экземпляр класса доступа к данным (его мы также будем именовать «курсор») в каждый момент времени хранит информацию об одной записи (строке) в базе данных, каждому полю записи в курсоре соответствует поле объекта.
Курсор можно передвигать по записям с учётом фильтров и сортировок.
Если курсор создан для таблицы, его также можно использовать для вставки, модификации и удаления данных.
В курсоре, созданном для представления, доступны только методы навигации по записям.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="cursors.png" alt="cursors" width="925" height="277">
</div>
</div>
<div class="paragraph">
<p>На UML-диаграмме показана иерархия классов доступа к данным.
В основе иерархии стоит класс <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BasicDataAccessor.html"><code>BasicDataAccessor</code></a>.
Каждый класс курсоров наследуется от класса <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BasicCursor.html"><code>BasicCursor</code></a>, класс <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/Sequence.html"><code>Sequence</code></a> от <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BasicDataAccessor.html"><code>BasicDataAccessor</code></a>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/Cursor.html">Cursor</a></dt>
<dd>
<p>предназначен для работы с таблицами.
Наследует все методы <code>BasicCursor</code>, а также добавляет ряд собственных методов для возможности модификации данных.</p>
</dd>
<dt class="hdlist1"><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/ViewCursor.html">ViewCursor</a></dt>
<dd>
<p>предназначен для работы с представлениями, никаких собственных методов к <code>BasicCursor</code> не добавляет.</p>
</dd>
<dt class="hdlist1"><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/MaterializedViewCursor.html">MaterializedViewCursor</a></dt>
<dd>
<p>предназначен для работы с материализованными представлениями.
Наследует все методы <code>BasicCursor</code>, а также добавляет ряд собственных методов для возможности получения данных по первичному ключу.</p>
</dd>
<dt class="hdlist1"><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/ParameterizedViewCursor.html">ParameterizedViewCursor</a></dt>
<dd>
<p>предназначен для работы с функциями(параметризованными представлениями).
Никаких собственных методов к <code>BasicCursor</code> не добавляет, однако имеет отличный от базового класса конструктор.</p>
</dd>
<dt class="hdlist1"><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/ReadOnlyTableCursor.html">ReadOnlyTableCursor</a></dt>
<dd>
<p>предназначен для работы с таблицами, объявленными с опцией WITH READ ONLY, никаких собственных методов к <code>BasicCursor</code> не добавляет.</p>
</dd>
<dt class="hdlist1"><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/Sequence.html">Sequence</a></dt>
<dd>
<p>предназначен для работы с последовательностями.
Наследует все методы класса <code>BasicDataAccessor</code> и добавляет метод <code>nextValue</code>.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Ниже описываются методы класса <code>Cursor</code>, но те методы, которые унаследованы от <code>BasicCursor</code> (и могут применяться при работе с представлениями и неизменяемыми таблицами) отмечены значком <span class="icon"><i class="fa fa-search"></i></span>.</p>
</div>
<div class="sect4">
<h5 id="_метаданные_о_полях_курсора">Метаданные о полях курсора</h5>
<div class="paragraph">
<p>Для вызова ряда методов работы с данными курсора, а также для удобства получения информации о том, какие поля присутствуют в каждом из курсоров, на каждый из классов -курсоров также кодогенерируется класс-компаньон <code>Columns</code>.
Класс-компаньон является статическим вложенным классов курсора.
Например, для класса <code>FooCursor</code> компаньоном является <code>FooCursor.Columns</code>.</p>
</div>
<div class="paragraph">
<p>Каждому полю курсора соответствует метод в классе <code>Columns</code>, возвращающий <a href="#Celesta_metadata">метаданные</a> соответствующей колонки, как показано на диаграмме:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="cursormeta.png" alt="cursormeta" width="240" height="266">
</div>
</div>
<div class="paragraph">
<p>В каждом экземпляре курсора соответствующий экземпляр класса <code>Columns</code> доступен через <code>public final</code> поле <code>COLUMNS</code>.
Кроме того, класс <code>Columns</code> каждого из курсоров может быть проинстанцирован независимо от курсора&#8201;&#8212;&#8201;его конструктор принимает параметр <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/ICelesta.html"><code>ICelesta</code></a>.</p>
</div>
<div class="paragraph">
<p>Использование методов класса <code>Columns</code>, получаемого кодогенерацией, для получения ссылок на поля таблиц, гарантирует целостность кода при изменении схемы данных (например, при удалении или переименовании полей в базе данных).</p>
</div>
</div>
<div class="sect4">
<h5 id="_конструктор_курсора">Конструктор курсора</h5>
<div class="paragraph">
<p>Конструктор каждого курсора принимает в себя параметр <code>CallContext context</code>, который, в свою очередь, выдаётся каждому методу сервисного слоя при начале работы.
Использование context-а позволяет работать с разными таблицами системы в одной транзакции и затем единым образом коммитить все изменения, кроме того, переменная context содержит информацию о текущем пользователе, используемую системами логирования и разграничения прав доступа.</p>
</div>
<div class="paragraph">
<p>Так, для курсоров типов <code>Cursor</code>, <code>ViewCursor</code>, <code>MaterializedViewCursor</code>, <code>ReadOnlyTableCursor</code> конструктор может вызываться следующим образом.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ACursor a = new ACursor(context);</code></pre>
</div>
</div>
<div id="too_many_accessors_warning" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Внимание"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Максимальное количество курсоров, которое можно создать с помощью одного экземпляра <code>CallContext</code>, равно 1023.
При превышении этого значения возникает ошибка "Too many data accessors".</p>
</div>
<div class="paragraph">
<p>Это не ограничивает разумные сценарии работы с данными в базе данных, но предотвращает утечку JDBC-ресурсов, если, например, курсоры создаются в цикле.
При создании курсора внутри цикла, его необходимо явным образом закрывать.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="limit_columns">Ограничение столбцов в выборке</h6>
<div class="paragraph">
<p>Очень часто в таблице определено много полей, но для нужд работы требуется лишь малая часть из них.
Чтобы не передавать лишнюю информацию между базой и сервером приложений и увеличить быстродействие, курсоры можно создавать таким образом, чтобы получать из БД значения только нужных столбцов.
Для этого в опциональные varargs-параметры конструктора курсора требуется передать перечень полей, которые требуется извлекать.
Поля, не указанные в этом перечне, будут при навигации курсора по записям в базе данных принимать значение <code>null</code>.</p>
</div>
<div class="paragraph">
<p>Допустим, что в БД имеется заполненная данными таблица table1:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">create table table1 (
  id int not null primary key,
  numb int not null,
  numb2 int,
  varr varchar(2) not null
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Допустим, что в создаваемом разработчиком решении, нет необходимости в выборке данных из столбца varr.
В этом случае при создании курсора можно указать список столбцов, которые необходимы.
Создание такого курсора будет выглядеть так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//инстанцируем объект-компаньон с информацией о столбцах
Table1Cursor.Columns columns = new Table1Cursor.Columns(context.getCelesta());
//передаём в дополнительных аргументах конструктора перечень желаемых столбцов
Table1Cursor tableCursor = new Table1Cursor(context, columns.numb(), columns.numb2());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Теперь при любом запросе данных из БД celesta не будет выбирать столбец <code>varr</code>, а в курсоре <code>tableCursor</code> поле <code>varr</code> всегда будет иметь значение <code>null</code>.</p>
</div>
<div class="paragraph">
<p>Некоторые особенности ограничения столбцов в выборке:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Колонки, являющиеся частью первичного ключа, всегда будут попадать в курсор из БД, независимо от того, указаны они в списке необходимых полей или нет.
Это сделано для корректной работы метода navigate курсоров при ограничении колонок.</p>
</li>
<li>
<p>Колонки, являющиеся частью group by выражения материализованных представлений (materialized view) всегда будут попадать в курсор из БД.</p>
</li>
<li>
<p>При передаче пустого списка полей или при его отсутствии будут выбираться все колонки.</p>
</li>
<li>
<p>Использование столбцов с типом <a href="#BLOB_fields"><code>BLOB</code></a> не изменяется.
По умолчанию данные из этих полей никогда не читаются из базы данных в процессе навигации, данные из них всегда можно получать вызовом отдельного метода.</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="_передача_параметров_в_функции">Передача параметров в функции</h6>
<div class="paragraph">
<p>Стоит отметить, что курсор <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/ParameterizedViewCursor.html"><code>ParameterizedViewCursor</code></a> имеет собственную версию конструктора, принимающую набор именованных аргументов&#8201;&#8212;&#8201;параметров функции.</p>
</div>
<div class="paragraph">
<p>Допустим, имеется таблица и функция для выборки из нее.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE table t1 (
  id INT NOT NULL IDENTITY PRIMARY KEY,
  f1 int,
  f2 int,
  f3 VARCHAR (2)
);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE FUNCTION pView1(p int) AS
  select sum (f1) as sumv, f3 as f3
  from t1 as t1
  where f2 = $p
  group by f3;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Тогда для создания курсора для функции с параметром p = 5 необходимо выполнить следующий код:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">PView1Cursor pView1 = new PView1Cursor(context, 5);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Передачу параметров функции можно комбинировать с ограничением полей выборки: для этого сначала надо в обязательных аргументах курсора перечислить параметры, а затем в varargs-аргументах передать перечень полей, которые вы хотите выбрать.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_изменение_полей_курсора">Изменение полей курсора</h5>
<div class="paragraph">
<p>По количеству объявленных полей таблицы в классе курсора имеются поля с геттерами и сеттерами, позволяющие читать и записывать информацию.
Так, если таблица foo определена следующим образом</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE foo (
  a INT NOT NULL PRIMARY KEY,
  b VARCHAR(10),
  c DATETIME,
  d BIT
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>то для того, чтобы вставить запись в таблицу foo, можно использовать следующий код:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooCursor foo = new FooCursor(context);
foo.setA(1);
foo.setB("text");
foo.setC(new GregorianCalendar(year, month, day).getTime());
foo.insert();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Соответствие между типами данных CelestaSQL и Java-типами приведено в <a href="#datatypes_mapping">таблице</a>.</p>
</div>
<div class="paragraph">
<p>Обратите внимание на использование класса <code>Date</code> для записи значений даты: это ограничение JDBC API.
При необходимости заполнить поле "с" текущей датой и временем, это можно было бы сделать при помощи выражения</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">foo.setC(new Date());</code></pre>
</div>
</div>
<div class="paragraph">
<p>То, как изменить значение BLOB-поля, описано в разделе <a href="#BLOB_fields">BLOB-поля</a>.</p>
</div>
<div class="paragraph">
<p>Отдельный атрибут <code>getRecversion()</code> в курсоре существует для значения системного поля recversion, необходимого для механизма <a href="#Lost_updates_protection">защиты от потерянных обновлений</a>.</p>
</div>
<div class="paragraph">
<p>Каждый курсор имеет следующие методы (значком <span class="icon"><i class="fa fa-search"></i></span> обозначены методы, унаследованные от <code>BasicCursor</code>, которые могут применяться при работе с представлениями и таблицами «только на чтение»):</p>
</div>
</div>
<div class="sect4">
<h5 id="_закрытие_курсора">Закрытие курсора</h5>
<div class="ulist">
<ul>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>close()</strong> — закрытие курсора (реализует метод <code>close</code> интерфейса <code>java.io.Closeable</code>).
Данный метод высвобождает все JDBC-ресурсы, аллоцированные во время существования курсора.
Обращение к методам закрытого курсора приведёт к ошибке.
Данный метод вызывать не обязательно, т. к. он вызывается автоматически после закрытия <code>CallContext</code> на всех курсорах, созданных с его помощью.
Вообще, предпочтительной практикой программирования является создание как можно меньшего числа курсоров в процедуре и повторное их использование.
Тем не менее, если есть необходимость в создании большого числа курсоров, то возникает необходимость и в использовании метода <code>close()</code> в тот самый момент, когда экземпляр курсора становится ненужным.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_методы_переходов_по_записям">Методы переходов по записям</h5>
<div class="ulist">
<ul>
<li>
<p><strong>tryGet(&#8230;&#8203;)</strong> Осуществляет поиск записи по ключевым полям, возвращает <code>true</code>, если запись найдена, и <code>false</code>, если записи с таким первичным ключом нет в таблице.
В аргументах этого метода должны быть перечислены значения полей первичного ключа, количество аргументов должно быть равно количеству полей первичного ключа таблицы.</p>
</li>
<li>
<p><strong>get(&#8230;&#8203;)</strong> То же, что <code>tryGet</code>, но выбрасывает исключение, если запись не найдена.</p>
</li>
<li>
<p><strong>tryGetCurrent()</strong>  Извлекает из базы данных запись по текущим значениям полей первичного ключа.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Внимание"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Методы <code>get</code>, <code>tryGet</code> and <code>tryGetCurrent</code> не учитывает никаких фильтров, наложенных на таблицу.
Если вам необходимо найти запись с учётом фильтров, то используйте метод <code>[try]First</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>navigate(command)</strong> — осуществляет переход по записям относительно текущего положения.
Возвращает <code>true</code>, если переход удачный, и <code>false</code> — если записи не оказалось.
При этом строка <code>command</code> может представлять собой произвольный набор из следующих символов-команд, выполняемых одна за другой до тех пор, пока запись не нашлась (или набор команд не исчерпался):</p>
<div class="ulist">
<ul>
<li>
<p>- (минус) — переход к первой записи, удовлетворяющей условиям сортировки и фильтрации,</p>
</li>
<li>
<p>+ (плюс) — переход к последней записи,</p>
</li>
<li>
<p>&gt; — переход к следующей записи, относительно текущей, удовлетворяющей условиям сортировки и фильтрации,</p>
</li>
<li>
<p>&lt; — переход к предыдущей записи,</p>
</li>
<li>
<p>= — обновление текущей записи, если она попадает в текущий фильтр.</p>
</li>
</ul>
</div>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>tryFirst()</strong> — то же, что <code>navigate('-')</code>.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>first()</strong> — то же, что <code>tryFirst()</code>, но вызывает ошибку, если запись не найдена.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>tryLast()</strong> — то же, что <code>navigate('+')</code>.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>last()</strong> — то же, что <code>tryLast()</code>, но вызывает ошибку, если запись не найдена.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>next()</strong> — то же, что <code>navigate('&gt;')</code>.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>previous()</strong> — то же, что <code>navigate('&lt;')</code>.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>tryFindSet()</strong> — открывает набор записей (<code>ResultSet</code>) и устанавливает курсор в его начало.
Возвращает <code>true</code>, если открывшийся набор не пуст, <code>false</code> — если записей в наборе нет.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>findSet()</strong> — то же, что <code>tryFindSet()</code>, но вызывает ошибку в случае, если переход неудачен.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>nextInSet()</strong> — переход к следующей записи в текущем наборе записей.
Если набор не открыт, вызов этого метода эквивалентен вызову <code>tryFindSet()</code>.
Возвращает <code>true</code>, если переход состоялся, <code>false</code> — если достигнут конец набора.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>iterator()</strong> — возвращает итератор, позволяющий осуществить полную итерацию по набору записей с первой до последней.
Реализует соответствующий метод интерфейса <code>java.lang.Iterable</code>.
Например, если переменная <code>rec</code> содержит экземпляр курсора, то полная итерация с использованием метода <code>iterate()</code> может быть осуществлена следующим образом:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"> for (FooCursor r: rec): {
         /* здесь внутри цикла всё,
          что вы хотите сделать с записями r */
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>что будет полностью эквивалентно следующему коду:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (cursor.tryFindSet()) {
    while (cursor.nextInSet()) {
        //цикл
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Замечание"></i>
</td>
<td class="content">
<div class="dlist">
<dl>
<dt class="hdlist1"><em>В чём разница между <code>[try]First()</code> и <code>[try]FindSet()</code>?</em></dt>
<dd>
<p>Разница в отправляемом на БД запросе. <code>[try]First()</code> (а также <code>navigate()</code>, <code>next()</code>, <code>last()</code>&#8230;&#8203;) выполняет запрос вида <code>SELECT TOP 1</code>, запрашивают одну запись и сразу закрывают JDBC ResultSet.
Метод <code>findSet()</code> открывает ResultSet и держит его для того, чтобы его можно было бы обойти при помощи метода <code>iterate()</code>.</p>
</dd>
<dt class="hdlist1"><em>Чем <code>navigate("=")</code> отличается от <code>tryGetCurrent()</code>?</em></dt>
<dd>
<p>Метод <code>navigate()</code> учитывает текущие фильтры, а <code>get</code>-методы — не учитывают.
Запись с текущим значением первичного ключа может не попасть в фильтр, поэтому <code>navigate('=')</code> может вернуть <code>false</code> в ситуации, когда <code>tryGetCurrent()</code> возвращает <code>true</code>.</p>
</dd>
<dt class="hdlist1"><em>Что значит <code>navigate("=&gt;&lt;")</code>?</em></dt>
<dd>
<p>Эта команда предписывает следующий алгоритм: "Попытайся найти текущую запись.
Если запись нашлась, выйди и верни <code>true</code>.
Если записи уже нет (удалили), сходи вперёд.
Если запись нашлась, выйди и верни <code>true</code>.
Если впереди ничего нет, сходи назад.
Если запись нашлась, верни <code>true</code>, если нет — <code>false</code>.</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_методы_сортировки_и_фильтрации">Методы сортировки и фильтрации</h5>
<div id="set_range_usage" class="ulist">
<ul>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>setRange(ColumnMeta&lt;?&gt; column)</strong> Сброс любого фильтра на поле.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>setRange(ColumnMeta&lt;? super T&gt; column, T value)</strong> Установка диапазона из единственного значения на поле.
Передача значения <code>null</code> в качестве аргумента приводит к установке фильтра 'IS NULL' на данное поле.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>setRange(ColumnMeta&lt;? super T&gt; column, T valueFrom, T valueTo)</strong> Установка диапазона «от..до включительно» на поле (на уровне языка SQL соответствует оператору BETWEEN).
Использование <code>null</code> в качестве аргумента не допускается.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>setFilter(ColumnMeta&lt;?&gt; column, String value)</strong> Установка фильтра на поле, описание выражений сложных фильтров приведено  <a href="#setFilter_usage">ниже</a>.</p>
</li>
</ul>
</div>
<div id="set_complex_filter_usage" class="ulist">
<ul>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>setComplexFilter(String value)</strong> Установка сложного фильтра на таблицу.
Аргумент соответствует условию <code>WHERE</code> запроса на языке CelestaSQL.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>setIn(BasicCursor auxiliaryCursor)</strong> Установка фильтра с вложенным запросом.
Описание использования <code>setIn</code> приведено <a href="#setIn_usage">ниже</a>.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>limit(long skip, long limit)</strong> Установка ограничений на возвращаемый диапазон строк.
В качестве параметров должны быть неотрицательные целые числа.
Параметр <code>skip</code> означает количество строк, которое будет пропущено перед тем, как начнётся выдача (<code>skip = 0</code> — выдача с самого начала), <code>limit</code> — максимальное число возвращаемых строк, при этом <code>limit = 0</code> означает возврат <strong>всех</strong> строк.
Вызов <code>limit(0, 0)</code> сбрасывает ограничения на возвращаемый диапазон набора строк.
Ограничения, установленные методом <code>limit()</code>, не учитываются при вызове метода <code>count()</code>.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>orderBy(ColumnMeta&lt;?&gt;&#8230;&#8203; columns)</strong> Установка сортировки.
Параметры — перечень полей для сортировки.
Чтобы указывать сортировку по возрастанию или по убыванию, необходимо для соответствующего поля воспользоваться методом <code>asc()</code> или <code>desc()</code>.
Если метод <code>asc()</code> или <code>desc()</code> не был вызван явно, сортировка идёт по возрастанию.
Допускается вызов <strong>orderBy()</strong> без аргументов, чтобы сбросить все установленные ранее сортировки на сортировку по умолчанию.
Поле можно указать не более чем в одном из аргументов метода <strong>orderBy(&#8230;&#8203;)</strong>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Следует помнить, что в Celesta не бывает не отсортированных наборов данных: по умолчанию наборы данных в Celesta всегда сортируются по полям первичного ключа, а к любому набору полей, заданному через <code>orderBy(&#8230;&#8203;)</code>, Celesta автоматически добавляет в конец те поля первичного ключа, которые не были перечислены в аргументах.
Для представлений и <code>WITH READ ONLY</code> таблиц, у которых поля первичного ключа не заданы, Celesta использует для сортировки по умолчанию <strong>первое поле</strong>.
Всё это реализовано для того, чтобы итерация по записям курсора была детерминированной.</p>
</div>
</div>
<div class="sect4">
<h5 id="_методы_инициализации">Методы инициализации</h5>
<div class="ulist">
<ul>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>reset()</strong> Сброс фильтров и сортировки, с сохранением значений полей буфера.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>clear()</strong> Сброс фильтров, сортировки и полная очистка буфера, включая ключевые поля.</p>
</li>
<li>
<p><strong>init()</strong> Очистка всех полей буфера, кроме ключевых.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_методы_клонирования">Методы клонирования</h5>
<div class="ulist">
<ul>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>copyFiltersFrom(BasicCursor c)</strong> Перенос значений всех фильтров, включая значения limit (skip и limit), из курсора с тем же типом в текущий курсор.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>copyOrderFrom(BasicCursor c)</strong> Перенос настроек сортировки из курсора с тем же типом в текущий курсор.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>copyFieldsFrom(BasicCursor c)</strong> Перенос значений всех полей из курсора с тем же типом в текущий курсор.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_методы_модификации_данных">Методы модификации данных</h5>
<div class="ulist">
<ul>
<li>
<p><strong>insert()</strong> Вставка содержимого курсора в БД.
При этом если запись с таким первичным ключом уже существует, возникает ошибка.</p>
</li>
<li>
<p><strong>tryInsert()</strong> Вставка содержимого курсора в БД. <code>true</code> если получилось, <code>false</code> если запись с таким первичным ключом уже существует</p>
</li>
<li>
<p><strong>update()</strong> Сохранение содержимого курсора в БД, выбрасывая исключение в случае, если запись с такими ключевыми полями не найдена.</p>
</li>
<li>
<p><strong>tryUpdate()</strong> Сохранение содержимого курсора в БД, <code>true</code> если получилось, <code>false</code> если запись с таким первичным ключом не существует.</p>
</li>
<li>
<p><strong>delete()</strong> Удаление текущей записи.</p>
</li>
<li>
<p><strong>deleteAll()</strong> Удаление всех записей, попадающих в фильтр.
Внимание: триггер <code>onDelete</code> при этом не вызывается.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_вспомогательные_методы">Вспомогательные методы</h5>
<div class="ulist">
<ul>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>canRead(), canInsert(), canModify(), canDelete()</strong> Возвращает булевское значение, указывающее на наличие прав у текущей сессии на выполнение соответствующей операции.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>count()</strong> Возвращает количество записей в отфильтрованном наборе.
В частности, если фильтров на курсор не установлено, возвращает полное количество записей в таблице.
Ограничения на набор записей, установленные методом limit(), не учитываются при вызове метода count().</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>callContext()</strong> Возвращает контекст вызова, на котором создан данный курсор.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>meta()</strong> Возвращает описание таблицы или представления (метаинформацию, экземпляр класса org.javacc.test.celesta.Table/View).</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>asCSVLine()</strong> Возвращает значение полей курсора в виде CSV-строки с разделителями-запятыми.</p>
</li>
<li>
<p><strong>getMaxStrLen(ColumnMeta&lt;String&gt;)</strong> Возвращает длину текстового поля (в символах).
Метод необходим для определения длины, до которой необходимо обрезать строку, передаваемую в базу данных.
Возвращает -1, если поле определено как TEXT.</p>
</li>
<li>
<p><strong>getXRec()</strong> Возвращает <a href="#xrec_section">копию буфера</a>, содержащую значения, полученные при последнем чтении данных из базы.</p>
</li>
</ul>
</div>
<div id="try_method_notice" class="paragraph">
<p>Обратите внимание, что методы <code>get</code>, <code>first</code>, <code>insert</code>, <code>update</code> имеют два варианта: без приставки <code>try</code> (просто <code>get(&#8230;&#8203;)</code> и т. д.) и с приставкой <code>try</code> (<code>tryGet(&#8230;&#8203;)</code>, <code>tryFirst(&#8230;&#8203;)</code> и т. д.).</p>
</div>
<div class="paragraph">
<p>Методы без приставки <code>try</code> вызывают исключение, если в базе данных нет подходящих данных для выполнения действия.
К примеру, <code>first()</code> вызовет исключение, если в установленный на курсор фильтр не попадёт ни одной записи (или, в вырожденном случае, если таблица окажется пуста).
Методы <code>get</code> и <code>update</code> вызовут исключение в случае отсутствия соответствующей записи, а метод <code>insert</code> — если запись с таким набором значений полей первичного ключа уже существует.
В то же время методы с приставкой <code>try</code> исключения не вызывают, а вместо этого возвращают булевское значение, сигнализирующее об успешности или неуспешности соответствующей операции.</p>
</div>
<div class="paragraph">
<p>Правильной практикой при разработке кода бизнес-логики является использование методов БЕЗ приставки <code>try</code> везде, где это возможно.
Таким образом создаётся «самотестирующийся» код, вовремя сигнализирующий об ошибках в логике и/или в данных базы данных.
К примеру, если при разработке процедуры мы предполагаем, что если приложение работает верно, то в переменной <code>idFoo</code> содержится идентификатор записи, существующей в таблице <code>foo</code>, то для получения самой записи следует писать <code>foo.get(idFoo)</code>.
В этом случае, если где-то в программе есть ошибка, приводящая к тому, что idFoo может принимать значение несуществующего идентификатора, об этом будут проинформированы разработчики и пользователи в самый момент возникновения данной ситуации.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Внимание"></i>
</td>
<td class="content">
<div class="paragraph">
<p>«Маскировка» возможных проблем путём использования <code>try</code>&#8230;&#8203;-метода без явной нужды в возвращаемом значении этого метода может привести к общему запутыванию отладки и дестабилизации кода.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Разумеется, иногда в коде нужно выяснить — есть ли запись с таким идентификатором? Для этого — и только для этого — предназначен <code>tryGet</code>, аналогичное справедливо для других «<code>try</code>-методов», использование которых в подавляющем большинстве случаев оправдано только если предполагается явное использование возвращаемых значений этих методов.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setFilter_usage">4.3.2. Использование метода setFilter</h4>
<div class="paragraph">
<p>В большинстве практических случаев фильтрацию курсоров по значению поля можно выполнять при помощи методов <code>setRange(&#8230;&#8203;)</code> с двумя или тремя параметрами, отфильтровывающих значения по условию вида «поле = значение» либо по условию вида «поле between значение1 and значение2».</p>
</div>
<div class="paragraph">
<p>В случаях, когда простого сравнения или условия between недостаточно, метод <code>setFilter</code> позволяет наложить более сложное условие на значения в одном из полей курсора.
Первым аргументом метода <code>setFilter</code> является поле, а вторым — выражение фильтра.</p>
</div>
<div class="paragraph">
<p>Правильное выражение фильтра может состоять из:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>числовых либо текстовых литералов (в зависимости от типа поля),</p>
</li>
<li>
<p>литерала <code>null</code>,</p>
</li>
<li>
<p>логических операторов &amp;, |, !,</p>
</li>
<li>
<p>операторов сравнения &lt;, &gt;, ..,</p>
</li>
<li>
<p>группирующих скобок (, ),</p>
</li>
<li>
<p>специальных операторов @ и % для текстовых полей.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Выражение фильтра не может быть <code>null</code> или пустой строкой, для сброса фильтра с поля следует вызывать метод <code>setRange()</code> без параметров.
Пробелы между литералами и операторами игнорируются.
Выражение фильтра напрямую, без какой-либо оптимизации, транслируется в условие для выражения <code>WHERE</code> языка SQL.</p>
</div>
<div class="sect4">
<h5 id="_выражения_фильтра_для_полей_с_типами_bit_и_blob">Выражения фильтра для полей с типами BIT и BLOB</h5>
<div class="paragraph">
<p>Для полей с типами BIT и BLOB допустимо использование выражения фильтров вида null и !null, отфильтровывающие значения «поле is null» и «not (поле is null)»:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="bit_blob_filter.svg" alt="bit blob filter" width="215" height="75">
</div>
</div>
<div class="paragraph">
<p>Иные виды фильтрации для типа BLOB смысла не имеют, а для битового типа условие на <code>true</code> или <code>false</code> накладывается с помощью метода <strong>setRange(&#8230;&#8203;)</strong>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_выражения_фильтра_для_полей_с_типами_integer_и_real">Выражения фильтра для полей с типами INTEGER и REAL</h5>
<div class="paragraph">
<p>Для полей с типами INTEGER и REAL допустимо использование выражений фильтров по следующим синтаксическим правилам:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="filter.svg" alt="filter" width="386" height="172">
</div>
</div>
<div class="paragraph">
<p>Здесь</p>
</div>
<div class="ulist">
<ul>
<li>
<p>&amp; — знак логического И,</p>
</li>
<li>
<p>| — знак логического ИЛИ,</p>
</li>
<li>
<p>! — знак логического НЕ,</p>
</li>
<li>
<p>(, ) — группирующие скобки.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Выражение <strong>term</strong> для числовых полей имеет следующий синтаксис:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="filter_numeric_term.svg" alt="filter numeric term" width="566" height="213">
</div>
</div>
<div class="paragraph">
<p>Например, выражение фильтра</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(10|&lt;5)&amp;&gt;0</pre>
</div>
</div>
<div class="paragraph">
<p>для поля с именем "foo" будет переведено в условие</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">("foo" = 10 or "foo" &lt; 5) and "foo" &gt; 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Знаки "&gt;" и "&lt;", естественно, задают условия «строго больше» и «строго меньше», а использование символа ".." позволяет задавать условия «больше или равно» и «меньше или равно».
Так, фильтр</p>
</div>
<div class="listingblock">
<div class="content">
<pre>..0|5..7|10..</pre>
</div>
</div>
<div class="paragraph">
<p>будет транслирован в условие</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">"foo" &lt;= 0 or "foo" between 5 and 7 or "foo" &gt;= 10</code></pre>
</div>
</div>
<div class="paragraph">
<p>(напоминаем, что оператор between в SQL задаёт диапазон с включением границ).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Внимание"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Обратите внимание, что выражение фильтра требует явной группировки скобками разных логических операторов, т. е. корректными являются выражения</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(10|&lt;5)&amp;&gt;0
10|(&lt;5&amp;&gt;0)
10|&lt;5|&gt;0</pre>
</div>
</div>
<div class="paragraph">
<p>но вызовет ошибку выражение</p>
</div>
<div class="listingblock">
<div class="content">
<pre>10|&lt;5&amp;&gt;0</pre>
</div>
</div>
<div class="paragraph">
<p>в котором нет группирующих скобок, явно указывающих на последовательность вычисления операторов ИЛИ и И.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_выражения_фильтра_для_полей_с_типом_datetime">Выражения фильтра для полей с типом DATETIME</h5>
<div class="paragraph">
<p>Выражения фильтра для полей с типом DATETIME имеют такой же синтаксис, что и для числовых полей, но вместо числового нумерала <strong>&lt;numeric literal&gt;</strong> следует использовать нумерал даты в виде 'YYYYMMDD' (апостроф, восемь цифр, апостроф).
Таким образом, правильные выражения фильтров для поля даты выглядят так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">'20131124'
'20131124'..'20151211'|'20111111'
(&gt;'20131124'&amp;..'20151211')|'20111111'..</code></pre>
</div>
</div>
<div class="paragraph">
<p>Разные типы СУБД по-разному работают с литералами дат, но Celesta транслирует выражения фильтра в условия, корректно отрабатывающиеся каждой из поддерживаемых СУБД.</p>
</div>
</div>
<div class="sect4">
<h5 id="_выражения_фильтра_для_полей_с_типом_varcharn_и_text">Выражения фильтра для полей с типом VARCHAR(n) и TEXT</h5>
<div class="paragraph">
<p>Выражения фильтра для текстовых полей в целом похожи на выражения фильтра для числовых полей, с той лишь разницей, что вместо чисел в выражениях термов надо указывать строковые литералы в одинарных кавычках.
Например, на текстовом поле корректным является фильтр <strong>'aa'|'bb'|'cc'</strong>, который отфильтрует записи, в которых значения фильтруемого поля равны "aa", "bb" или "cc".
При этом, если нужно отфильтровать текст, содержащий одинарную кавычку, то её в текстовом литерале (как и обычно в языке SQL) следует удвоить: для отбора значений "John&#8217;s company" следует писать 'John''s company'.
Как и все прочие типы полей, текстовые поля можно фильтровать по значению null/ not null при помощи термов null/!null.</p>
</div>
<div class="paragraph">
<p>Кроме того, текстовые поля можно фильтровать при помощи оператора LIKE, применяя специальный символ %, означающий любую комбинацию любых символов, а также при помощи специального символа @ указывать на независимость фильтра от регистра.</p>
</div>
<div class="paragraph">
<p>Более точно, синтаксические правила термов фильтра для текстовых полей выглядят следующим образом:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="filter_text_term.svg" alt="filter text term" width="602" height="280">
</div>
</div>
<div class="paragraph">
<p>Так, выражение</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">('aaa'&amp;'bb')|(!'ddd'&amp;!null)</code></pre>
</div>
</div>
<div class="paragraph">
<p>будет транслировано в</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">(("foo" = 'aaa' and "foo" = 'bb') or (not ("foo" = 'ddd') and not ("foo" is null))</code></pre>
</div>
</div>
<div class="paragraph">
<p>(что естественно никогда не будет выполнено, этот и следующий примеры даны лишь для иллюстрации принципа трансляции фильтров в язык SQL).</p>
</div>
<div class="paragraph">
<p>Выражение</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">@'q'|@..'cC'|@'Ff'..|@'a'..'b'|@%'5a'|'abc'%|! @ %'ef'%|null</code></pre>
</div>
</div>
<div class="paragraph">
<p>использующее знаки @, транслируется в</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">UPPER("foo") = 'Q' or UPPER("foo") &lt;= 'CC' or UPPER("foo") &gt;= 'FF' or UPPER("foo") between 'A' and 'B'
or UPPER("foo") like '%5A' or "foo" like 'abc%' or not (UPPER("foo") like '%EF%') or "foo" is null</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setIn_usage">4.3.3. Использование метода setIn</h4>
<div class="paragraph">
<p>Метод <strong>setFilter</strong> позволяет фильтровать записи, некоторое поле которых принимает любое значение из заранее заданного набора.
К примеру,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">myCursor.setFilter(myCursor.COLUMNS.city_id(), "'MSK'|'LON'");</code></pre>
</div>
</div>
<div class="paragraph">
<p>отфильтровывает записи, поле «код города» которых принимает значение MSK или LON.
Вызов</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">myCursor.setFilter(myCursor.COLUMNS.city_id(), "'M'%");</code></pre>
</div>
</div>
<div class="paragraph">
<p>отфильтровывает записи, код города в которых начинается с латинской буквы M.</p>
</div>
<div class="paragraph">
<p>Однако функциональности <strong>setFilter</strong> бывает недостаточно: что если необходимо отфильтровать записи, относящиеся к городам, находящимся в определённом регионе или стране?</p>
</div>
<div class="paragraph">
<p>Одним из способов решения такой задачи могло быть следующее: отфильтровать справочник городов по <code>city.setRange(city.COLUMNS.country_id(), "RUS")</code>, далее выгрузить из базы данных в память полный набор идентификаторов таких городов, объединить их в строку фильтра через вертикальную черту, и использовать это как фильтр на другом курсоре.
Ясно, что такой подход плох, если попадающих в фильтр записей слишком много: это породит обмен лишними данными по сети и слишком длинный SQL-запрос к интересующей нас таблице.</p>
</div>
<div class="paragraph">
<p>Для этого случая применяется метод <code>setIn</code>, который позволяет установить фильтр с вложенным запросом по указанному набору полей.
Доступен для наследников классов Cursor и ViewCursor.</p>
</div>
<div class="paragraph">
<p>Общая схема работы с <code>setIn</code> такова:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>устанавливаются фильтры на целевом и вспомогательных курсорах (в приведённом выше примере <code>myCursor</code> играет роль целевого, а <code>city</code>&#8201;&#8212;&#8201;вспомогательного),</p>
</li>
<li>
<p>устанавливается связь полей между целевым и вспомогательными курсорами.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Связь полей задается при помощи класса <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/filter/value/FieldsLookup.html"><code>FieldsLookup</code></a>, возвращаемого в качестве результата из метода <code>setIn</code> целевого курсора.
Метод <code>setIn</code> принимает в качестве единственного аргумента объект вспомогательного курсора, по которому ищется пересечение.
Подготовка целевого курсора и аккумулирование пар столбцов с последующей установкой фильтра происходит следующим образом:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">TargetCursor a = new TargetCursor(context);
AuxiliaryCursor b = new AuxiliaryCursor(context);
b.setRange(b.COLUMNS.foo(), "bar");
a.setIn(b)
     .add(a.COLUMNS.a1(), b.COLUMNS.b1())
     .add(a.COLUMNS.a2(), b.COLUMNS.b2());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Для данного примера в PostgreSQL для доступа к строкам курсора <code>a</code> будет сгенерировано следующее sql выражение:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT ... FROM Target WHERE ( a1, a2 ) IN (SELECT b1, b2 FROM Auxiliary WHERE Auxiliary.foo = 'bar' )</code></pre>
</div>
</div>
<div class="paragraph">
<p>К целевому курсору можно применить любое число вспомогательных курсоров через метод <code>and</code> класса <code>FieldsLookup</code>.
При этом вспомогательные курсоры между собой никак не пересекаются.
Пример задания нескольких вспомогательных курсоров ниже:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">TargetCursor a = new TargetCursor(context);
a.setRange(a.COLUMNS.afoo(), "aBar");
AuxiliaryCursor b = new AuxiliaryCursor(context);
b.setRange(b.COLUMNS.bFoo(), "bBar");
Auxiliary2Cursor c = new Auxiliary2Cursor(context);
c.setRange(c.COLUMNS.cFoo(), "cBar");
a.setIn(b)
     .add(a.COLUMNS.a1(), b.COLUMNS.b1())
     .add(a.COLUMNS.a2(), b.COLUMNS.b2());
.and(c)
     .add(a.COLUMNS.a1(), c.COLUMNS.c1());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Для данного примера в PostgreSQL для доступа к строкам курсора a будет сгенерировано следующее sql выражение:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT ...
FROM Target
WHERE aFoo = 'aBar'
    AND ( a1, a2 ) IN (SELECT b1, b2 FROM Auxiliary WHERE Auxiliary.bFoo = 'bBar' )
    AND (a1) IN (SELECT c1 FROM Auxiliary2 WHERE Auxiliary2.cFoo = 'cBar' )</code></pre>
</div>
</div>
<div class="paragraph">
<p>У данного фильтра имеется набор ограничений, несоблюдение которых приведёт к выбрасыванию исключения во время выполнения методов <code>FieldsLookup.add</code> или <code>BasicCursor.setIn</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Типы данных у каждой пары сопоставляемых полей должны в точности совпадать.</p>
</li>
<li>
<p>В каждой из таблиц должен существовать индекс, включающий в себя все столбцы из набора сопоставляемых столбцов: для примера выше для таблицы <code>Target</code> должен иметься индекс <code>I1(a1, a2,..)</code>, для <code>Auxiliary</code>&#8201;&#8212;&#8201;<code>I2(b1, b2,&#8230;&#8203;)</code>.</p>
</li>
<li>
<p>Для курсоров на таблицы соответствующие индексы должны содержать сопоставляемые столбцы в своём начале.
Для нашего примера, если имеются индексы <code>I1(a1, a2,..)</code>, <code>I2(b1, b2,&#8230;&#8203;)</code>, следующий код вызовет исключение, т. к. поля <code>a2</code>, <code>b2</code> находятся не в начале индексов <code>I1</code> и <code>I2</code>:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">a.setIn(b).add(a.CURSORS.a2(), b.CURSORS.b2());</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_класс_sequence">4.3.4. Класс Sequence</h4>
<div class="paragraph">
<p>Класс <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/Sequence.html">Sequence</a> позволяет работать с последовательностями.
В отличие от остальных классов доступа при кодогенерации вместо суффикса Cursor используется суффикс Sequence.
Класс Sequence имеет единственный метод <code>nextValue</code>, позволяющий получить следующее значение последовательности в виде типа <code>long</code>.</p>
</div>
<div class="paragraph">
<p>Ниже приведен пример использования класса доступа Sequence:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE SCHEMA sequences version '1.0';
CREATE SEQUENCE idNumerator START WITH 3;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">IdNumeratorSequence sq  = new IdNumeratorSequence(ctx);
//выводит следующее значение, начиная с 3.
System.out.println(sq.nextValue());</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_распределение_прав_доступа_и_протоколирование_изменений">4.3.5. Распределение прав доступа и протоколирование изменений</h4>
<div class="paragraph">
<p>Работа с данными через классы доступа к данным даёт не только возможность писать универсальный, не зависящий от используемой СУБД код, но также и решить задачу централизованного распределения прав доступа к данным таблиц и протоколирования изменений.</p>
</div>
<div class="paragraph">
<p>Вызов ряда методов требует наличия соответствующих прав у пользователя на таблицы, прописанных в системных таблицах <code>celesta.userroles</code> и <code>celesta.permissions</code>, в противном случае возникает исключение <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/PermissionDeniedException.html"><code>PermissionDeniedException</code></a> с сообщением вида "There is no &#8230;&#8203; permission for user &#8230;&#8203; on object &#8230;&#8203;".</p>
</div>
<div class="paragraph">
<p>Если протоколирование изменения таблицы настроено в таблице <code>celesta.logsetup</code>, то вызов некоторых методов будет приводить к созданиям записей в таблице <code>celesta.log</code>.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 28.5714%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Метод</th>
<th class="tableblock halign-center valign-middle">Требуемые права</th>
<th class="tableblock halign-center valign-middle">Протоколирование изменений</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[try]first()</code>,
<code>[try]get()</code>,
<code>next()</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">на чтение (r)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">не протоколируются</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[try]insert()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">на вставку (i)</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>протоколируется, если включён флаг i.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>oldvalues</code>&#8201;&#8212;&#8201;пустое значение.</p>
</li>
<li>
<p><code>newvalues</code>&#8201;&#8212;&#8201;вставляемая запись.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[try]update()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">на модификацию (m)</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>протоколируется, если включён флаг m.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>oldvalues</code>&#8201;&#8212;&#8201;состояние записи до модификации.</p>
</li>
<li>
<p><code>newvalues</code>&#8201;&#8212;&#8201;состояние записи после модификации.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delete[All]()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">на удаление (d)</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>delete()</code> протоколируется, если включён флаг d.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>oldvalues</code>&#8201;&#8212;&#8201;состояние записи до удаление.</p>
</li>
<li>
<p><code>newvalues</code>&#8201;&#8212;&#8201;пустое значение.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Внимание"></i>
</td>
<td class="content">
<code>deleteAll()</code> не протоколируется и триггеры не выполняются.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Прочие методы не требуют никаких прав доступа к таблице и вызов их не протоколируется.
Т. е. определить курсор, выставить на нём фильтры и даже подсчитать количество подпадающих под фильтры записей при помощи метода <code>count()</code> можно, даже не имея никаких прав на чтение таблицы.</p>
</div>
<div class="paragraph">
<p>Механизмом распределения прав и протоколирования можно как пользоваться, так и не пользоваться.
При этом, если ими не пользоваться, их потенциальное наличие создаёт минимальный overhead по производительности.</p>
</div>
</div>
<div class="sect3">
<h4 id="BLOB_fields">4.3.6. BLOB-поля</h4>
<div class="paragraph">
<p>BLOB-поля позволяют хранить в ячейке таблицы большие объёмы данных — например, целые файлы с документами.
Работа с этими полями через курсор отличается от работы с полями других типов.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Поля курсора, соответствующие BLOB-полям, имеют тип данных <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BLOB.html"><code>BLOB</code></a>.</p>
</li>
<li>
<p>Получить экземпляр класса BLOB и присвоить его полю курсора можно только одним способом: вызвав в курсоре метод <code>calc&lt;имя поля&gt;()</code>.
Например, если BLOB-поле имеет название <code>foo</code>, то соответствующий метод курсора называется <code>calcfoo()</code>, и после его вызова будет заполнено соответствующее поле курсора.</p>
</li>
<li>
<p>В отличие от полей других типов, которые автоматически заполняются данными таблицы при чтении записи методами <code>get()</code>, <code>next()</code> и т. п., BLOB-поля при выполнении этих методов не заполняются, а всегда получают значение <code>null</code>.
Чтобы прочитать BLOB-поле, необходимо вызвать метод <code>calc&#8230;&#8203;()</code>.
При этом, если курсор указывает на существующую в таблице запись, вызов метода <code>calc&#8230;&#8203;()</code> приведёт к чтению содержимого BLOB-а из базы данных в оперативную память.
Поэтому <code>calc&#8230;&#8203;()</code> следует вызывать лишь тогда, когда есть намерение прочитать или изменить содержимое BLOB-а.</p>
</li>
<li>
<p>После вызова метода <code>calc&lt;имя поля&gt;()</code>, соответствующее поле  курсора инициализируется объектом с типом <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BLOB.html"><code>BLOB</code></a>.
Методы этого объекта позволяют читать и изменять его содержимое и описаны далее.
После изменения содержимого объекта BLOB можно воспользоваться методом <code>update()</code> или <code>insert()</code>.</p>
</li>
<li>
<p>Если BLOB необходимо стереть из базы данных, записав в соответствующую ячейку значение <code>NULL</code>, нужно воспользоваться методом <code>setNull()</code> объекта BLOB, а затем вызвать <code>update()</code>.
Присвоение полю значения <code>null</code> через сеттер, в отличие от полей других типов, не сработает, т. к. будет проинтерпретировано системой, как если бы BLOB не был прочитан из базы, и по <code>update()</code> ничего не изменится.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Методы класса <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BLOB.html"><code>BLOB</code></a>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">getInStream()</dt>
<dd>
<p>возвращает экземпляр класса <a href="https://docs.oracle.com/javase/8/docs/api/java/io/InputStream.html"><code>java.io.InputStream</code></a>, из которого можно прочитать содержимое курсора или <code>null</code>, если в ячейке таблицы базы данных содержится значение NULL.
Допускается многократный вызов этого метода, при этом всякий раз будет создаваться новый поток, читающий с начала.</p>
</dd>
<dt class="hdlist1">getOutStream()</dt>
<dd>
<p>стирает все данные BLOB-а в памяти (если они были) и создаёт экземпляр <a href="https://docs.oracle.com/javase/8/docs/api/java/io/OutputStream.html"><code>java.io.OutputStream</code></a>, в который можно записать данные для BLOB-а.
Следует подчеркнуть, что каждый вызов <code>getOutStream()</code> удаляет из BLOB-а в памяти все данные, даже если в полученный поток ничего не будет записано.
Также следует подчеркнуть, что этот метод меняет данные только в представлении BLOB в оперативной памяти, реальная запись в базу данных происходит только после вызова методов <code>insert()</code> или <code>update()</code> на курсоре.</p>
</dd>
<dt class="hdlist1">setNull()</dt>
<dd>
<p>устанавливает для BLOB-а значение <code>NULL</code>.</p>
</dd>
<dt class="hdlist1">isModified()</dt>
<dd>
<p>возвращает <code>true</code>, если первоначальные данные объекта были изменены вызовами <code>getOutStream()</code> или <code>setNull()</code>.</p>
</dd>
<dt class="hdlist1">size()</dt>
<dd>
<p>возвращает размер внутренних данных BLOB-а в байтах.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Примеры кода для работы с BLOB-полем:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">OrderLineCursor line = new LineCursor(context);
//Далее подразумевается, что line.dat — BLOB-поле
. . .
//Пример записи
line.calcDat();
try(OutputStreamWriter osw = new OutputStreamWriter(
    line.getDat().getOutStream(), StandardCharsets.UTF_8)){
    osw.append("hello, blob field!");
}
. . .
//Пример чтения
line.calcDat();
InputStream ins = line.getDat().getInStream();
//Помним о том, что в поле может быть NULL
if (Objects.nonNull(ins)){
    try ( BufferedReader inr = new BufferedReader(
        new InputStreamReader(ins, StandardCharsets.UTF_8))) {
        //В консоль будет выведено содержимое BLOB-поля,
        //например, 'hello, blob field!'
                System.out.println(inr.readLine());
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Option_fields">4.3.7. Option-поля</h4>
<div class="paragraph">
<p>Довольно часто в реляционных базах для бизнес-приложений необходимо иметь дело со случаем, когда какое-либо поле может принимать лишь несколько значений из фиксированного списка.
Например, может оказаться так, что поле "state" в вашей таблице может принимать лишь значения "new, processing, finished, error", и никакие иные.</p>
</div>
<div class="paragraph">
<p>Т. к. список фиксированный, делать отдельный справочник и внешний ключ при этом не представляется разумным.
Более того, для оптимизации объёма таблицы и скорости обработки, часто имеет смысл применять целочисленные поля, присваивая определённый "смысл" целочисленным значениям, например, так:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0 - new</p>
</li>
<li>
<p>1 - processing</p>
</li>
<li>
<p>2 - finished</p>
</li>
<li>
<p>3 - error</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Celesta поддерживает упрощённую работу с такими полями.</p>
</div>
<div class="paragraph">
<p>Чтобы объявить, что поле может принимать лишь значения из определённого списка, необходимо прописать свойство <code>option</code> в <a href="#CelestaDoc">CelestaDoc</a> целочисленного или текстового поля.
Например, так:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">create table foo
  ...
  /**целочисленное поле статуса
  {option: [new, processing, finished, error]}*/
  state int,
  /**текстовое поле статуса
  {option: [created, closed]*/
  state2 varchar(6)</code></pre>
</div>
</div>
<div class="paragraph">
<p>При компиляции класса доступа к данным Celesta прочитывает свойство <code>option</code> и генерирует дополнительный код, упрощающий использование значений из списка.</p>
</div>
<div class="paragraph">
<p>Например, для нашей таблицы <code>foo</code> будут автоматически созданы два вложенных класса в классе <code>fooCursor</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static final class State {
    public static final Integer new = 0;
    public static final Integer processing = 1;
    public static final Integer finished = 2;
    public static final Integer error = 3;
    private State() {}
}
public static final class State2 {
    public static final String created = "created";
    public static final String closed = "closed";
    private State() {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Обратите внимание: для целочисленного поля возможные варианты автоматически нумеруются, а для текстового поля текстовые значения возможных вариантов буквально совпадают с их именами.
Разработчик решения теперь может ссылаться на варианты значений следующим образом:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooCursor foo = new FooCursor(context)
foo.setRange(foo.COLUMNS.state(), FooCursor.State.finished)
if (FooCursor.State2.closed.equals(foo.getState2()){
    ....
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dynamic_access">4.3.8. Динамический доступ к данным</h4>
<div class="paragraph">
<p>При написании универсальных процедур обработки данных (таких, например, как процедуры экспорта/импорта) зачастую возникает задача динамического доступа к данным, когда название таблицы/представления/последовательности известно не на этапе написания кода, а во время выполнения.</p>
</div>
<div class="paragraph">
<p>Чтобы создать экземпляр класса доступа к данным, зная лишь объект <a href="#Celesta_metadata">метаданных</a>, можно воспользоваться фабричным статическим методом <code>create</code>  соответствующего базового класса доступа к данным, например:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/Cursor.html#create--"><code>Cursor.create(Table table, CallContext callContext)</code></a></p>
</li>
<li>
<p><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/ViewCursor.html#create--"><code>ViewCursor.create(View view, CallContext callContext)</code></a></p>
</li>
<li>
<p><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/Sequence.html#create--"><code>ViewCursor.create(SequenceElement sequence, CallContext callContext)</code></a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>и так далее.
У классов <code>Cursor</code> и <code>ViewCursor</code> имеется также перегруженная версия метода <code>create</code>, позволяющая создавать экземпляры объектов доступа к данным с <a href="#limit_columns">ограничением по выборке столбцов</a>.</p>
</div>
<div class="paragraph">
<p>Для динамического доступа к значениям полей курсора таблицы или представления в классе <code>BasicCursor</code> предусмотрены методы</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BasicCursor.html#getValue--"><code>BasicCursor.getValue(String name)</code></a></p>
</li>
<li>
<p><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BasicCursor.html#setValue--"><code>BasicCursor.setValue(String name, Object value)</code></a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="triggers_section">4.4. Триггеры</h3>
<div class="paragraph">
<p>Триггером называется написанная создателем решения функция, принимающая в качестве аргумента экземпляр курсора, присоединённая к классу курсора, автоматически вызываемая при вставке, удалении и модификации записи.
Триггер имеет тип <a href="https://docs.oracle.com/javase/8/docs/api/index.html?java/util/function/Consumer.html"><code>Consumer&lt;? super YourCursor&gt;</code></a>.</p>
</div>
<div class="paragraph">
<p>При действиях <code>insert()</code>, <code>update()</code> и <code>delete()</code> система вызывает определённые создателем решения pre- (выполняемые до модификации данных в базе) и post- (выполняемые после модификации данных в базе) триггеры.
Таким образом, всего существует шесть типов триггеров:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">pre-триггеры</th>
<th class="tableblock halign-center valign-middle">post-триггеры</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">onPreInsert</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">onPostInsert</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">onPreUpdate</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">onPostUpdate</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">onPreDelete</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">onPostDelete</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Важно"></i>
</td>
<td class="content">
Чаще всего имеет смысл пользоваться pre-триггерами, чтобы выполнить некоторые действия до того, как изменение будет внесено в базу.
Однако обратите внимание: т. к. триггер <code>onPreInsert</code> выполняется до отправки содержимого курсора в базу данных, то на момент его выполнения не заполняются значения полей, обладающих свойствами <code>DEFAULT</code> или <code>GETDATE()</code>.
Для их автозаполнения средствами БД следует присваивать им значение <code>null</code>.
В триггере <code>onPostInsert</code> эти поля уже будут заполнены.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>В триггере <code>onPreUpdate</code> удобно воспользоваться <a href="#xrec_section">объектом xRec</a>, чтобы определить, какие именно поля собираются быть изменёнными в таблице.
В триггере <code>onPostUpdate</code> объектом xRec воспользоваться уже нельзя, т. к. он становится равным текущему буферу.</p>
</div>
<div class="paragraph">
<p>Триггеров каждого типа на одной таблице может быть сколько угодно.
Триггер для любой таблицы может быть определён с помощью <strong>статических</strong> методов <code>onPreInsert</code>, <code>onPreDelete</code> и т. д. на классах
курсоров.
Определение триггеров с помощью статических методов делает их «глобальными», т. е. выполняющимися при любом взаимодействии с таблицей.</p>
</div>
<div class="paragraph">
<p>Т. к. метод регистрации триггера требует указания экземпляра класса <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/Celesta.html"><code>Celesta</code></a>, в Spring-приложениях
для регистрации триггеров удобно использовать метод <code>@PostConstruct</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Service
public class MyService {

    @Autowired
    private ICelesta celesta;

    @PostConstruct
    public void init(){
        MyCursor.onPreInsert(celesta, c -&gt;
                System.out.printf("Record %s is going to be inserted!%n", c.getId()));
    }

    . . .
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Кодогенерируемый класс <code>MyCursor</code> имеет метод</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static void onPreInsert(ICelesta celesta, Consumer&lt;? super MyCursor&gt; cursorConsumer)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Системные курсоры (из пакета <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/syscursors/package-summary.html"><code>ru.curs.celesta.syscursors</code></a>) также поддерживают возможность регистрировать триггеры.</p>
</div>
</div>
<div class="sect2">
<h3 id="xrec_section">4.5. Объект xRec</h3>
<div class="paragraph">
<p>Объект <code>xRec</code>, получаемый с помощью метода <code>getXRec()</code>, предназначен преимущественно для использования в <a href="#triggers_section">триггере</a> <code>onPreUpdate</code>.
Сравнивая поля <code>xRec</code> с текущими значениями полей, можно определить, что именно изменилось в записи.</p>
</div>
<div class="paragraph">
<p><code>xRec</code> хранит значения полей, полученные при последнем чтении курсора из базы данных (в отличие от основного буфера, поля которого после чтения равны полям <code>xRec</code>, но затем изменяются, когда пользователь присваивает им новые значения).
Обновление объекта <code>xRec</code> происходит только при следующих действиях:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>[try]first()</code>,</p>
</li>
<li>
<p><code>[try]get()</code>,</p>
</li>
<li>
<p><code>next()</code>,</p>
</li>
<li>
<p><code>[try]insert()</code> (по сути после вставки система выполняет операцию <code>get()</code> для курсора, чтобы прочитать значения, выданные базой данных на поля <code>IDENITY</code>, <code>GETDATE()</code>, <code>DEFAULT</code>, обновляя и основной буфер, и <code>xRec</code>),</p>
</li>
<li>
<p><code>[try]update()</code> (после обновления в БД xRec становится копией текущего курсора),</p>
</li>
<li>
<p><code>delete()</code> (после обновления в БД xRec заполняется значением буфера, как он был до удаления).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Обратите внимание, что в pre- и post- триггерах значение <code>xRec</code> будет различным!</p>
</div>
</div>
<div class="sect2">
<h3 id="Lost_updates_protection">4.6. Защита от потерянных обновлений</h3>
<div class="sect3">
<h4 id="_что_такое_потерянное_обновление_lost_update">4.6.1. Что такое потерянное обновление (lost update)?</h4>
<div class="paragraph">
<p>Чтобы проиллюстрировать понятие «потерянное обновление», рассмотрим следующий сценарий.</p>
</div>
<div class="paragraph">
<p>Допустим, в приложении имеется таблица с перечнем клиентов и пользователи могут редактировать эту таблицу через формы-карточки.
Пусть события развиваются в следующей последовательности:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Пользователь А открывает карточку клиента для того, чтобы отредактировать его почтовый индекс.</p>
</li>
<li>
<p>Пользователь Б независимо от пользователя А на своей машине открывает карточку клиента для того, чтобы отредактировать значение его кредитного лимита.</p>
</li>
<li>
<p>Пользователь Б, изменив значение поля «кредитный лимит», сохраняет карточку.
В базу данных записалась информация от пользователя Б, но пользователь А продолжает работу со своей копией карточки, где значение поля «кредитный лимит» ещё не обновилось.</p>
</li>
<li>
<p>Пользователь А заканчивает редактировать почтовый индекс клиента и сохраняет свою копию карточки.
В базу данных сохраняются все поля карточки, в том числе старый кредитный лимит.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>В итоге получается, что работа пользователя Б потеряна!</p>
</div>
<div class="paragraph">
<p>Это наиболее расхожий пример, но на самом деле, разработчик решения может столкнуться с потерянными обновлениями и в гораздо более тривиальном случае, не в рамках многопользовательской работы.
Предположим, что для модификации одной и той же таблицы используются два курсора:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooTableCursor rec1 = new FooTableCursor(context);
FooTableCursor rec2 = new FooTableCursor(context);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Пусть в некий момент оба курсора получают данные об одной и той же записи, например, таким образом:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">rec1.get(1);
rec2.copyFieldsFrom(rec1);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Допустим, запись таблицы <code>FooTable</code> с id = 1 состоит всего из трёх полей:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">id</th>
<th class="tableblock halign-center valign-middle">field1</th>
<th class="tableblock halign-center valign-middle">field2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">oldvalue</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">oldvalue</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>И пусть теперь оба курсора выполняют модификации записи:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">rec1.setField1("newvalue");
rec1.update();
//в rec1 и в базе данных уже запись 1 | newvalue | oldvalue
//но в rec2 всё ещё                 1 | oldvalue | oldvalue
rec2.setField2("newvalue");
rec2.update();
//в базе данных теперь будет запись 1 | oldvalue | newvalue ???</code></pre>
</div>
</div>
<div class="paragraph">
<p>Как видим, неудачно написанный код даже в рамках однопользовательской работы может столкнуться с явлением потери обновлений.</p>
</div>
</div>
<div class="sect3">
<h4 id="_способы_защиты_от_потерянных_обновлений">4.6.2. Способы защиты от потерянных обновлений</h4>
<div class="paragraph">
<p>Исторически для борьбы с явлением потерянного обновления сложились два метода:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Метод пессимистической блокировки (pessimistic lock) заключается в том, что при начале редактирования записи из какого-либо места в приложении, запись помечается как заблокированная, и никакой другой скрипт или пользователь не сможет начать редактирование до тех пор, пока предыдущий редактор не завершит свою работу, обновив запись или отказавшись от её редактирования.</p>
</li>
<li>
<p>Метод оптимистической блокировки (optimistic lock) заключается в том, что любому пользователю или скрипту в любое время разрешено начать редактирование записи, при этом в момент извлечения записи из базы данных извлекается и номер версии записи.
В момент сохранения записи происходит проверка: если номер сохраняемой версии совпадает с таковым в базе данных, запись сохраняется и номер версии записи в базе данных инкрементируется; если же номер сохраняемой версии меньше, чем номер версии записи в базе данных, то пользователю выдаётся ошибка с сообщением о том, что кто-то поменял запись прежде и совет прочитать запись заново.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Каждый из методов, разумеется, имеет свои недостатки.</p>
</div>
<div class="paragraph">
<p>Главным недостатком оптимистической блокировки является, конечно, то, что пользователю не удастся записать результат своей работы в базу данных, если кто-то успел выполнить обновление той же самой записи прежде.
Тем не менее, на практике это происходит в довольно редких случаях, и "страдают" от этого в основном лишь самые "нерасторопные" пользователи, у которых слишком большое время проходит от извлечения записи до завершения её редактирования.</p>
</div>
<div class="paragraph">
<p>Главным недостатком пессимистической блокировки является то, что от пользователя ожидается, что, начав редактирование записи, он явным образом завершит редактирование или откажется от него, сняв с записи блокировку.
Однако на практике, если блокировка записи продолжается слишком долго, невозможно понять, следует ли ждать завершения работы пользователя или требуется внешнее вмешательство и явное снятие блокировки силами администраторов, иначе другие пользователи не смогут работать с заблокированной записью.</p>
</div>
<div class="paragraph">
<p>В целом для систем, подобных Celesta, недостатки пессимистической блокировки являются гораздо более существенными, чем недостатки оптимистической блокировки, и поэтому Celesta использует метод оптимистической блокировки для борьбы с потерянными обновлениями.</p>
</div>
</div>
<div class="sect3">
<h4 id="_защита_от_потерянных_обновлений_в_celesta">4.6.3. Защита от потерянных обновлений в Celesta</h4>
<div class="paragraph">
<p>По умолчанию, всякая таблица в системе Celesta снабжается системным полем <code>recversion</code> с типом <code>INT NOT NULL</code>.</p>
</div>
<div class="paragraph">
<p>Данное поле создаётся автоматически, разработчику не следует включать это поле в <code>CREATE TABLE</code>-скрипт.
Более того, разработчик не может создать собственное поле с именем <code>recversion</code>.
Доступ к этому полю на чтение имеется через метод <code>getRecversion()</code>, как к обычному полю.</p>
</div>
<div class="paragraph">
<p>При вставке новой записи поле <code>recversion</code> принимает значение по умолчанию 1 (единица).</p>
</div>
<div class="paragraph">
<p>При обновлении записи специальный триггер базы данных проверяет тот факт, что новое значение этого поля совпадает со значением, существующим в базе данных: если совпадение установлено, поле инкрементируется, если нет — генерируется ошибка:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"> Can not update &lt;имя гранулы и таблицы&gt; ([&lt;значения полей первичного ключа&gt;]): this record has been already modified by someone. Please start updating again.</code></pre>
</div>
</div>
<div class="paragraph">
<p>В рассмотренных выше примерах Celesta выдаст ошибку и не даст отправить в базу данных запись, приводящую к потерянным обновлениям.</p>
</div>
<div class="paragraph">
<p>Иногда возникает необходимость отказаться от защиты от потерянных обновлений — например, если таблица используется только на чтение и добавление записей, или просто только на чтение.
В этом случае при создании таблицы на языке CelestaSQL необходимо использовать <a href="#table_options">опцию</a> <code>WITH NO VERSION CHECK</code> после определения таблицы.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="celestaunit_section">4.7. CelestaUnit</h3>
<div class="paragraph">
<p>Обычно автоматическое тестирование систем, редактирующих данные, представляет определённые сложности и требует использования специальных приёмов (например, развёртывание базы данных в контейнере).
Такие тесты обычно выполняются медленно и разработчики избегают их.</p>
</div>
<div class="paragraph">
<p>В Celesta тестирование методов, редактирующих данные, осуществляется на уровне очень быстро выполняющихся модульных тестов, для чего разработано расширение <a href="https://junit.org/junit5/">JUnit5</a>.
Модульные тесты выполняются на встроенной непосредственно в Celesta базе H2, работающей в режиме in-memory.
Эта база не требует установки, запускается моментально и исчезает после завершения тестов.</p>
</div>
<div class="paragraph">
<p>За счёт того, что Celesta гарантирует одинаковое поведение классов доступа к данным на всех поддерживаемых типах СУБД (тесты самой Celesta включают в себя прогон сценариев на реальных СУБД), выполнение модульных тестов под H2 является достаточным условием корректности метода и его работоспособности в production базе данных.</p>
</div>
<div class="paragraph">
<p>Чтобы воспользоваться данной функциональностью, необходимо добавить модуль celesta-unit Maven-зависимости проекта:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;ru.curs&lt;/groupId&gt;
    &lt;artifactId&gt;celesta-unit&lt;/artifactId&gt;
    &lt;version&gt;...&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Также в тестовый scope проекта необходимо добавить зависимости JUnit5 (примеры см. в <a href="https://junit.org/junit5/docs/current/user-guide/#dependency-metadata-junit-jupiter-samples">документации Junit5</a>).</p>
</div>
<div class="sect3">
<h4 id="_пример_пользования">4.7.1. Пример пользования</h4>
<div class="paragraph">
<p>Наиболее простым способом использования является добавление аннотации <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celestaunit/CelestaTest.html"><code>@CelestaTest</code></a> к тестовому классу и использование параметров с типом <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/CallContext.html"><code>CallContext</code></a> в тестах:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/*Аннотация CelestaTest подключает JUnit5 extension class ru.curs.celestaunit.CelestaUnitExtension,
обеспечивающий подстановку CallContext-объектов в параметры тестов.*/
@CelestaTest
public class DocumentServiceTest {

    /*Сервис может быть создан как напрямую,
    так и используя DI */

    DocumentService srv = new DocumentService();

    @BeforeEach
    void setUp(CallContext context) {
        //Здесь можно наполнить базу данными, нужными для каждого теста
    }


    @Test
    /*Параметр CallContext будет подставлен автоматически,
    на основе временной базы данных H2*/
    void documentIsPutToDb(CallContext context) throws ParseException {
        /*Вызываем сервис*/
        srv.postOrder(context, ...);
        /*Проверяем, что данные попали в базу*/
        OrderHeaderCursor header = new OrderHeaderCursor(context);
        header.tryFirst();
        assertEquals("no1", header.getId());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Таким образом, каждый из тестов может получать в качестве параметра активный <code>CallContext</code>.
Этот контекст формируется на основе базы данных H2, в которой развёрнута Celesta score, и может быть использован для создания курсоров.
Если используются <code>@BeforeEach</code>-методы, вызываемые перед каждым тестом, то в них будет передаваться тот же <code>CallContext</code>, что и в тестовый метод.</p>
</div>
</div>
<div class="sect3">
<h4 id="_изменение_настроек_celestaunit_по_умолчанию">4.7.2. Изменение настроек CelestaUnit по умолчанию</h4>
<div class="paragraph">
<p>CelestaUnit работает со следующими умолчаниями:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Score path: <code>src/main/resources/score</code>.</p>
</li>
<li>
<p>Проверка ссылочной целостности (по Foreign keys) по умолчанию включена.</p>
</li>
<li>
<p>Очистка таблиц перед каждым тестом по умолчанию включена.</p>
</li>
<li>
<p>Сброс значений sequence-ов перед каждым тестом по умолчанию включен.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Изменить умолчания можно, воспользовавшись параметрами аннотации <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celestaunit/CelestaTest.html"><code>@CelestaTest</code></a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CelestaTest(scorePath = DocumentServiceTest.SCORE_PATH,
    referentialIntegrity = true,
    truncateTables = false,
    resetSequences = false)
public class DocumentServiceTest {
    public static final String SCORE_PATH = "src/test/resources/score";</code></pre>
</div>
</div>
<div class="paragraph">
<p>Например, в ряде случаев бывает полезно отключить проверку ссылочной целостности, что упрощает добавление тестовых данных в таблицы, связанные внешними ключами с другими таблицами.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_часть_5_работа_с_метаданными_celesta">5. Часть 5. Работа с метаданными Celesta</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Celesta_metadata">5.1. Метаданные Celesta</h3>
<div class="sect3">
<h4 id="_метаданные_и_их_динамическое_изменение">5.1.1. Метаданные и их динамическое изменение</h4>
<div class="paragraph">
<p>Экземпляр класса <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/Celesta.html"><code>Celesta</code></a> доступен через метод <strong>getCelesta()</strong> переменной <code><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/CallContext.html">CallContext</a> context</code>, передаваемой в качестве аргумента в каждую процедуру обработки данных.</p>
</div>
<div class="paragraph">
<p>Через метод <strong>getScore()</strong> экземпляра класса Celesta разработчик решения может получить доступ к метаданным системы, построенным при разборе CelestaSQL-файлов.
Доступ к метаданным необходим для получения информации о текущей структуре базы данных во время выполнения кода бизнес-логики, в том числе дополнительных метаданных, привязанных к объектами базы данных через <a href="#CelestaDoc">CelestaDoc</a>.</p>
</div>
<div class="paragraph">
<p>Объекты метаданных не являются неизменяемыми, текущее состояние метаданных может быть выгружено в CelestaSQL с помощью класса <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/GrainSaver.html"><code>GrainSaver</code></a>.</p>
</div>
<div class="paragraph">
<p>Изменяемость метаданных можно использовать для разработки инструментов, читающих и генерирующих CelestaSQL&#8201;&#8212;&#8201;например, для интеграции с инструментами визуального проектирования баз данных.
Изменение метаданных во время выполнения программы, использующей Celesta, запрещено и может привести к недетерминированному поведению системы.</p>
</div>
</div>
<div class="sect3">
<h4 id="_состав_метаданных">5.1.2. Состав метаданных</h4>
<div class="paragraph">
<p>Все метаданные (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/Score.html"><code>Score</code></a>) делятся на гранулы (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/Grain.html"><code>Grain</code></a>), состоящие из таблиц (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/Table.html"><code>Table</code></a>), индексов (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/Index.html"><code>Index</code></a>) и представлений (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/View.html"><code>View</code></a>).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Таблицы состоят из столбцов (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/Column.html"><code>Column</code></a>) и содержат внешние ключи.</p>
</li>
<li>
<p>Индексы относятся к таблицам и состоят из их столбцов (Column).</p>
</li>
<li>
<p>Представления состоят из столбцов представлений (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/ViewColumnMeta.html"><code>ViewColumnMeta</code></a>), которые отличаются от столбцов таблиц, но имеют ряд общих свойств.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ниже представлена диаграмма классов, описывающих метаданные.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="metaclasses.png" alt="metaclasses" width="696" height="607">
</div>
</div>
<div class="paragraph">
<p>Базовым интерфейсом для столбцов таблиц и представлений является интерфейс <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/ColumnMeta.html"><code>ColumnMeta&lt;V&gt;</code></a> (параметр <code>V</code> соответствует Java-типу хранимого в столбце значения), с помощью которого можно узнать Celesta-тип данных столбца, его nullability и <a href="#CelestaDoc">CelestaDoc</a>, привязанный к данному столбцу.
Данный интерфейс реализуют классы <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/ViewColumnMeta.html"><code>ViewColumnMeta&lt;V&gt;</code></a> для описания полей представлений и <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/View.html"><code>Column&lt;V&gt;</code></a> для описания полей таблиц.</p>
</div>
<div class="paragraph">
<p>Класс <code>Column&lt;V&gt;</code> является абстрактным, и для шести типов полей, поддерживаемых Celesta, от него наследуются шесть субклассов:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="columnclasses.png" alt="columnclasses" width="1101" height="407">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_модификация_метаданных">5.1.3. Модификация метаданных</h4>
<div class="paragraph">
<p>Модификация метаданных используется только при разработке инструментов, генерирующих CelestaSQL код.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Внимание"></i>
</td>
<td class="content">
Модификация метаданных во время выполнения приложения на базе Celesta может привести к недетерминированному поведению системы.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>Для <strong>создания</strong> новых объектов метаданных используются конструкторы.
Необходимые связи с другими элементами передаются через параметры: например, <code>IntegerColumn(table, name)</code> создаёт новое целочисленное поле с именем <code>name</code> в таблице <code>table</code>.</p>
</li>
<li>
<p>Для <strong>удаления</strong> объектов следует пользоваться методами <code>delete()</code>, определёнными во многих из классов метаданных.</p>
</li>
<li>
<p>У каждого класса-наследника <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/NamedElement.html"><code>NamedElement</code></a> имеются методы <code>getCelestaDoc()</code> и <code>setCelestaDoc()</code> для чтения и установки документирующих данных CelestaDoc.
При сохранении в файл динамически изменённых метаданных CelestaDoc-комментарии сохраняются.</p>
</li>
<li>
<p>Для работы с объектами метаданных см. соответствующую <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/package-summary.html">документацию по API</a>.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_приложение">6. Приложение</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="best_practices">6.1. Лучшие практики написания кода</h3>
<div class="paragraph">
<p>Следующие советы позволят избежать некоторых распространённых ошибок при написании кода, работающего с СУБД, с использованием Celesta, а также описывают ряд зарекомендовавших себя паттернов.</p>
</div>
<div class="sect3">
<h4 id="_явно_закрывайте_курсоры_создаваемые_в_цикле">6.1.1. Явно закрывайте курсоры, создаваемые в цикле</h4>
<div class="paragraph">
<p>Курсор&#8201;&#8212;&#8201;объект, заключающий в себе JDBC PreparedStatements и ResultSets, необходимые для выполнения методов курсора.
Эти ресурсы необходимо закрывать после использования.
Кроме того, ни сам курсор, ни объекты, составляющие его внутреннее состояние, не являются потокобезопасными, поэтому нельзя хранить курсор в виде разделяемого ресурса.
Закрытие курсора, утеря ссылки на него и завершение транзакции&#8201;&#8212;&#8201;события, которые в норме должны происходить одновременно.</p>
</div>
<div class="paragraph">
<p>Время жизни курсора ограничено временем жизни <code>CallContext</code>, с помощью которого он был создан.
Вызов метода <code>close()</code> на <code>CallContext</code> приводит к закрытию всех курсоров, созданных в этом контексте, поэтому обычно явно закрывать курсоры в коде не нужно.</p>
</div>
<div class="paragraph">
<p>Тем не менее, в ситуации, когда создание курсора может происходить в цикле, его следует явно закрывать.</p>
</div>
<div class="paragraph">
<p>CallContext <a href="#too_many_accessors_warning">не даст создать более 1023 курсоров</a> (иначе это может привести к ошибке на стороне базы данных).
Если курсор может создаваться в цикле, его следует закрывать (в следующем пункте код будет ещё улучшен):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">ПЛОХО</th>
<th class="tableblock halign-center valign-top">НОРМАЛЬНО</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CelestaTransaction
void doSomething(CallContext context) {
  for (int i = 0; i &lt; 2000; i++)
    doSomethingElse(context);
}

void doSomethingElse(CallContext context) {
  //Exception: too many data accessors
  FooCursor foo = new FooCursor (context);
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CelestaTransaction
void doSomething(CallContext context) {
  for (int i = 0; i &lt; 2000; i++)
    doSomethingElse(context);
}

void doSomethingElse(CallContext context) {
  try(FooCursor foo = new FooCursor (context)){
  /*no exception thrown, but
  we can do better!*/
  }
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_избегайте_создания_курсора_в_цикле">6.1.2. Избегайте создания курсора в цикле</h4>
<div class="paragraph">
<p>Создание и закрытие курсора в цикле приводит к многократному созданию и закрытию JDBC PreparedStatements, что работает не эффективно.
Лучшим решением является дизайн кода, при котором курсоры создаются в самом начале сервисного метода и затем переиспользуются:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">НОРМАЛЬНО</th>
<th class="tableblock halign-center valign-top">ПРАВИЛЬНО</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CelestaTransaction
void doSomething(CallContext context) {
  for (int i = 0; i &lt; 2000; i++)
    doSomethingElse(context);
}

void doSomethingElse(CallContext context) {
  try(FooCursor foo = new FooCursor (context)){
  /*no exception thrown, but
  we can do better!*/
  }
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CelestaTransaction
void doSomething(CallContext context) {
  FooCursor foo = new FooCursor (context);
  for (int i = 0; i &lt; 2000; i++)
   doSomethingElse(foo);
}
void doSomethingElse(FooCursor foo) {
  /*now we do not create-and-close
  the cursor in each iteration*/
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_используйте_ограничение_количества_полей_в_курсоре">6.1.3. Используйте ограничение количества полей в курсоре</h4>
<div class="paragraph">
<p>Если в читаемой таблице много полей, но для работы метода нужны лишь некоторые из них&#8201;&#8212;&#8201;для ускорения работы следует воспользоваться <a href="#limit_columns">ограничением выборки полей</a>.
Это способно ощутимо сократить объём данных, передаваемых из базы.</p>
</div>
</div>
<div class="sect3">
<h4 id="_методы_не_обращающиеся_к_базе_данных_работают_быстро">6.1.4. Методы, не обращающиеся к базе данных, работают быстро</h4>
<div class="paragraph">
<p>Методы курсоров можно условно разделить на три категории:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Не обращающиеся к базе данных</th>
<th class="tableblock halign-left valign-top">Производящие чтение</th>
<th class="tableblock halign-left valign-top">Производящие обновление</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>установка/чтение полей</p>
</li>
<li>
<p><code>setRange</code></p>
</li>
<li>
<p><code>setFilter</code></p>
</li>
<li>
<p><code>setComplexFilter</code></p>
</li>
<li>
<p><code>setIn</code></p>
</li>
<li>
<p><code>limit</code></p>
</li>
<li>
<p><code>orderBy</code></p>
</li>
<li>
<p><code>reset</code></p>
</li>
<li>
<p><code>clear</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><code>[try]Get</code></p>
</li>
<li>
<p><code>[try]First</code></p>
</li>
<li>
<p><code>[try]Last</code></p>
</li>
<li>
<p><code>[try]FindSet</code></p>
</li>
<li>
<p><code>next</code></p>
</li>
<li>
<p><code>navigate</code></p>
</li>
<li>
<p><code>count</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><code>[try]Insert</code></p>
</li>
<li>
<p><code>[try]Update</code></p>
</li>
<li>
<p><code>delete</code></p>
</li>
<li>
<p><code>deleteAll</code></p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Вызов методов из первой категории не приводит к отправке никаких запросов к базе данных.
Например, <code>orderBy</code> не сортирует записи в момент вызова, <code>setRange</code> не фильтрует записи в момент вызова&#8201;&#8212;&#8201;они лишь формируют состояние курсора, которое будет использовано при формировании SQL-запросов при вызове методов из второй и третьей категории.</p>
</div>
<div class="paragraph">
<p>Таким образом, правильным паттерном является максимальная «подготовка курсора» через выставление всех необходимых ограничений методами из первой категории перед тем, как запускать методы чтения.</p>
</div>
</div>
<div class="sect3">
<h4 id="_понимайте_семантику_метода_get">6.1.5. Понимайте семантику метода get</h4>
<div class="paragraph">
<p>Метод <code>get(&#8230;&#8203;)</code> извлекает из базы данных одну запись по её известному первичному ключу.
Это гарантированно быстрая (за счёт обязательного наличия индекса на первичном ключе) и очень часто требующаяся на практике операция.
Метод <code>get(&#8230;&#8203;)</code> <em>не учитывает</em> наличие каких-либо фильтров на курсоре, поэтому в редком случае, когда надо проверить, попадает ли запись с известным ключом в набор, определённый фильтрами на текущем курсоре, следует воспользоваться методом <code>navigate("=")</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_не_производите_лишних_чтений_перед_удалением">6.1.6. Не производите лишних чтений перед удалением</h4>
<div class="paragraph">
<p>Если нам известен первичный ключ записи, которую мы хотим удалить, не нужно перед этим вычитывать её из базы данных с помощью <code>get</code> или <code>find</code>.
Методу <code>delete()</code> достаточно только того, чтобы поля первичного ключа были заполнены нужными значениями.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">ПЛОХО</th>
<th class="tableblock halign-center valign-top">ПРАВИЛЬНО</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (foo.tryGet(idForDeletion)) {
	foo.delete();
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">foo.setId(idForDeletion);
foo.delete();</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_не_используйте_count_только_для_того_чтобы_определить_что_набор_данных_не_пуст">6.1.7. Не используйте count() только для того, чтобы определить, что набор данных не пуст</h4>
<div class="paragraph">
<p>Часто встречающаяся ошибка&#8201;&#8212;&#8201;проверять набор записей «на пустоту» через метод <code>count()</code>.
Пересчитывать на стороне базы данных все записи для того, чтобы понять, что есть хотя бы одна&#8201;&#8212;&#8201;плохая идея.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">ПЛОХО</th>
<th class="tableblock halign-center valign-top">ПРАВИЛЬНО</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (fooCursor.count() &gt; 0) {
	...
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (fooCursor.tryFirst()) {
	...
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_пользуйтесь_сортировкой_на_уровне_базы_данных_для_того_чтобы_найти_минимальныемаксимальные_значения">6.1.8. Пользуйтесь сортировкой на уровне базы данных для того, чтобы найти минимальные/максимальные значения</h4>
<div class="paragraph">
<p>Если поиск одного значения можно выполнить в самой базе данных&#8201;&#8212;&#8201;это гораздо предпочтительнее, чем передавать весь набор записей в приложение, чтобы выполнять поиск средствами приложения:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">ПЛОХО</th>
<th class="tableblock halign-left valign-top">ПРАВИЛЬНО</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Цикл по записям с целью поиска  максимального значения поля <code>bar</code>.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">foo.orderBy(foo.COLUMNS.bar().desc());
foo.first();</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_используйте_правильный_тип_фильтрации">6.1.9. Используйте правильный тип фильтрации</h4>
<div class="paragraph">
<p>В Celesta имеется четыре метода фильтрации данных, по мере роста сложности:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>setRange</code></p>
</li>
<li>
<p><code>setFilter</code></p>
</li>
<li>
<p><code>setComplexFilter</code></p>
</li>
<li>
<p><code>setIn</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Не используйте более сложный фильтр, если можно обойтись более простым!</strong></p>
</div>
<div class="paragraph">
<p>Метод <a href="#set_range_usage"><code>setRange</code></a> закрывает большинство практических задач, когда поле необходимо фильтровать по единственному значению или диапазону значений:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cursor.setRange(cursor.COLUMNS.foo(), value)</code> порождает запрос вида <code>WHERE foo = value</code>.</p>
</li>
<li>
<p><code>cursor.setRange(cursor.COLUMNS.foo(), from, to)</code> порождает запрос вида <code>WHERE foo BETWEEN from AND to</code></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Замечание"></i>
</td>
<td class="content">
<code>cursor.setRange(cursor.COLUMNS.foo())</code> (без параметров) убирает фильтр на поле “foo”, ранее заданный как с помощью <code>setRange</code>, так и с помощью <code>setFilter</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Метод <a href="#setFilter_usage"><code>setFilter</code></a> нужен для более редко встречающихся случаев, когда множество значений поля, по которым осуществляется фильтрация, необходимо задать сложным выражением.
На одном поле может быть либо фильтр, заданный <code>setRange</code>, либо фильтр, заданный <code>setFilter</code>, поэтому вызов этих методов для одного и того же поля «вытесняет» заданный ранее фильтр.</p>
</div>
<div class="paragraph">
<p>Следует применять <code>setRange</code> там, где это возможно, т. к. в этом случае Celesta имеет возможность переиспользовать JDBC <code>PreparedStatement</code>-ы, что существенно улучшает быстродействие при работе в цикле:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">ПЛОХО</th>
<th class="tableblock halign-center valign-top">ПРАВИЛЬНО</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooCursor foo = new FooCursor(context);
BarCursor bar = new BarCursor(context);
for (FooCursor c: foo){
  bar.setFilter("baz", "’"+c.getBaz()+"’");
  /* PreparedStatements are
  re-created in each iteration :-(( */
  ...
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooCursor foo = new FooCursor(context);
BarCursor bar = new BarCursor(context);
for (FooCursor c: foo){
  bar.setRange(“baz”, c.getBaz());
  /* PreparedStatement is created
  only once and is being reused :-)*/
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><code>setRange</code> предпочтительнее ещё и потому, что его API позволяет осуществлять контроль типов, передаваемых в качестве аргументов этого метода.</p>
</div>
<div class="paragraph">
<p>Метод <a href="#set_complex_filter_usage"><code>setComplexFilter</code></a> позволяет добавить «кусок SQL» в <code>WHERE</code>-выражение, задающее набор записей курсора.
После любого вызова <code>setComplexFilter</code> все JDBC <code>PreparedStatement</code>-ы должны пересоздаваться заново, поэтому вызывать его в цикле, как и <code>setFilter</code>, неэффективно.
Основное применение этого метода&#8201;&#8212;&#8201;для того, чтобы задавать условия между полями, например: <code>a &gt;= b</code>.
В остальных случаях подходят <code>setRange</code>/<code>setFilter</code>.</p>
</div>
<div class="paragraph">
<p>Метод <a href="#setIn_usage"><code>setIn</code></a> требуется в ситуациях, когда набор фильтруемых значений определяется динамически из других данных в базе.</p>
</div>
</div>
<div class="sect3">
<h4 id="_применяйте_индексы">6.1.10. Применяйте индексы</h4>
<div class="paragraph">
<p>Общий момент, касающийся любой работы с реляционными СУБД.
В случае с Celesta, простым первым приближением является следующее: если на поле курсора вызывается метод <code>setRange</code>&#8201;&#8212;&#8201;на данное поле следует создать индекс.</p>
</div>
</div>
<div class="sect3">
<h4 id="_эффективно_кэшируйте_значения_при_работе_в_циклах">6.1.11. Эффективно кэшируйте значения при работе в циклах</h4>
<div class="paragraph">
<p>Запрос данных в цикле&#8201;&#8212;&#8201;довольно часто встречающийся паттерн.
В этом случае количество запросов к базе данных можно существенно сократить, а скорость увеличить, если применить самое простое кэширование: не надо вызывать <code>get</code> для курсора, если запрашиваемое значение первичного ключа уже соответствует тому, что было вызвано ранее:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//mind possible nulls!
if (!Objects.equals(bar.getId(), c.getBarId()))
		bar.get(c.getBarId());
//use newly fetched or cached bar here...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Эту идею можно развить в очень эффективный паттерн: за счёт сортировки по курсора <code>c</code> по полю <code>barId</code> можно свести количество обращений в базу данных за записями <code>bar</code> к минимуму:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">ПЛОХО</th>
<th class="tableblock halign-center valign-top">ПРАВИЛЬНО</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooCursor foo = new FooCursor(context);
BarCursor bar = new BarCursor(context);
for (FooCursor c: foo){
  bar.get(c.getBarId());
/*fetching data
  in each iteration :-(*/
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooCursor foo = new FooCursor(context);
/*note the orderBy!!!*/
foo.orderBy(foo.COLUMNS.barId());
BarCursor bar = new BarCursor(context);
for (FooCursor c: foo){
  if (!Objects.equals(bar.getId(), c.getBarId()))
	/*minimum number of fetches*/
	bar.get(c.getBarId());
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_не_используйте_try_методы_без_необходимости">6.1.12. Не используйте try-методы без необходимости</h4>
<div class="paragraph">
<p>Многие методы курсора имеют два варианта: без приставки <code>try</code> и c приставкой <code>try</code>.
С точки зрения быстродействия они работают одинаково, с точки зрения дизайна кода (fail-fast подход) предпочтительнее использовать методы без <code>try</code>, если вы не собираетесь использовать возвращаемое булевское значение.
Этот момент <a href="#try_method_notice">разъяснён в документации</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_в_циклах_используйте_итерацию_вместо_навигации">6.1.13. В циклах используйте итерацию вместо навигации</h4>
<div class="paragraph">
<p>Для перемещения по записям в курсоре существуют две группы методов: навигационные и итерационные.</p>
</div>
<div class="paragraph">
<p>К навигационным относятся <code>tryFirst()</code>, <code>next()</code>, <code>previous()</code> и <code>navigate(&#8230;&#8203;)</code>, позволяющие переместиться на другую запись относительно текущей по определённым правилам.</p>
</div>
<div class="paragraph">
<p>К итерационным относятся пара методов <code>tryFindSet()</code>&#8201;&#8212;&#8201;<code>nextInSet()</code>, а также метод <code>iterator()</code>, реализующий соответствующий метод интерфейса <code>java.lang.Iterable</code>.</p>
</div>
<div class="paragraph">
<p>Навигационные методы отправляют по одному запросу в базу данных при каждом вызове, и поэтому их следует использовать лишь в тех случаях, когда нам требуется одна запись.</p>
</div>
<div class="paragraph">
<p>Итерационные методы отправляют запрос и открывают JDBC <code>ResultSet</code>, используемый в дальнейшем для перехода по записям.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">ПЛОХО</th>
<th class="tableblock halign-center valign-top">ПРАВИЛЬНО</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (foo.tryFirst()){
  do {
     ...
  } while (foo.next());
  /*new query in each iteration :-(*/
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/*only one query! :-)*/
for (FooCursor c: foo) {
  ...
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="RDBMS_peculiarities">6.2. Особенности работы Celesta с поддерживаемыми типами СУБД</h3>
<div class="paragraph">
<p>Система по возможности прозрачно для разработчиков решения поддерживает MS SQL Server, Oracle, Postgre SQL, Firebird и H2.</p>
</div>
<div class="paragraph">
<p>Хотя решения Celesta свободно переносимы между разными типами поддерживаемых СУБД, тем не менее, каждая из этих СУБД имеет особенности настройки.
Кроме того, разные функциональные возможности Celesta по-разному реализованы в разных СУБД.
Этим особенностям посвящён данный раздел.</p>
</div>
<div class="paragraph">
<p>Соответствие типов данных Celesta и СУБД приведено в разделе <a href="#datatypes_mapping">«Язык Celesta-SQL: типы данных»</a>.</p>
</div>
<div class="imageblock left">
<div class="content">
<img src="images/Mssql.jpg" alt="Mssql" width="80">
</div>
</div>
<div class="sect3">
<h4 id="_ms_sql_server">6.2.1. MS SQL Server</h4>
<div class="sect4">
<h5 id="_особенности_использования">Особенности использования</h5>
<div class="paragraph">
<p>Версии ниже MS SQL Server 2011 не поддерживают конструкцию <code>CREATE SEQUENCE</code>.</p>
</div>
<div class="imageblock left">
<div class="content">
<img src="images/Ora.jpg" alt="Ora" width="80">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_oracle">6.2.2. Oracle</h4>
<div class="sect4">
<h5 id="_особенности_настройки">Особенности настройки</h5>
<div class="paragraph">
<p><strong>Ошибка ORA-12705: Cannot access NLS data files&#8230;&#8203;</strong> Если при запуске Celesta на Oracle Express Edition возникает ошибка "ORA-12705: Cannot access NLS data files or invalid environment specified", в числе аргументов JVM необходимо задать параметр</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">-Duser.country=US</code></pre>
</div>
</div>
<div class="paragraph">
<p>Эта проблема является общей для связки Oracle XE + JDBC и актуальна только для Oracle Express Edition, в прочих (production) версиях Oracle Database она не актуальна.</p>
</div>
<div class="paragraph">
<p>Минимальные настройки прав доступа для USER&#8217;а в БД <strong>Oracle 11g</strong>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">GRANT
	CONNECT,
	RESOURCE,
	CREATE TABLE,
	CREATE PROCEDURE,
	CREATE VIEW,
	CREATE SEQUENCE,
	CREATE TRIGGER,
	SELECT ANY DICTIONARY
	TO &lt;USER&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>В некоторых организациях по умолчанию не дают право доступа SELECT ANY DICTIONARY, из-за чего может возникать ошибка "ORA-00942: table or view does not exist" при разворачивании системной гранулы Celesta.</p>
</div>
</div>
<div class="sect4">
<h5 id="_особенности_реализации">Особенности реализации</h5>
<div class="ulist">
<ul>
<li>
<p>Гранула — префикс в имени таблицы, отделённый знаком подчёркивания, при этом работает ограничение Oracle на длину имени таблицы — 30 символов.
Причина в том, что понятие «схема» в Oracle несколько отличается от такового для других СУБД, создание «схем» в Oracle связано с созданием новых пользователей, на что на практике не могут быть выданы права администраторами Oracle-серверов, на которых хранятся промышленные данные.</p>
</li>
<li>
<p>Oracle сам по себе не поддерживает конструкцию <code>FOREIGN KEY &#8230;&#8203; ON UPDATE/DELETE SET NULL</code>, поэтому она эмулируется при помощи триггеров.</p>
</li>
</ul>
</div>
<div class="imageblock left">
<div class="content">
<img src="images/postgresql.svg" alt="postgresql" width="120">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_postgresql">6.2.3. PostgreSQL</h4>
<div class="sect4">
<h5 id="_особенности_использования_2">Особенности использования</h5>
<div class="paragraph">
<p>При использовании Celesta для доступа к существующей заранее (а не создаваемой и обновляемой в Celesta) базе данных может возникнуть проблема с полями типа uuid.
Сама Celesta типа данных uuid как такового не поддерживает, но может работать с ним через поле типа VARCHAR(36).
При этом не возникает проблем в MS SQL Server, но для работы Celesta в Postgres требуется явно определить оператор сравнения varchar с uuid и имплицитное изменение типов при присвоении:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE OR REPLACE FUNCTION celesta.uuidequal(a1 uuid, a2 CHARACTER VARYING)
  RETURNS BOOLEAN AS 'select a1::varchar = a2'
  LANGUAGE SQL IMMUTABLE;
CREATE OPERATOR = (
    LEFTARG = uuid,
    RIGHTARG = CHARACTER VARYING,
    PROCEDURE = celesta.uuidequal
);
CREATE CAST (character varying AS uuid)
    WITH  INOUT AS ASSIGNMENT;</code></pre>
</div>
</div>
<div class="imageblock left">
<div class="content">
<img src="images/firebird.svg" alt="firebird" width="120">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_firebird">6.2.4. Firebird</h4>
<div class="sect4">
<h5 id="_особенности_реализации_2">Особенности реализации</h5>
<div class="ulist">
<ul>
<li>
<p>Гранула — префикс в имени таблицы, отделённый знаком подчёркивания, при этом работает ограничение.
Причина в том, что понятия «схема» в Firebird не существует.</p>
</li>
<li>
<p>Поддержка типа данных <code>TIMESTAMP WITH TIMEZONE</code>, необходимая для Celesta, появилась начиная только с 4-й версии.</p>
</li>
</ul>
</div>
<div class="imageblock left">
<div class="content">
<img src="images/H2.png" alt="H2" width="120">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_h2">6.2.5. H2</h4>
<div class="sect4">
<h5 id="_особенности_настройки_2">Особенности настройки</h5>
<div class="ulist">
<ul>
<li>
<p>Для упрощенной инициализации inmemory db в <a href="#basic_settings_section">параметры конфигурации</a> можно добавить настройку <code>h2.in-memory=true</code>.
В таком случае строка JDBC подключения, а также логин и пароль пользователя, заданные другими параметрами, будут игнорироваться.</p>
</li>
<li>
<p>В параметрах конфигурации имеется настройка <code>h2.referential.integrity=false(по умолчанию)/true</code>.
Значение <code>false</code> означает, что ограничения типа внешних ключей будут проигнорированы при записи в БД.
При включении ограничения будут обрабатываться как в других РСУБД.
Для установки данной настройки не в inmemory БД пользователь должен обладать правами администратора(поле "ADMIN" в таблице "INFORMATION_SCHEMA.USERS") Данная настройка срабатывает один раз при инициализации приложения и для обновления требуется его перезапуск.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_особенности_реализации_3">Особенности реализации</h5>
<div class="ulist">
<ul>
<li>
<p>Поля 'recversion' управляются триггером, написанном на Java и реализующим интерфейс <a href="https://www.h2database.com/javadoc/org/h2/api/Trigger.html"><code>org.h2.api.Trigger</code></a>. H2 не поддерживает триггеры, логика которых заключена в процедурном SQL.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="DBSchema">6.3. Проектирование базы данных Celesta в DBSchema</h3>
<div class="sect3">
<h4 id="_синхронизация_метаданных_celesta_и_проекта_dbschema">6.3.1. Синхронизация метаданных Celesta и проекта DBSchema</h4>
<div class="paragraph">
<p><a href="https://dbschema.com/">DBSchema</a> представляет собой удобный инструмент визуального моделирования структуры базы данных.
Имеется возможность полностью моделировать в DBSchema всю информацию Celesta о структуре БД (таблицы, поля, ключи, индексы), а также наоборот — превратить существующий Score в проект DBSchema.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/800px-Dbschemascreen.png" alt="800px Dbschemascreen" width="100%">
</div>
</div>
<div class="sect4">
<h5 id="_настройка_системы">Настройка системы</h5>
<div class="paragraph">
<p>Для работы вам понадобится:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://dbschema.com/">DBSchema</a> (программа проприетарная).</p>
</li>
<li>
<p>Утилита <a href="https://github.com/courseorchestra/dbschemasync"><code>dbschemasync</code></a>.
Актуальную сборку утилиты <code>dbschemasync</code> можно взять, например, <a href="https://artifactory.corchestra.ru/artifactory/list/libs-release-local/ru/curs/dbschemasync/">здесь</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Распакуйте zip-архив и поместите папку Celesta с настройками DBSchema в <code>%userprofile%\.DbSchema\config\rdbms\</code>.</p>
</div>
<div class="paragraph">
<p>В папке <code>/bin</code> zip-архива находится исполняемый файл <code>dbschemasync</code>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_запуск_синхронизации">Запуск синхронизации</h5>
<div class="paragraph">
<p>Утилита <code>dbschemasync</code> принимает два параметра:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Score path</p>
</li>
<li>
<p>имя DBS-файла (проекта DBSchema)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Направление синхронизации определяется последовательностью аргументов: если первым аргументом идёт Score Path, то синхронизация идёт от Score к проекту DBSchema, если же первым аргументом идёт имя проекта DBSchema, то синхронизация идёт от DBSchema к Score.</p>
</div>
<div class="paragraph">
<p>Пример команды для синхронизации от score к схеме:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dbschemasync "c:/temp/dbschema/score/" "c:/temp/dbschema/schema.dbs"</code></pre>
</div>
</div>
<div class="paragraph">
<p>Пример синхронизации от схемы к score:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dbschemasync "c:/temp/dbschema/schema.dbs" "c:/temp/dbschema/score/"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_особенности_работы_при_дизайне_структуры_бд">Особенности работы при дизайне структуры БД</h5>
<div class="paragraph">
<p>Всё, что находится в <a href="#CelestaDoc">CelestaDoc</a>, переводится в Documentation-поля DBSchema, и наоборот.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/800px-Dbschemascreen3.png" alt="800px Dbschemascreen3" width="100%">
</div>
</div>
<div class="paragraph">
<p>Опции таблицы (<code>WITH (NO) VERSION CHECK</code>, <code>WITH READ ONLY</code>&#8230;&#8203;) находятся на вкладке Storage:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/Dbschemascreen4.png" alt="Dbschemascreen4" width="80%">
</div>
</div>
<div class="paragraph">
<p>В DBSchema, чтобы задать версию гранулы, необходимо модифицировать мнимую «хранимую процедуру», имеющую то же название, что и гранула (сами хранимые процедуры для Celesta в DBSchema, естественно, не моделируются):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/Dbschemascreen2.png" alt="Dbschemascreen2" width="80%">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_создание_celestasql_скриптов_на_основе_структуры_существующей_бд">6.3.2. Создание CelestaSQL-скриптов на основе структуры существующей БД</h4>
<div class="paragraph">
<p>Эта технология рекомендована всем, у кого возникнет задача создания CelestaSQL-скриптов для уже существующей базы данных.
Использование каких-либо иных путей (например, выгрузка SQL-скрипта из базы данных и ручная его «вычистка») по опыту является гораздо более трудоёмким занятием.</p>
</div>
<div class="paragraph">
<p>Для этого требуется программа DBSchema с установленной поддержкой Celesta.
Шаги следующие:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Присоединяем DBSchema к нужной базе данных и методом Reverse Engineering закачиваем всю нужную нам структуру (на этом этапе можно ограничиться только теми таблицами и связями, которые нас интересуют в Celesta).
Убедитесь, что «забрали» все нужные таблицы, т. к. на следующих шагах проект придётся «отсоединить» от базы данных и автоматически получить сведения о таблицах уже не получится.</p>
</li>
<li>
<p>Отключаем DBSchema от базы данных (offline) и меняем тип базы с SQL Server на Celesta через меню Project&#8594;Project Settings (естественно, предполагается, что к этому моменту в DBSchema установлена надстройка для синхронизации с Celesta).
Откроется окно, в котором DBSchema предложит сопоставить типы.
Необходимо аккуратно прописать соответствие типов для Celesta: например, для SQL Server  <code>VARCHAR(MAX)</code> перевести в <code>TEXT</code>, <code>UUID</code>&#8201;&#8212;&#8201;в <code>VARCHAR(36)</code> и так далее.</p>
</li>
<li>
<p>После нажатия на OK мы получаем DBSchema-проект, ориентированный на Celesta.
В этот момент его можно сохранить в отдельном месте: он больше не привязан к исходной базе данных.
Однако это — некорректный проект, т. к. нет деления на гранулы, гранулам не даны объявления, и в нём ещё много фич, нехарактерных для Celesta.
На этом этапе мы вручную должны создать гранулы (схемы) и разложить по ним таблицы.</p>
</li>
<li>
<p>Если теперь воспользоваться утилитой schemasync.jar, то мы, скорее всего, получим сообщения об ошибках, т. к. проект остаётся некорректным.
Поэтому следует воспользоваться командой Schema&#8594;Generate Schema Script для выгрузки всех таблиц в один sql-файл.
Получившийся скрипт будет очень хорошим приближением к Celesta-скрипту, и вот это приближение уже удобно доделать вручную: убрать использование не поддерживаемых в Celesta функций, раздробить на разные файлы, что-то сделать с названиями длиннее 30 символов и т. д.</p>
</li>
<li>
<p>Настало время пробовать запускать Celesta с вашими скриптами.</p>
</li>
<li>
<p>Если вы дальше желаете использовать DBSchema, то лишь после того, как Celesta "согласится" работать с вашими скриптами, имеет смысл воспользоваться утилитой schemasync.jar для связи с абсолютно пустым проектом DBSchema ("промежуточный" проект DBSchema вы можете удалить).
Это связано с тем, что в schemasync.jar встроен "челестовский" парсер SQL-скриптов, и он не сможет работать с тем, с чем не может работать сама Celesta.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_выгрузка_в_plantuml">6.3.3. Выгрузка в PlantUML</h4>
<div class="paragraph">
<p>При запуске <code>dbschemasync</code> в режиме конвертации из DBSchema в score третья опция командной строки <code>-adoc</code>  параллельно формирует диаграммы в формате <a href="https://plantuml.com">PlantUML</a> для каждой из диаграмм DBSchema.
Имена файлов диаграмм соответствуют названиям листов DBSchema с диаграммами.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-03-16 22:04:32 UTC
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>