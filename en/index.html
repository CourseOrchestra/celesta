<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.20">
<title>Celesta User Manual</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.square{list-style-type:square}
ul.circle ul:not([class]),ul.disc ul:not([class]),ul.square ul:not([class]){list-style:inherit}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:first-child,.sidebarblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child,.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,td.hdlist1,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Celesta User Manual</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_what_is_celesta">What is Celesta?</a>
<ul class="sectlevel2">
<li><a href="#_main_features">Main Features</a></li>
</ul>
</li>
<li><a href="#_part_1_quick_start">1. Part 1. Quick Start</a>
<ul class="sectlevel2">
<li><a href="#_demo">1.1. Demo</a>
<ul class="sectlevel3">
<li><a href="#quick_start_demo">1.1.1. Celesta and Spring Boot</a></li>
<li><a href="#_using_celesta_with_spring_jdbc">1.1.2. Using Celesta with Spring-JDBC</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_part_2_celesta_technical_details_and_setup">2. Part 2. Celesta Technical Details and Setup</a>
<ul class="sectlevel2">
<li><a href="#_key_term_vocabulary">2.1. Key Term Vocabulary</a></li>
<li><a href="#_maven_plugin">2.2. Maven Plugin</a></li>
<li><a href="#_celesta_startup_operations">2.3. Celesta Startup Operations</a>
<ul class="sectlevel3">
<li><a href="#startup_sequence">2.3.1. General Operation Sequence</a></li>
<li><a href="#_automatic_database_migration">2.3.2. Automatic Database Migration</a></li>
<li><a href="#_total_or_partial_disabling_of_automatic_migration">2.3.3. Total or Partial Disabling of Automatic Migration</a></li>
</ul>
</li>
<li><a href="#basic_settings_section">2.4. Basic Settings</a></li>
<li><a href="#system_tables">2.5. System Tables</a>
<ul class="sectlevel3">
<li><a href="#_structure_of_celesta_system_schema">2.5.1. Structure of <code>celesta</code> System Schema</a></li>
<li><a href="#celesta_grains_table">2.5.2. Celesta.grains Table</a></li>
<li><a href="#access_rights_granting">2.5.3. Permissions Management</a></li>
<li><a href="#_logging_system">2.5.4. Logging System</a></li>
<li><a href="#profiling_mode">2.5.5. Profiling System</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_part_3_designing_databases_using_celesta">3. Part 3. Designing Databases Using Celesta</a>
<ul class="sectlevel2">
<li><a href="#CelestaSQL">3.1. CelestaSQL</a>
<ul class="sectlevel3">
<li><a href="#_database_objects_definition_language">3.1.1. Database Objects Definition Language</a></li>
<li><a href="#_comments_in_celestasql">3.1.2. Comments in CelestaSQL</a></li>
<li><a href="#_identifiers_in_celestasql">3.1.3. Identifiers in CelestaSQL</a></li>
<li><a href="#create_schema_statement">3.1.4. CREATE SCHEMA (GRAIN) Statement</a></li>
<li><a href="#create_sequence_statement">3.1.5. CREATE SEQUENCE Statement</a></li>
<li><a href="#create_table_statement">3.1.6. CREATE TABLE Statement</a></li>
<li><a href="#create_index_statement">3.1.7. CREATE INDEX Statement</a></li>
<li><a href="#create_view_statement">3.1.8. CREATE VIEW Statement</a></li>
<li><a href="#create_materialized_view_statement">3.1.9. CREATE MATERIALIZED VIEW Statement</a></li>
<li><a href="#create_function_statement">3.1.10. CREATE FUNCTION Statement</a></li>
</ul>
</li>
<li><a href="#CelestaDoc">3.2. CelestaDoc</a></li>
</ul>
</li>
<li><a href="#_part_4_creating_and_testing_data_access_and_modification_code">4. Part 4. Creating and Testing Data Access and Modification Code</a>
<ul class="sectlevel2">
<li><a href="#celesta_instantiation">4.1. Creating an Instance of Celesta</a>
<ul class="sectlevel3">
<li><a href="#_celesta_createinstance_methods">4.1.1. <code>Celesta.createInstance</code> Methods</a></li>
</ul>
</li>
<li><a href="#_call_context">4.2. Call Context</a>
<ul class="sectlevel3">
<li><a href="#_call_context_creation_and_life_cycle">4.2.1. Call Context Creation and Life Cycle</a></li>
<li><a href="#_call_context_usage">4.2.2. Call Context Usage</a></li>
</ul>
</li>
<li><a href="#data_accessors_section">4.3. Working with Data Using Data Access Classes (Cursors)</a>
<ul class="sectlevel3">
<li><a href="#_access_classes_and_their_standard_methods">4.3.1. Access Classes and Their Standard Methods</a></li>
<li><a href="#setFilter_usage">4.3.2. Usage of a setFilter Method</a></li>
<li><a href="#setIn_usage">4.3.3. Usage of a setIn Method</a></li>
<li><a href="#_sequence_class">4.3.4. Sequence Class</a></li>
<li><a href="#_permissions_management_and_change_logging">4.3.5. Permissions Management and Change Logging</a></li>
<li><a href="#BLOB_fields">4.3.6. BLOB Fields</a></li>
<li><a href="#Option_fields">4.3.7. Option Fields</a></li>
<li><a href="#dynamic_access">4.3.8. Dynamic Access to Data</a></li>
</ul>
</li>
<li><a href="#triggers_section">4.4. Triggers</a></li>
<li><a href="#xrec_section">4.5. xRec Object</a></li>
<li><a href="#Lost_updates_protection">4.6. Lost Updates Prevention</a>
<ul class="sectlevel3">
<li><a href="#_what_are_lost_updates">4.6.1. What are Lost Updates?</a></li>
<li><a href="#_methods_of_preventing_lost_updates">4.6.2. Methods of Preventing Lost Updates</a></li>
<li><a href="#_lost_update_prevention_in_celesta">4.6.3. Lost Update Prevention in Celesta</a></li>
</ul>
</li>
<li><a href="#celestaunit_section">4.7. CelestaUnit</a>
<ul class="sectlevel3">
<li><a href="#_usage_example">4.7.1. Usage Example</a></li>
<li><a href="#_changing_celestaunit_default_settings">4.7.2. Changing CelestaUnit Default Settings</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_part_5_working_with_metadata">5. Part 5. Working with Metadata</a>
<ul class="sectlevel2">
<li><a href="#Celesta_metadata">5.1. Metadata</a>
<ul class="sectlevel3">
<li><a href="#_metadata_and_dynamic_metadata_modification">5.1.1. Metadata and Dynamic Metadata Modification</a></li>
<li><a href="#_score_composition">5.1.2. Score Composition</a></li>
<li><a href="#_score_modification">5.1.3. Score Modification</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#_appendix">6. Appendix</a>
<ul class="sectlevel2">
<li><a href="#best_practices">6.1. Best Practices</a>
<ul class="sectlevel3">
<li><a href="#_close_the_cursors_created_in_the_iteration_explicitly">6.1.1. Close the Cursors Created in the Iteration Explicitly</a></li>
<li><a href="#_avoid_creating_cursors_in_iterations">6.1.2. Avoid Creating Cursors in Iterations</a></li>
<li><a href="#_limit_the_set_of_the_columns_fetched_by_cursor">6.1.3. Limit the Set of the Columns Fetched by Cursor</a></li>
<li><a href="#_methods_not_addressing_the_database_are_fast">6.1.4. Methods not Addressing the Database are Fast</a></li>
<li><a href="#_understand_the_get_method_semantics">6.1.5. Understand the <code>get(&#8230;&#8203;)</code> Method Semantics</a></li>
<li><a href="#_do_not_read_before_deleting_if_not_necessary">6.1.6. Do not Read before Deleting if not Necessary</a></li>
<li><a href="#_do_not_use_count_only_to_determine_if_the_data_range_is_not_empty">6.1.7. Do not Use <code>count()</code> Only to Determine if the Data Range is not Empty</a></li>
<li><a href="#_use_sorting_at_the_database_level_to_find_min_max_values">6.1.8. Use Sorting at the Database Level to Find Min./Max. Values</a></li>
<li><a href="#_use_the_correct_filter_type">6.1.9. Use the Correct Filter Type</a></li>
<li><a href="#_use_indices">6.1.10. Use Indices</a></li>
<li><a href="#_ensure_efficient_caching_when_working_in_iterations">6.1.11. Ensure Efficient Caching when Working in Iterations</a></li>
<li><a href="#_do_not_use_try_methods_unless_necessary">6.1.12. Do not Use <code>try</code> Methods Unless Necessary</a></li>
<li><a href="#_use_iteration_instead_of_navigation_in_cycles">6.1.13. Use Iteration instead of Navigation in Cycles</a></li>
</ul>
</li>
<li><a href="#RDBMS_peculiarities">6.2. Notes on Using Supported RDBMS in Celesta</a>
<ul class="sectlevel3">
<li><a href="#_ms_sql_server">6.2.1. MS SQL Server</a></li>
<li><a href="#_oracle">6.2.2. Oracle</a></li>
<li><a href="#_postgresql">6.2.3. PostgreSQL</a></li>
<li><a href="#_firebird">6.2.4. Firebird</a></li>
<li><a href="#_h2">6.2.5. H2</a></li>
</ul>
</li>
<li><a href="#DBSchema">6.3. Celesta Database Design in DBSchema</a>
<ul class="sectlevel3">
<li><a href="#_synchronyzing_celesta_score_and_dbschema_project">6.3.1. Synchronyzing Celesta Score and DBSchema Project</a></li>
<li><a href="#_creating_celestasql_scripts_based_on_the_structure_of_an_existing_database">6.3.2. Creating CelestaSQL Scripts Based on the Structure of an Existing Database</a></li>
<li><a href="#_export_to_plantuml">6.3.3. Export to PlantUML</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_what_is_celesta">What is Celesta?</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://github.com/CourseOrchestra/celesta">Celesta</a> is a tool for Java backend developers who want easier ways to deliver RDBMS-backed software.</p>
</div>
<div class="paragraph">
<p>This is a Java library with a Maven plugin that provides database migrations, ORM and testing.</p>
</div>
<div class="paragraph">
<p>Unlike, for instance, Hibernate + Liquibase, Celesta does not require one to keep in mind the schema design and migrations separately, and provides a fast and lightweight way to unit-test the code that works with the database.</p>
</div>
<div class="paragraph">
<p>It can be used by adding a <a href="https://search.maven.org/search?q=a:celesta-parent">Maven dependency</a> to your project, and it also has its own <a href="https://github.com/CourseOrchestra/spring-boot-starter-celesta">Spring Boot starter</a>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/640px-Duke2-2.png" alt="640px Duke2 2" width="300">
</div>
</div>
<div class="sect2">
<h3 id="_main_features">Main Features</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Independence from database type.</strong> Solutions created in Celesta can be transferred between all supported databases without losing functionality.
We support the following types of RDBMS and try to do it in the most transparent manner possible (the list is not final):</p>
<div class="ulist">
<ul>
<li>
<p>MS SQL Server;</p>
</li>
<li>
<p>Oracle;</p>
</li>
<li>
<p>Postgre SQL;</p>
</li>
<li>
<p>H2;</p>
</li>
<li>
<p>Firebird (beta).</p>
</li>
</ul>
</div>
</li>
<li>
<p><strong>Database-first data structure design.</strong> Celesta is used to design tables, views and connections between them first instead of classes, which are generated automatically.</p>
</li>
<li>
<p><strong>Database structure automatic migration</strong> based on <a href="https://dzone.com/articles/trouble-free-database-migration-idempotence-and-co">idempotent DDL</a>.</p>
</li>
<li>
<p>Simplified <strong>unit testing</strong>: quick tests of code that interacts with the database, based on H2 database in-memory operation mode.</p>
</li>
<li>
<p>Automatically generated intermediary access layer for tables to create business logic based on the database structure.</p>
</li>
<li>
<p>Application interaction with an existing database (application integration via database).</p>
</li>
<li>
<p>Permissions management.</p>
</li>
<li>
<p>Data changes auditing.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_1_quick_start">1. Part 1. Quick Start</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_demo">1.1. Demo</h3>
<div class="sect3">
<h4 id="quick_start_demo">1.1.1. Celesta and Spring Boot</h4>
<div class="paragraph">
<p>Demo project illustrating Celesta capabilities for Spring Boot is available at: <a href="https://github.com/inponomarev/celesta-demo/" class="bare">https://github.com/inponomarev/celesta-demo/</a>.</p>
</div>
<div class="paragraph">
<p>To create a Spring Boot project use the following Maven dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    &lt;properties&gt;
       &lt;!-- Check for the latest version of ru.curs:spring-boot-starter-web at Maven Central --&gt;
       &lt;spring.boot.starter.celesta.version&gt;3.0.0&lt;/spring.boot.starter.celesta.version&gt;
       &lt;!-- Check for the latest version of ru.curs:celesta-parent at Maven Central --&gt;
       &lt;celesta.version&gt;8.0.1&lt;/celesta.version&gt;
    &lt;/properties&gt;

. . .
    &lt;dependencies&gt;
        &lt;dependency&gt;
            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;
        &lt;/dependency&gt;

        &lt;dependency&gt;
            &lt;groupId&gt;ru.curs&lt;/groupId&gt;
            &lt;!-- Own Spring Boot starter simplifies Celesta configuration in Spring Boot applications --&gt;
            &lt;artifactId&gt;spring-boot-starter-celesta&lt;/artifactId&gt;
            &lt;version&gt;${spring.boot.starter.celesta.version}&lt;/version&gt;
            &lt;!-- Exclude dependency on Celesta, specified in Celesta spring boot starter
                 to enter a more recent Celesta version number --&gt;
            &lt;exclusions&gt;
                &lt;exclusion&gt;
                    &lt;groupId&gt;ru.curs&lt;/groupId&gt;
                    &lt;artifactId&gt;celesta-system-services&lt;/artifactId&gt;
                &lt;/exclusion&gt;
            &lt;/exclusions&gt;
        &lt;/dependency&gt;
        &lt;dependency&gt;
            &lt;!-- Connect a more recent version of Celesta than Spring Boot Starter propose--&gt;
            &lt;groupId&gt;ru.curs&lt;/groupId&gt;
            &lt;artifactId&gt;celesta-system-services&lt;/artifactId&gt;
            &lt;version&gt;${celesta.version}&lt;/version&gt;
        &lt;/dependency&gt;
    ...
    &lt;/dependencies&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>ru.curs:celesta-maven-plugin</code> is used to generate the code of <a href="#data_accessors_section">data access classes</a>.
Specify the path to the <code>score</code> folder in its settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">    &lt;build&gt;
        &lt;plugins&gt;
            &lt;plugin&gt;
                &lt;groupId&gt;ru.curs&lt;/groupId&gt;
                &lt;artifactId&gt;celesta-maven-plugin&lt;/artifactId&gt;
                &lt;version&gt;${celesta.version}&lt;/version&gt;

                &lt;executions&gt;
                    &lt;execution&gt;
                        &lt;goals&gt;
                            &lt;goal&gt;gen-cursors&lt;/goal&gt;
                            &lt;goal&gt;gen-score-resources&lt;/goal&gt;
                            &lt;goal&gt;gen-test-cursors&lt;/goal&gt;
                            &lt;goal&gt;gen-test-score-resources&lt;/goal&gt;
                        &lt;/goals&gt;
                    &lt;/execution&gt;
                &lt;/executions&gt;
            &lt;/plugin&gt;
        &lt;/plugins&gt;
    &lt;/build&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Add database definition scripts in <a href="#CelestaSQL">CelestaSQL</a> language to the <code>src/main/celestasql</code> folder.
For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">-- celestasql/ru/curs/demo/demo.sql
CREATE SCHEMA demo VERSION '1.0';

/**Order header*/
CREATE TABLE OrderHeader(
  id VARCHAR(30) NOT NULL,
  date DATETIME,
  customer_id VARCHAR(30),

  /**Costumer name */
  customer_name VARCHAR(50),
  manager_id VARCHAR(30),
  CONSTRAINT Pk_OrderHeader PRIMARY KEY (id)
);

/**Order line*/
CREATE TABLE OrderLine(
  order_id VARCHAR(30) NOT NULL,
  line_no INT NOT NULL,
  item_id VARCHAR(30) NOT NULL,
  item_name VARCHAR(100),
  qty INT NOT NULL DEFAULT 0,
  cost REAL NOT NULL DEFAULT 0.0,
  CONSTRAINT Idx_OrderLine PRIMARY KEY (order_id, line_no)
);

ALTER TABLE OrderLine ADD CONSTRAINT fk_OrderLine FOREIGN KEY (order_id) REFERENCES OrderHeader(id);
create materialized view OrderedQty as
select item_id, sum(qty) as qty from OrderLine group by item_id;</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>mvn verify</code> command generates <code>OrderHeaderCursor.java</code>
 and <code>OrderLineCursor.java</code> files with <a href="#data_accessors_section">cursor classes</a> in the <code>target/generated-sources/celesta/&#8230;&#8203;</code> folder.</p>
</div>
<div class="paragraph">
<p>Those classes can be used to create services (see the more comprehensive <a href="https://github.com/inponomarev/celesta-demo/blob/master/src/main/java/ru/curs/demo/service/DocumentService.java#L17">demo</a>):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Service
public class DocumentService {
    @CelestaTransaction
    public void postOrder(CallContext context, OrderDto doc) {
        try (OrderHeaderCursor header = new OrderHeaderCursor(context);
             OrderLineCursor line = new OrderLineCursor(context)) {
             . . .
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-properties-and-configuration.html">method available in Spring Boot</a> can be used to configure your project&#8217;s <a href="#basic_settings_section">settings</a>, including the <a href="https://github.com/inponomarev/celesta-demo/blob/master/src/main/resources/application.yml">application.yml</a> file.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_celesta_with_spring_jdbc">1.1.2. Using Celesta with Spring-JDBC</h4>
<div class="paragraph">
<p>Celesta utilizes its own built-in JDBC connection pool if no other option is provided.
If you want to configure a specific connection pool, or if you want to utilize the <a href="https://docs.oracle.com/javase/8/docs/api/javax/sql/DataSource.html"><code>DataSource</code></a> provided by the Spring framework, you can do so.</p>
</div>
<div class="paragraph">
<p>In standalone application you can use <a href="#celesta_instantiation"><code>Celesta.createInstance</code></a> method providing a <code>DataSource</code> in its parameter.</p>
</div>
<div class="paragraph">
<p><code>spring-boot-starter-celesta</code> will utilize a <code>DataSorce</code> when it is provided by Spring.</p>
</div>
<div class="paragraph">
<p>For example, if you add the following dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
    &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>and the following configuration parameters to <code>application.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">spring:
  datasource:
    url: jdbc:postgresql://&lt;DATABASE&gt;
    username: &lt;USER&gt;
    password: &lt;PWD&gt;
    hikari:
      auto-commit: false
celesta:
  jdbc:
    url: jdbc:postgresql</code></pre>
</div>
</div>
<div class="paragraph">
<p>Celesta will run with <a href="https://github.com/brettwooldridge/HikariCP">Hikari Connection Pool</a> provided by Spring. Please note the following:</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>The connection pool must be configured to return connections with <code>autoCommit</code> set to <code>false</code>.</p>
</li>
<li>
<p>You still have to provide <code>celesta.jdbc.url</code> in order for Celesta to determine the type of the database, but since this parameter will not be used for connection to the database, it&#8217;s enough to provide only the prefix, like <code>jdbc:postgresql</code>, <code>jdbc:sqlserver</code> etc.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_2_celesta_technical_details_and_setup">2. Part 2. Celesta Technical Details and Setup</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_key_term_vocabulary">2.1. Key Term Vocabulary</h3>
<div id="celesta_vocabulary" class="dlist">
<dl>
<dt class="hdlist1">Score</dt>
<dd>
<p>Entirety of database schemas used in the given instance of Celesta, presented as <a href="#CelestaSQL">CelestaSQL</a> scripts.</p>
</dd>
<dt class="hdlist1"><a href="#CelestaSQL">CelestaSQL</a> script</dt>
<dd>
<p>A text file defining the following:</p>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>database schemas.
Note: due to historical reasons, "schema" in Celesta is synonym to "grain";</p>
</li>
<li>
<p>tables, including information on</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>fields and their types (a set of data types available in Celesta is selected in order to provide compatibility with all the supported databases);</p>
</li>
<li>
<p>table primary key  it is necessary for operation of <a href="#data_accessors_section">data access classes</a>;</p>
</li>
<li>
<p><code>DEFAULT</code> field values;</p>
</li>
<li>
<p><code>NOT NULL</code> field restrictions;</p>
</li>
</ol>
</div>
</li>
<li>
<p>indices;</p>
</li>
<li>
<p>sequences;</p>
</li>
<li>
<p>foreign keys;</p>
</li>
<li>
<p>views, including materialized views and functions.</p>
</li>
</ol>
</div>
</dd>
</dl>
</div>
<div class="paragraph">
<p>As a result of <a href="#maven_plugin_section">Celesta Maven Plugin</a> work, the data access classes are generated on the basis of these scripts and SQL files themselves are copied to the resources of the compiled .jar files.</p>
</div>
<div class="paragraph">
<p>During its startup, Celesta automatically migrates the database structure to the state defined by the CelestaSQL scripts.</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Schema version tag</dt>
<dd>
<p>A version identifier in the form of a list of components separated with commas, explicitly provided by the developer in the <a href="#version_tags"><code>CREATE GRAIN &#8230;&#8203; VERSION &#8230;&#8203;</code></a> command.
It prevents unintentional automatic database downgrade at the launch of an older version of CelestaSQL with a newer version database.
Automatic database migration never takes place if the database version tag is higher than the grain script version tag or the versions do not align.</p>
</dd>
<dt class="hdlist1">Grain checksum</dt>
<dd>
<p>An automatically calculated script checksum.
Helps to differentiate CelestaSQL scripts by their contents.
CelestaSQL scripts with identical version tags might intentionally (during development) or unintentionally (due to developer&#8217;s carelessness) have different contents.
Database created automatically using CelestaSQL script not only has a version tag, but also contains a grain creation script checksum to give an opportunity to track the moment it was connected by an application with an altered database definition script.
Simultaneous match of a version tag and a grain checksum is enough to continue operation without trying to upgrade the database structure. To simplify verification and ensure the algorithm transparency, the checksum consists of two values: the script file length (written down as a decimal integer) and its <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check#CRC-32_algorithm">CRC32</a> (written down as eight hexadecimal integers).</p>
</dd>
<dt class="hdlist1">Celesta system grain</dt>
<dd>
<p>A special grain with an unchangeable table structure.
This grain&#8217;s tables are used for the system&#8217;s internal needs.
At the same time, recording and editing the data in some of these tables are standard procedures during system configuration.
See the "celesta" grain description in the <a href="#system_tables">System Tables</a> section.</p>
</dd>
<dt class="hdlist1">Celesta.grains table</dt>
<dd>
<p>The main system table of the database.
Existence of the table indicates that Celesta is connected to the corresponding database, otherwise it will try to create one from scratch.
The table contains information on state of grains in the database.
Field description can be found in the <a href="#celesta_grains_table">Celesta System Tables</a> section.
Information from this table is used extensively during <a href="#startup_sequence">startup sequence</a>.</p>
</dd>
<dt class="hdlist1">Grain startup sequence</dt>
<dd>
<p><a href="#startup_sequence">Sequences</a> executed by Celesta for every grain on startup.
The database migrates automatically if necessary and possible.</p>
</dd>
<dt class="hdlist1">Automatic database migration</dt>
<dd>
<p>Part of the startup sequence, which involves comparing the existing database structure to Celesta score set by grain creation scripts.
After comparison, the differences are eliminated with automatically created and executed CREATE/ALTER SQL commands.</p>
</dd>
<dt class="hdlist1">Data access class (cursor)</dt>
<dd>
<p>A class generated automatically on the basis of CelestaSQL script and used for interaction with table, view and sequence data.</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_maven_plugin">2.2. Maven Plugin</h3>
<div id="maven_plugin_section" class="paragraph">
<p>Celesta Maven plugin generates the code of data access classes on the basis of CelestaSQL scripts.
Adding this plugin is mandatory for projects using Celesta.</p>
</div>
<div class="paragraph">
<p>Usage example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;plugin&gt;
    &lt;groupId&gt;ru.curs&lt;/groupId&gt;
    &lt;artifactId&gt;celesta-maven-plugin&lt;/artifactId&gt;
    &lt;version&gt;${celesta.version}&lt;/version&gt;
    &lt;configuration&gt;
        &lt;scores&gt;
            &lt;score&gt;. . .&lt;/score&gt;
        &lt;/scores&gt;
        &lt;testScores&gt;
            &lt;testScore&gt;. . .&lt;/testScore&gt;
        &lt;/testScores&gt;
        &lt;!-- unnecessary, true by default --&gt;
        &lt;snakeToCamel&gt;true&lt;/snakeToCamel&gt;
    &lt;/configuration&gt;
    &lt;executions&gt;
        &lt;execution&gt;
            &lt;goals&gt;
                &lt;goal&gt;gen-cursors&lt;/goal&gt;
                &lt;goal&gt;gen-score-resources&lt;/goal&gt;
                &lt;goal&gt;gen-test-cursors&lt;/goal&gt;
                &lt;goal&gt;gen-test-score-resources&lt;/goal&gt;
            &lt;/goals&gt;
        &lt;/execution&gt;
    &lt;/executions&gt;
&lt;/plugin&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Plugin configuration settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>scores</code>  path to the project folders containing <a href="#CelestaSQL">CelestaSQL</a> scripts describing the working database.
By default the path is <code>src/main/celestasql</code>.</p>
</li>
<li>
<p><code>testScores</code>  path to the project folders containing <a href="#CelestaSQL">CelestaSQL</a> scripts describing the database, used only for <a href="#celestaunit_section">unit testing</a>.
By default the path is <code>src/test/celestasql</code>.</p>
</li>
<li>
<p><code>snakeToCamel</code> (boolean, true by default)  whether tables and fields named in "snake_case" in CelestaSQL should be transformed to "CamelCase" in <a href="#data_accessors_section">data access classes</a> in order to meet naming conventions in Java.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Celesta Maven Plugin executes the following operations:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Generates code for <a href="#data_accessors_section">cursors</a> based on <a href="#CelestaSQL">CelestaSQL</a>:</p>
<div class="ulist">
<ul>
<li>
<p>During the <code>generate-sources</code> phase the cursors are generated from <code>scores</code> and optionally <code>score</code> folder to <code>target/generated-sources/celesta</code>;</p>
</li>
<li>
<p>During the <code>generate-test-sources</code> phase  from <code>testScores</code> to <code>target/generated-test-sources/celesta</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Copies CelestaSQL files to resources:</p>
<div class="ulist">
<ul>
<li>
<p>During the <code>generate-resources</code> phase CelestaSQL files are copied from <code>scores</code> and optionally the <code>score</code> folder to <code>generated-resources/score</code>;</p>
</li>
<li>
<p>During the <code>generate-test-resources</code> phase  from <code>testScores</code> to <code>generated-test-resources/score</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Generates the <code>score.files</code> index containing the list of relative paths to .sql files in resources:</p>
<div class="ulist">
<ul>
<li>
<p>During the <code>generate-resources</code> phase  to <code>generated-resources/score/score.files</code>;</p>
</li>
<li>
<p>During the <code>generate-test-resources</code> phase  to <code>generated-test-resources/score/score.files</code>.</p>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>These files are used when running Celesta to find paths to all CelestaSQL files in .jar files on classpath.</p>
</div>
</div>
<div class="sect2">
<h3 id="_celesta_startup_operations">2.3. Celesta Startup Operations</h3>
<div class="sect3">
<h4 id="startup_sequence">2.3.1. General Operation Sequence</h4>
<div class="paragraph">
<p>Celesta initialization goes in several stages, which is illustrated by the log output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">Celesta ver. 7.2.4
Celesta pre-initialization: system settings reading...
done.
Celesta initialization: score parsing...
done.
Celesta initialization: database upgrade...
done.</code></pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>During <strong>system settings reading</strong> Celesta analyses the <a href="#basic_settings_section">setting configuration</a>  state, checks if all mandatory settings are set and configured correctly.
If any errors are found the startup interrupts.</p>
</li>
<li>
<p>During <strong>score parsing</strong> all available *.sql files are read, their syntax is analysed and an internal database object model (score) is created.
The system collects information about grains, tables and fields from CelestaSQL scripts.
Checksums are calculated and versions are determined.
If syntax errors occur or CelestaSQL scripts are not consistent, the system startup halts at this stage.</p>
</li>
<li>
<p><strong>Automatic database migration</strong>.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_automatic_database_migration">2.3.2. Automatic Database Migration</h4>
<div class="paragraph">
<p>At this stage the application server connects to the database and checks the existence of the <code>celesta.grains</code> system table.
If the table does not exist, it is created automatically (via <code>CREATE</code> command), but only in the following cases: 1) the database is completely empty; 2) <code>force.dbinitialize</code> parameter is set (to prevent "corruption" of existing non-empty databases if Celesta connects to them by mistake).
If an error occurs during celesta.grains table existence check / creation, a fatal error is generated and the system does not launch.</p>
</div>
<div class="sect4">
<h5 id="_determining_if_the_automatic_migration_is_needed_for_a_grain_schema">Determining if the Automatic Migration is Needed for a Grain (Schema)</h5>
<div class="paragraph">
<p>Next the process repeats for all grains (schemas) available in the score and all grains available in <code>celesta.grains</code> (this excludes grains, declared with <code>WITH NO AUTOUPDATE</code> option in CelestaSQL script).</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the grain exists in the score but not in <code>celesta.grains</code>, upgrade is executed by a CelestaSQL script (it is assumed that the corresponding tables may already exist in the database).</p>
</li>
<li>
<p>If the grain exists in <code>celesta.grains</code> but not in the score, nothing happens.
Grains are never deleted from the database automatically as their tables may contain important information.
Instead, the data access classes are not created for such tables.</p>
</li>
<li>
<p>If the grain exists both in <code>celesta.grains</code> and the score, Celesta looks up the corresponding entry in <code>celesta.grains</code> for the state, version, and checksum of the grain that was installed during the latest migration.
Then Celesta compares this information to the current grain version and checksum.
The grain state recorded in <code>celesta.grains</code> table may have one of the following values:</p>
<div class="ulist">
<ul>
<li>
<p><strong>recover (3)</strong>  proceed as if no entry exists (see p. 1);</p>
</li>
<li>
<p><strong>lock (4)</strong>  the structure of the current grain should not be upgraded, go to the next grain;</p>
</li>
<li>
<p><strong>upgrading (1)</strong> or <strong>error (2)</strong>  the process interrupts with an error prompt  Cannot proceed with the database upgrade: there are grains not in 'ready', 'recover' or 'lock' state;</p>
</li>
<li>
<p><strong>ready (0)</strong>  continue the process.</p>
<div class="olist lowerroman">
<ol class="lowerroman" type="i">
<li>
<p>If versions and checksums of the current and the previously installed grains match, nothing happens.
System assumes that the structure of the corresponding database schema is consistent with the current CelestaSQL script and reduces the time necessary to analyse the existing structure.</p>
</li>
<li>
<p>If versions and checksums do not match: if the version is higher, upgrade is carried out regardless of the checksum.
If it is lower or the version is incompatible (see the version tags <a href="#version_tags">operation logic description</a>), the launch interrupts with an error prompt Grain '&#8230;&#8203;' version '&#8230;&#8203;' is lower than / is inconsistent with database grain version '&#8230;&#8203;' . Will not proceed with auto-upgrade. regardless of the checksum.</p>
</li>
<li>
<p>If versions match but the checksum does not, the score is upgraded.</p>
</li>
</ol>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
</div>
<div class="sect4">
<h5 id="_grain_schema_migration_procedure">Grain (Schema) Migration Procedure</h5>
<div class="paragraph">
<p>If the algorithm leads the system to require a grain upgrade, the database structure and the data structure described in the CelestaSQL script start to synchronize.
All missing objects are created  tables, fields, keys, indices, views, etc.
Objects in need of alteration (e.g. field data types, field composition in the index or SQL view requests) are altered.
The system makes effort to have it done automatically and without any errors.
Sometimes it is possible in every scenario (e.g. when a SQL query of a view is changed or a field set of an index is changed), sometimes manual intervention and executing an <em>ad hoc</em> script are unavoidable (see the <a href="https://dzone.com/articles/trouble-free-database-migration-idempotence-and-co">post</a> on idempotent migrations).
Errors at this stage lead to grain transition to an <strong>error</strong> state and demand manual intervention by a database administrator.</p>
</div>
<div class="paragraph">
<p>If an object is deleted from the CelestaSQL script, auto-migrator removes from the database only the stateless objects  (i.e. tables and fields are not auto-deleted and can be deleted manually in an <em>ad hoc</em> migration script, external keys are deleted from the deleted fields) to prevent data lose.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_total_or_partial_disabling_of_automatic_migration">2.3.3. Total or Partial Disabling of Automatic Migration</h4>
<div class="paragraph">
<p>Celesta features several methods to disable automatic migration:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>at the level of the entire database</strong>  using <code>skip.dbupdate</code> option in the <a href="#basic_settings_section">settings</a>;</p>
</li>
<li>
<p><strong>at the schema level</strong>  by setting its state in the <a href="#celesta_grains_table">celesta.grains table</a> to 4 or by declaring the <code>WITH NO AUTOUPDATE</code> option in the <a href="#create_schema_statement">grain (schema) creation statement</a>;</p>
</li>
<li>
<p><strong>at the table level</strong>  by declaring the <a href="#celestasql_with_options"><code>WITH NO AUTOUPDATE</code> option</a> in the table creation statement.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="basic_settings_section">2.4. Basic Settings</h3>
<div class="paragraph">
<p>Celesta configuration parameters include general system parameters such as database connection properties.</p>
</div>
<div class="paragraph">
<p>These settings are passed to a  <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/BaseAppSettings.html"><code>BaseAppSettings</code></a> constructor as a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Properties.html"><code>Properties</code></a> instance, and the <code>BaseAppSettings</code> instance, in turn, is a <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/Celesta.html"><code>Celesta</code></a> constructor parameter.</p>
</div>
<div class="paragraph">
<p>When using <a href="https://github.com/CourseOrchestra/spring-boot-starter-celesta">Celesta Spring Boot starter</a>
these settings are defined by any Spring Boot application <a href="https://docs.spring.io/spring-boot/docs/current/reference/html/howto-properties-and-configuration.html">configuration method</a> available, for example, using an
<code>application.yml</code> file.
In that case, the YAML file root key has to be <code>celesta</code>, and other properties are recorded in the hierarchical structure.</p>
</div>
<div class="paragraph">
<p>For example, to set the properties of <code>jdbc.url</code>, <code>jdbc.username</code> and <code>jdbc.password</code> the <code>application.yml</code> file structure must be the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">celesta:
  jdbc:
    url: jdbc:postgresql://127.0.0.1:5432/celesta
    # url: jdbc:sqlserver://172.16.1.114:52836;databaseName=celesta
    # url: jdbc:oracle:thin:192.168.110.128:1521:XE
    username: foo
    password: bar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some IDE, like IntelliJ IDEA, provide auto-completion when editing the <code>application.yml</code> file.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 30%;">
<col style="width: 40%;">
<col style="width: 20%;">
<col style="width: 10%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Parameter</th>
<th class="tableblock halign-center valign-middle">Purpose</th>
<th class="tableblock halign-center valign-middle">Mandatory</th>
<th class="tableblock halign-center valign-middle">Default value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>rdbms.connection.url</code></p>
</div>
<div class="paragraph">
<p>(<code>jdbc.url</code> in <code>application.yml</code>)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>JDBC connection URL</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>Yes</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>-</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>rdbms.connection.username</code></p>
</div>
<div class="paragraph">
<p>(<code>jdbc.username</code> in <code>application.yml</code>)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Database login</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>No (if empty, the JDBC URL is used)</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>-</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>rdbms.connection.password</code></p>
</div>
<div class="paragraph">
<p>(<code>jdbc.password</code> in <code>application.yml</code>)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Database password</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>No (if empty, the JDBC URL is used)</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>-</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>skip.dbupdate</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Forces the system to completely skip the database upgrade phase (including creating the system tables) on startup .</p>
</div>
<div class="paragraph">
<p>This parameter is required in some scenarios of deploying Celesta over an existing database.</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>No</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>force.dbinitialize</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Forces the system to create Celesta system object even if the database is non-empty (contains tables) on startup.
Caution is advised when using this parameter because it may damage the existing database.</p>
</div>
<div class="paragraph">
<p>This parameter is required in some scenarios of deploying Celesta over an existing database.</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>No</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>h2.in-memory</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>true</code> value forces Celesta to use an H2 database in in-memory mode.
JDBC connection parameters are ignored.
The mode is used mostly for automatic testing.</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>No</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>h2.port</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>When the value is an integer and <code>h2.in-memory</code> is set to <code>true</code>, the H2 database launches as a server at the specified port.
This mode allows external applications to connect to the H2 database and read and modify the data.
JDBC connection parameters are ignored.
The mode is used mostly for UI and acceptance automatic testing.</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>No</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>h2.referential.integrity</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Defines the use of the foreign keys referential integrity checks, when working with an H2 database in in-memory mode (for all other databases this parameter is ignored).
By default the referential integrity checks are disabled when working with an H2 database in in-memory mode to simplify autotest creation.</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p>No</p>
</div></div></td>
<td class="tableblock halign-center valign-top"><div class="content"><div class="paragraph">
<p><code>false</code></p>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect2">
<h3 id="system_tables">2.5. System Tables</h3>
<div class="sect3">
<h4 id="_structure_of_celesta_system_schema">2.5.1. Structure of <code>celesta</code> System Schema</h4>
<div class="paragraph">
<p>Celesta system adds to the database not only user-defined tables and schemas, but also tables in its own <code>celesta</code> system schema, the structure of which is presented in a diagram below.</p>
</div>
<div class="paragraph">
<p>The structure (including the fields) of the Celesta system grain tables is unchangeable and access to data in them is provided by built-in <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/syscursors/package-summary.html">ru.curs.celesta.syscursors</a> package classes.
At the same time, changing data in these tables is part of standard system configuration.</p>
</div>
<div class="paragraph">
<p>System tables are used to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>coordinate automatic migration (<code>grains</code> table);</p>
</li>
<li>
<p>manage the access permissions to tables and views (<code>permissions</code>, <code>roles</code>, <code>userroles</code>);</p>
</li>
<li>
<p>configure the logging system (<code>logsetup</code>) and log storage (<code>log</code>, <code>calllog</code>).</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="systemtables.png" alt="systemtables" width="975" height="668">
</div>
</div>
<div class="paragraph">
<p>Purpose of tables:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">celesta.grains</dt>
<dd>
<p>List of grains including states.
Managed automatically, manual changes by the solution developer are limited to setting the "recover" state to grains after failed attempts to upgrade automatically and deleting entries related to deleted grains.</p>
</dd>
<dt class="hdlist1">celesta.tables</dt>
<dd>
<p>List of tables and views.
Contents of this table automatically synchronize with the list of tables and views available in Celesta grains, the user should not interfere with the data in this table (the changes will be lost during the next synchronization anyway).
Table type field indicates whether the entry is a table ("T") or a view ("V").</p>
</dd>
<dt class="hdlist1">celesta.roles</dt>
<dd>
<p>List of celesta roles.
Roles are added here and roles with system names "reader", "editor", etc. are stored here (see the <a href="#access_rights_granting">Permissions Management</a> section for more information on roles with system names).</p>
</dd>
<dt class="hdlist1">celesta.userroles</dt>
<dd>
<p>Connections between user IDs (logins) and roles.
Filled in by the administrator.</p>
</dd>
<dt class="hdlist1">celesta.permissions</dt>
<dd>
<p>Permissions for roles to work with tables.
Filled in by the administrator.</p>
</dd>
<dt class="hdlist1">celesta.logsetup</dt>
<dd>
<p>Logging setup.
Filled in by the administrator.</p>
</dd>
<dt class="hdlist1">celesta.log</dt>
<dd>
<p>Changelog.
New entries are automatically appended by the system each time the data is changed, but only for tables and actions specified in <code>celesta.logsetup</code>.</p>
</dd>
<dt class="hdlist1">celesta.calllog</dt>
<dd>
<p>Method calls log.
Records are made by the system while in <a href="#profiling_mode">profiling mode</a>.</p>
</dd>
</dl>
</div>
</div>
<div class="sect3">
<h4 id="celesta_grains_table">2.5.2. Celesta.grains Table</h4>
<div class="paragraph">
<p>This table is the vital Celesta system table as its contents manage the database structure synchronization with the score at the system&#8217;s launch.
It contains the following fields:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 66.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Field name</th>
<th class="tableblock halign-center valign-middle">Field type</th>
<th class="tableblock halign-center valign-middle">Field value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(30)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">grain ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(2000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">grain version tag</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>length</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">grain CelestaSQL script length in bytes</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>checksum</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(8)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">grain CelestaSQL script CRC32</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>state</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INT</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>grain state:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0  <strong>ready</strong>  the grain is deployed and ready (its version tag and checksum are entered in <code>version</code>, <code>length</code> and <code>checksum</code> fields).</p>
</li>
<li>
<p>1  <strong>upgrading</strong>  the grain is being created or upgraded by other Celesta applications connected to the database.</p>
</li>
<li>
<p>2  <strong>error</strong>  the latest autoupgrade attempt failed, the <code>message</code> field contains the error message.</p>
</li>
<li>
<p>3  <strong>recover</strong> (similar to absence of an entry in the <code>grains</code> table when the grain exists in the <code>score</code> folder)  the grain is missing or needs regeneration (for example, after an upgrade error).</p>
</li>
<li>
<p>4  <strong>lock</strong>  the grain does not need the structure autoupgrade under any circumstances.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lastmodified</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DATETIME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">date and time of the latest grain modification</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>message</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TEXT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">comment (for example, notification about an error during the latest failed autoupgrade)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="access_rights_granting">2.5.3. Permissions Management</h4>
<div class="paragraph">
<p>As the table structure shows, table access rights are granted to roles and are not meant to be directly granted to users.</p>
</div>
<div class="paragraph">
<p>The <code>roleid</code> field contains the role identifier and <code>grainid</code> and <code>tablename</code> fields contain references to the tables.
Flags are set in bit fields "r", "i", "m" and "d" if the rights are needed for reading, insertion, modification or deletion respectively.</p>
</div>
<div class="paragraph">
<p>Special system role names are available: <strong>reader</strong> and <strong>editor</strong>, as well as <strong>&lt;grain ID&gt;.reader</strong> and <strong>&lt;grain ID&gt;.editor</strong>.</p>
</div>
<div class="paragraph">
<p>The <strong>reader</strong> role grants the right to read all tables without any exceptions, the <strong>&lt;grain ID&gt;.reader</strong> (for example, "foo.reader") grants the right to read all tables in the respective grain.</p>
</div>
<div class="paragraph">
<p>The <strong>editor</strong> role grants full rights (to read, insert, modify and delete) to all tables.
The <strong>&lt;grain ID&gt;.editor</strong> role (for example, "foo.editor") grants full rights to all tables in the respective grain.</p>
</div>
</div>
<div class="sect3">
<h4 id="_logging_system">2.5.4. Logging System</h4>
<div class="paragraph">
<p>Not only the access rights granting system is involved in any data modification via Celesta cursors, but also a modification logging system, which logs all changes to the <strong>celesta.log</strong> tables.
In order to prevent the <strong>celesta.log</strong> table from being littered with potentially huge amounts of unnecessary data, the changes are logged only in the tables explicitly specified in the <strong>celesta.logsetup</strong> table.
There is also an option to separately enable logging of entry insertions, modifications and deletions.</p>
</div>
<div class="paragraph">
<p>In order to enable logging data changes made via Celesta system, it is necessary to enter the relevant settings in the  <strong>celesta.logsetup</strong> table.
The "grainid" and "tablename" fields should contain a link to the table and flags are set in bit fields "i", "m" and "d" if it is needed to log insertion, modification and deletion respectively.</p>
</div>
<div class="paragraph">
<p>The <code>celesta.log</code> table consists of the following fields:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 66.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Field ID</th>
<th class="tableblock halign-center valign-middle">Field type</th>
<th class="tableblock halign-center valign-middle">Field value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entryno</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">autoincremented integer entry number in the log table</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entry_time</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DATETIME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">entry time</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>userid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(250)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID of the user making the change</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sessionid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(250)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID of the session during which the change is made</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>grainid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(30)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">grain ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tablename</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(30)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">table name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>action_type</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(1)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">action type ("I" for insertion, "M" for modification and "D" for deletion)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pkvalue1</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(100)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">primary key first field value (if any, cast to the text type)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pkvalue2</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(100)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">primary key second field value (if any, cast to the text type)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>pkvalue3</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(100)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">primary key third field value (if any, cast to the text type)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>oldvalues</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(2000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">old entry state (the fields are cast to the text type, the list is separated with commas in CSV format and the information is cropped to match the length of the field.
Values are filled in for "M" and "D" actions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>newvalues</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(2000)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">current entry state in the same format as the <code>oldvalues</code> field.
Filled in for "M" and "I" actions</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="profiling_mode">2.5.5. Profiling System</h4>
<div class="paragraph">
<p>Celesta can operate in a profiling mode for troubleshooting, which is enabled by a <code>setProfilemode(true)</code> mode of a  <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/Celesta.html"><code>Celesta</code></a> instance.</p>
</div>
<div class="paragraph">
<p>Information on all procedure calls in a profiling mode is entered in a calllog table consisting of the following fields:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 66.6668%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Field name</th>
<th class="tableblock halign-center valign-middle">Field type</th>
<th class="tableblock halign-center valign-middle">Field value</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>entryno</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">autoincremented integer entry number in the log table</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>sessionid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(250)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID of the session during which the change is made</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>userid</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(250)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ID of the user initiating the user session</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>procname</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>VARCHAR(250)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">executed procedure name</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>starttime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DATETIME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">procedure execution start time</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>duration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>INT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">total procedure execution duration (in milliseconds)</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_3_designing_databases_using_celesta">3. Part 3. Designing Databases Using Celesta</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="CelestaSQL">3.1. CelestaSQL</h3>
<div class="sect3">
<h4 id="_database_objects_definition_language">3.1.1. Database Objects Definition Language</h4>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Scripts in CelestaSQL language must be encoded in UTF-8.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Celesta SQL language is used to write scripts for defining grains.
Script in CelestaSQL consists of the following statements</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#create_schema_statement">CREATE GRAIN</a>,</p>
</li>
<li>
<p><a href="#create_sequence_statement">CREATE SEQUENCE</a>,</p>
</li>
<li>
<p><a href="#create_table_statement">CREATE TABLE</a>,</p>
</li>
<li>
<p><a href="#foreign_keys_statements">ALTER TABLE &#8230;&#8203; ADD &#8230;&#8203; FOREIGN KEY</a>,</p>
</li>
<li>
<p><a href="#create_index_statement">CREATE INDEX</a>,</p>
</li>
<li>
<p><a href="#create_view_statement">CREATE VIEW</a>,</p>
</li>
<li>
<p><a href="#create_materialized_view_statement">CREATE MATERIALIZED VIEW</a>,</p>
</li>
<li>
<p><a href="#create_function_statement">CREATE FUNCTION</a>,</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>which must be separated with semicolons starting with <code>CREATE GRAIN</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<object type="image/svg+xml" data="script.svg" width="488" height="264"><span class="alt">script</span></object>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_comments_in_celestasql">3.1.2. Comments in CelestaSQL</h4>
<div class="paragraph">
<p>CelestaSQL supports standard single-string and multistring comments, as well as <a href="#CelestaDoc">CelestaDoc</a> comments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">-- single-string comment
/*multistring
    comment*/
 /**CelestaDoc comment*/</code></pre>
</div>
</div>
<div class="paragraph">
<p>Standard comments can be used in any part of the text and CelestaDoc comments can be used only right before the grain, table, field or index definition.</p>
</div>
</div>
<div class="sect3">
<h4 id="_identifiers_in_celestasql">3.1.3. Identifiers in CelestaSQL</h4>
<div class="paragraph">
<p>Identifiers are names of grains, tables, fields, indices, limitations and views.
In Celesta, their syntax is subject to a number of stringent limitations.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In other RDBMS, identifiers are allowed to contain spaces and non-alphabetical symbols if the names are encased in special symbols, like "[]" in MS SQL Server.
This means that MS SQLServer allows table names like this: [Long Table$Name]. Celesta, on the other hand, cannot support spaces and non-alphabetical symbols in IDs because the name of every Celesta table must be the name of a Java class and the name of every Celesta field must be the name of a Java variable.
So IDs of all named objects in CelestaSQL must at least meet the naming requirements for Java identifiers, i.e. <strong>they must contain only lower- and uppercase Latin letters, numerals and underscores and must not start with numerals</strong>.</p>
</li>
<li>
<p><strong>Encasing identifiers with quotation marks</strong> in CelestaSQL scripts <strong>is not allowed</strong> at the CelestaSQL syntax level since there is no practical need to do that (names never contain spaces).
However, when forming requests to RDBMS at the system level, Celesta always encases names of its objects with strait marks ("ANSI quotes") to prevent Oracle, PostgreSQL and H2 databases from changing ID letter register.</p>
</li>
<li>
<p><strong>Identifiers</strong> in Celesta <strong>are case-sensitive</strong>, but it is impossible to create two tables with names different only in letter register.</p>
</li>
<li>
<p>The <strong>length</strong> of every identifier in Celesta <strong>cannot exceed 30 characters</strong>.</p>
</li>
<li>
<p><strong>In addition, grain identifiers cannot contain underscores</strong>.
This is because combining grain names with underscores and other identifiers often used for Celesta internal needs, this restriction helps to prevent possible ambiguities.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
It is a usual practice to write identifiers in CelestaSQL in "snake_case"&#8201;&#8212;&#8201;when transformed to Java classes, they will be converted to 'CamelCase'.
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="create_schema_statement">3.1.4. CREATE SCHEMA (GRAIN) Statement</h4>
<div class="paragraph">
<p>Every grain definition script must start with <code>CREATE SCHEMA</code>.
The following syntax is used (words <code>GRAIN</code> and <code>SCHEMA</code> are synonyms):</p>
</div>
<div id="create_grain" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="create_schema.svg" width="534" height="241"><span class="alt">create schema</span></object>
</div>
</div>
<div class="paragraph">
<p><code>WITH NO AUTOUPDATE</code> clause excludes the whole schema from the database autoupdate process, just like the similar  <a href="#celestasql_with_options">table option</a>.
It can be used when the schema structure is managed not by Celesta, but by some external system.</p>
</div>
<div class="paragraph">
<p>Version indication is mandatory to rule out unintentional database automatic downgrade when an older grain version launches with a more recent database version.</p>
</div>
<div id="version_tags" class="paragraph">
<p>Version consists of components separated with commas and may be as follows: <code>1.23,TITAN3.34</code>.
This reads: basic version 1.23, modified for the TITAN project  3.34.
Regular expression to check the component format is <code>([A-Z_]*)(<span class="0-9">\\.[0-9]</span>)</code>.
Every component of the version can be in bicomponent format only and either has no prefix or has one containing only Latin uppercase letters and an underscore.
When the system determines a possible autoupgrade, all version tags are compared consecutively.</p>
</div>
<div class="paragraph">
<p>In this sense the following tags to the "1.23,TITAN3.34" tag are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>"1.23,TITAN3.35"  a newer version (modification is upgraded), autoupgrade is possible;</p>
</li>
<li>
<p>"1.24,TITAN3.34"  a newer version (basic version is upgraded), autoupgrade is possible;</p>
</li>
<li>
<p>"1.23,TITAN3.34,PLUTO1.00"  a newer version (a new modification is added), autoupgrade is possible;</p>
</li>
<li>
<p>"TITAN3.34,1.23"  the same version (tag sequence does not matter), autoupgrade takes place only if checksums do not match, no errors will occur;</p>
</li>
<li>
<p>"1.22,TITAN3.34"  an older basic version, autoupgrade is not possible, an error will occur and Celesta will stop;</p>
</li>
<li>
<p>"1.22,TITAN3.36"  a non-aligned version, upgrade is not possible, error.
Versions "1.23,PLUTO1.00" and "1.25" also do not align with "1.23,TITAN3.34" version and will not upgrade automatically.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Versions are compared as floating point values.</p>
</div>
</div>
<div class="sect3">
<h4 id="create_sequence_statement">3.1.5. CREATE SEQUENCE Statement</h4>
<div class="paragraph">
<p>The following syntax is used:</p>
</div>
<div id="create_sequence" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="create_sequence.svg" width="558" height="268"><span class="alt">create sequence</span></object>
</div>
</div>
<div class="paragraph">
<p>Main limitations and differences between this statement and similar statements in various RDBMS are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the <code>MINVALUE</code> is not indicated, it is automatically set equal to the <code>START WITH</code> value (by default 1).</p>
</li>
<li>
<p>If the <code>MAXVALUE</code> is not indicated, it is automatically set equal to the <code>Long.MAX_VALUE</code>.</p>
</li>
<li>
<p>The <code>START WITH</code> value does not upgrade for sequences created earlier even if changed in the grain file (because Oracle allows this operation only by deleting and recreating the sequence and Celesta does not allow deleting stateful objects from the database).</p>
</li>
<li>
<p>If the grain contains a table with a name, for example, <code>A</code>, it is not possible to create a sequence named <code>A_seq</code>, since this name is reserved by the system.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="create_table_statement">3.1.6. CREATE TABLE Statement</h4>
<div class="paragraph">
<p>The following syntax is used:</p>
</div>
<div id="create_table" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="create_table.svg" width="627" height="171"><span class="alt">create table</span></object>
</div>
</div>
<div id="table_constituent" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="table_constituent.svg" width="617" height="142"><span class="alt">table constituent</span></object>
</div>
</div>
<div class="paragraph">
<p>In other words, the <code>CREATE TABLE</code> statement can list the definitions of fields, primary keys and foreign keys in any order in the brackets and options can be listed after them.
In practice, first definitions of all fields follow each other, then go composite primary keys (a single-field primary key can be defined in the field itself) and composite foreign keys (if single-field, they can be defined in the fields themselves).</p>
</div>
<div class="sect4">
<h5 id="_field_definitions">Field Definitions</h5>
<div id="field_definition" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="field_definition.svg" width="664" height="365"><span class="alt">field definition</span></object>
</div>
</div>
<div class="paragraph">
<p><strong>field_definition</strong> is a statement defining the field type, its ID, <code>NULL</code>/<code>NOT NULL</code> and <code>DEFAULT</code> properties and optionally may end with <code>PRIMARY KEY</code> and/or <code>FOREIGN KEY</code> statements.</p>
</div>
<div class="paragraph">
<p>Inline foreign key definition (<strong>inline_fk_definition</strong>) has the following syntax:</p>
</div>
<div id="inline_fk_definition" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="inline_fk_definition.svg" width="486" height="138"><span class="alt">inline fk definition</span></object>
</div>
</div>
<div class="paragraph">
<p>Here <strong>table_ref</strong> is a reference to a table, either single-component (if the table indicated by the foreign key is in the current grain) or bicomponent, explicitly indicating the grain name:</p>
</div>
<div id="table_ref" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="table_ref.svg" width="397" height="75"><span class="alt">table ref</span></object>
</div>
</div>
<div class="paragraph">
<p>Syntax rules for foreign keys (<strong>fk_rules</strong>) can be found in the <a href="#foreign_keys_statements">Foreign Key Rules</a> section.</p>
</div>
</div>
<div class="sect4">
<h5 id="datatypes_mapping">Data Types</h5>
<div class="paragraph">
<p>The following data type system is used.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
<col style="width: 12.5%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle"></th>
<th class="tableblock halign-center valign-middle">Celesta</th>
<th class="tableblock halign-center valign-middle">Microsoft SQL Server</th>
<th class="tableblock halign-center valign-middle">Oracle</th>
<th class="tableblock halign-center valign-middle">PostgreSQL</th>
<th class="tableblock halign-center valign-middle">Firebird</th>
<th class="tableblock halign-center valign-middle">H2</th>
<th class="tableblock halign-center valign-middle">Java type for cursor</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Integer (32-bit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NUMBER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INT4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">INTEGER</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Integer</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Floating point (64-bit)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FLOAT(53)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">REAL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">FLOAT8
[= DOUBLE PRECISION]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DOUBLE PRECISION</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DOUBLE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">ava.lang.Double</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fixed point (decimal)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DECIMAL(p,s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DECIMAL(p,s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NUMBER(p,s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NUMERIC(p,s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DECIMAL(p,s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DECIMAL(p,s)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.math.BigDecimal</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">String (Unicode)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARCHAR(n)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVARCHAR(n)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVARCHAR(n)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARCHAR(n)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARCHAR(n)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARCHAR(n)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Long string (Unicode)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NVARCHAR(MAX)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NCLOB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BLOB SUB_TYPE TEXT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">CLOB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Binary</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BLOB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARBINARY(MAX)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BLOB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BYTEA</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BLOB</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">VARBINARY(MAX)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.String</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date/time</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATETIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATETIME</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.util.Date</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Date/time with time zone</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATETIME WITH TIME ZONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DATETIMEOFFSET</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP WITH TIME ZONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMPZ</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP WITH TIME ZONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TIMESTAMP WITH TIME ZONE</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.time.ZonedDateTime</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Boolean</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BIT</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">NUMBER
[check in (0, 1)]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BOOL</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">SMALLINT
[check in (0, 1)]</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">BOOLEAN</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">java.lang.Boolean</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>See also the <a href="#RDBMS_peculiarities">Notes on Using Supported RDBMS in Celesta</a> section.</p>
</div>
<div class="paragraph">
<p>Every field type has its own definition version:</p>
</div>
<div id="nullability" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="nullability.svg" width="283" height="78"><span class="alt">nullability</span></object>
</div>
</div>
<div id="int_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="int_field.svg" width="835" height="108"><span class="alt">int field</span></object>
</div>
</div>
<div class="paragraph">
<p>The <code>NEXTVAL(&lt;sequence name&gt;)</code> statement can be used for <code>INT</code> type fields instead of <code>DEFAULT &lt;integer&gt;</code>.
This allows column value to increment when inserting depending on the indicated sequence.
It should be noted that it is possible to use only the sequences declared in the same grain as the table containing the column.</p>
</div>
<div id="floating_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="floating_field.svg" width="576" height="74"><span class="alt">floating field</span></object>
</div>
</div>
<div id="decimal_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="decimal_field.svg" width="626" height="141"><span class="alt">decimal field</span></object>
</div>
</div>
<div id="text_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="text_field.svg" width="641" height="173"><span class="alt">text field</span></object>
</div>
</div>
<div id="blob_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="blob_field.svg" width="540" height="74"><span class="alt">blob field</span></object>
</div>
</div>
<div class="paragraph">
<p>Here <strong>&lt;binary literal&gt;</strong> is a hexadecimal representation of a byte sequence starting with 0x, without any quotation marks, for example: 0xFFAAFFAAFF.</p>
</div>
<div id="datetime_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="datetime_field.svg" width="711" height="109"><span class="alt">datetime field</span></object>
</div>
</div>
<div class="paragraph">
<p>A <code>GETDATE()</code> (current time) function can be used as a <code>DEFAULT</code> value for  <code>DATETIME</code> type fields.</p>
</div>
<div id="datetime_with_time_zone_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="datetime_with_time_zone_field.svg" width="535" height="70"><span class="alt">datetime with time zone field</span></object>
</div>
</div>
<div id="bit_field" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="bit_field.svg" width="534" height="106"><span class="alt">bit field</span></object>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_primary_keys">Primary Keys</h5>
<div id="primary_key_definition" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="primary_key_definition.svg" width="482" height="104"><span class="alt">primary key definition</span></object>
</div>
</div>
<div class="paragraph">
<p><strong>primary_key_definition</strong> is a statement defining the composition of fields constituting the primary key of a table.
Two version are possible:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>inline version  <code>PRIMARY KEY</code> goes right after the field definition, which allows for shorter and more graphic representation when the primary key consists of a single field;</p>
</li>
<li>
<p>full version  <code>PRIMARY KEY</code> is in the table definition among other field definitions and can contain a single or any other number of fields.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Restrictions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>creating tables without a <code>PRIMARY KEY</code> is not allowed (except <code>READ ONLY</code> tables).
Otherwise data access classes are not operable;</p>
</li>
<li>
<p>the table cannot contain more than a single mention of a <code>PRIMARY KEY</code>, whether shortened in the end of the field definition or composite expression in the table definition;</p>
</li>
<li>
<p>creating a primary key by field with <code>BLOB</code> and <code>TEXT</code> types is not allowed;</p>
</li>
<li>
<p>creating a primary key by nullable fields is not allowed;</p>
</li>
<li>
<p>primary key expression is not allowed to incorporate any field more than once.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="foreign_keys_statements">Foreign Keys</h5>
<div id="foreign_key_definition" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="foreign_key_definition.svg" width="734" height="205"><span class="alt">foreign key definition</span></object>
</div>
</div>
<div class="paragraph">
<p><strong>foreign_key_definition</strong> is a statement establishing connections between tables by one or several fields.
As with the <code>PRIMARY KEY</code> statement, there are two versions of it: inline (incorporated in the field definition, link by one field) and full (listed among field definitions).
In addition, the foreign key can be created without defining the table using "alter table add constraint" statement:</p>
</div>
<div id="add_foreign_key" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="add_foreign_key.svg" width="673" height="136"><span class="alt">add foreign key</span></object>
</div>
</div>
<div class="paragraph">
<p>Restrictions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>foreign keys, either simple of composite, can refer only to primary keys and only in full (Celesta SQL does not allow <code>UNIQUE</code> restrictions, so from two possibilities usually provided in RDBMS for foreign keys, it supports only referring to primary key);</p>
</li>
<li>
<p>field types must fully match (if the field is a string one, the length of the referring field must be exactly the same as the referred field length);</p>
</li>
<li>
<p>a set of columns cannot have more than one foreign key definition (special case: there cannot be two foreign keys defined for the same column).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><strong>fk_rules</strong>  referring actions:</p>
</div>
<div id="fk_rules" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="fk_rules.svg" width="609" height="272"><span class="alt">fk rules</span></object>
</div>
</div>
<div class="paragraph">
<p>Supported referring action:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>NO ACTION</code>  forbidding deletion/modification of the parent entry if links to it exist.</p>
</li>
<li>
<p><code>SET NULL</code>  setting <code>NULL</code> in fields referencing a record being updated or deleted.
Naturally, this action is prohibited for <code>NOT NULL</code>-able fields.</p>
</li>
<li>
<p><code>CASCADE</code>  cascade field deletion/update.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A foreign key can refer to the following only:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>a table defined in the current grain above;</p>
</li>
<li>
<p>a table defined in another grain.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
"Looped" references by foreign key (i.e, A&#8594;B&#8594;C&#8594;A kind) are rarely used in database development and usually mean that designer has made a mistake.
The only widely used actually important example of "looping" is a table that refers to itself when organizing hierarchical list by parentchild principle.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Celesta does not allow to create "looped" references between tables belonging to different grains.
Use "alter table add constraint foreign key" statement to create a circle of references between several tables in a single grain.</p>
</div>
<div class="paragraph">
<p>In particular, the example below is actionable:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE aa(idaa INT NOT NULL PRIMARY KEY, idc INT , textvalue nvarchar(10));</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE a (ida INT NOT NULL PRIMARY KEY, descr nvarchar(2), parent INT
                FOREIGN KEY REFERENCES a(ida), --the table refers to itself
                fff INT FOREIGN KEY REFERENCES aa(idaa) --first part of a circle reference</code></pre>
</div>
</div>
<div class="paragraph">
<p>Foreign key created outside the table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">ALTER TABLE aa ADD CONSTRAINT fk1
  FOREIGN KEY (idc) REFERENCES a(ida); --second part of a circle reference</code></pre>
</div>
</div>
<div class="paragraph">
<p>Example of creating a composite key consisting of two fields:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE empfiles(
  id INT NOT NULL PRIMARY KEY,
  user_id varchar(200) NOT NULL,
  orgtype_id varchar(255) NOT NULL,
  question_id varchar(30) NOT NULL,
  FOREIGN KEY (orgtype_id, question_id) REFERENCES schema.table(field, field)</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="celestasql_with_options">Options</h5>
<div class="paragraph">
<p>Celesta allows to indicate the following options after defining the table.</p>
</div>
<div id="table_options" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="table_options.svg" width="510" height="177"><span class="alt">table options</span></object>
</div>
</div>
<div class="paragraph">
<p>The following features are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>WITH VERSION CHECK</code>  default mode. Enables entry version tracking to avoid losing updates (see the <a href="#Lost_updates_protection">Lost Update Prevention</a> section).
This option does not have to be indicated explicitly.</p>
</li>
<li>
<p><code>WITH NO VERSION CHECK</code>  disables entry version tracking.
Used when there is no need to prevent update loses, for example, in tables used only for adding entries.
The data in the table can still be modified with this option enabled, but the updates may be lost.</p>
</li>
<li>
<p><code>WITH READ ONLY</code>  read-only mode.
Used when table data comes from external sources and not updated by Celesta or it is necessary to connect to a table that belongs to a different application and so it is better not to make any changes to its data.
In this mode the entry version tracking is disabled and table access class is generated without data modification methods.
In addition, it is not necessary to specify primary keys for such tables.</p>
</li>
<li>
<p><code>NO AUTOUPDATE</code> option disables the auto-migration for the table and can be used together with other options.
It is used when the structure of a certain table is changed in the database by other means and the system should not try to autosynch the table&#8217;s structure with the definition given by CelestaSQL script.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect3">
<h4 id="create_index_statement">3.1.7. CREATE INDEX Statement</h4>
<div class="paragraph">
<p>Indices are used to speed up filtering by table field and are created with the following statement:</p>
</div>
<div id="create_index" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="create_index.svg" width="581" height="171"><span class="alt">create index</span></object>
</div>
</div>
<div class="paragraph">
<p>Names of indices within a grain must be unique.
All indices in Celesta allow non-unique column values.</p>
</div>
</div>
<div class="sect3">
<h4 id="create_view_statement">3.1.8. CREATE VIEW Statement</h4>
<div class="paragraph">
<p>Views serve to grant read-only access to the data collected from one or several tables with a <code>SELECT</code> SQL query.
Celesta creates a view object for every view and translates the SQL query in CelestaSQL into the respective SQL dialect.</p>
</div>
<div class="paragraph">
<p>Views are created using the following syntax statement:</p>
</div>
<div id="create_view" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="create_view.svg" width="507" height="70"><span class="alt">create view</span></object>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>&lt;view name&gt;</strong> must be unique within a grain and must not match the table name.</p>
</li>
<li>
<p><strong>query</strong> is a SQL query with the following syntax:</p>
</li>
</ul>
</div>
<div id="query" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="query.svg" width="199" height="104"><span class="alt">query</span></object>
</div>
</div>
<div class="paragraph">
<p><code>SELECT</code> statements in CelestaSQL can be chained with <code>UNION ALL</code>.
As usual, it is required that each <code>SELECT</code> statement in <code>UNION ALL</code> chain returns the same number of columns of the matching types.</p>
</div>
<div class="paragraph">
<p>The names of the columns returned by <code>UNION ALL</code> expression are assigned from the respective columns of the first <code>SELECT</code> query.
Columns' nullability is determined the following way: if any of the queries in <code>UNION ALL</code> chain can return <code>null</code> in a column, the column is identified as nullable.</p>
</div>
<div id="select_qry" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="select_qry.svg" width="700" height="224"><span class="alt">select qry</span></object>
</div>
</div>
<div id="from_clause" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="from_clause.svg" width="880" height="278"><span class="alt">from clause</span></object>
</div>
</div>
<div class="paragraph">
<p>This query key restrictions and differences from SQL queries in various RDBMS are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Queries are based only on tables or materialized views (in the current or neighbouring grains).
Queries cannot be created based on ordinary views in order to avoid making ineffective statements.</p>
</li>
</ol>
</div>
<div id="no_select_all_fields" class="olist arabic">
<ol class="arabic">
<li>
<p><code>SELECT *</code> statement is not supported and every query field must have a set and unique alias, only if it is not a reference to a table field with a unique name within a query.
It allows to unambiguously create class-cursors with fields aligned to the query column names.</p>
</li>
<li>
<p><code>ORDER BY</code> is not supported since orderBy(&#8230;&#8203;) method of the relevant cursor allows to sort the selection in a specific manner.</p>
</li>
<li>
<p><code>GROUP BY</code>&#8230;&#8203;<code>HAVING</code> statement is not supported.</p>
</li>
<li>
<p><code>FULL JOIN</code> (<code>LEFT</code> and <code>RIGHT</code> joins) and <code>CROSS JOIN</code> (table Cartesian products) statements are not supported.</p>
</li>
<li>
<p><code>WITH</code> statements and nested queries are not supported.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Most functions not supported at the CelestaSQL level can be efficiently emulated with data access classes API.</p>
</div>
<div class="paragraph">
<p>Reference to a table (<strong>table_ref</strong>) has the following syntax:</p>
</div>
<div class="imageblock">
<div class="content">
<object type="image/svg+xml" data="table_ref.svg" width="397" height="75"><span class="alt">table ref</span></object>
</div>
</div>
<div class="paragraph">
<p>It is not necessary to indicate the grain ID if the table is in the same grain as the current view.</p>
</div>
<div class="paragraph">
<p>View field defining term has the following syntax:</p>
</div>
<div id="term" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="term.svg" width="461" height="339"><span class="alt">term</span></object>
</div>
</div>
<div class="paragraph">
<p>Common arithmetical operations with normal precedence are available for <code>INT</code> and <code>REAL</code>-typed expressions: unary minus has the highest precedence, next goes multiplication and division ("*", "/") and still next goes adding and substracting ("+", "-").
For <code>VARCHAR</code> expressions concatenation "||" is available, as well as <code>UPPER</code> and <code>LOWER</code> functions that convert text to upper- and lower-case, respectively.
Operations with other types are not allowed.</p>
</div>
<div id="primary_term" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="primary_term.svg" width="495" height="332"><span class="alt">primary term</span></object>
</div>
</div>
<div class="paragraph">
<p>References to fields may be single-component (if they unambiguously indicate a field of a certain table) or bicomponent, in this case the first component should be the alias of the table in the <code>FROM</code> statement, and if there is no explicit alias  table name.</p>
</div>
<div class="paragraph">
<p><strong>&lt;$param id&gt;</strong> special ID type  a "$" symbol followed by ID  is used for references to <a href="#create_function_statement">function</a> parameters.</p>
</div>
<div class="paragraph">
<p>At last, the <strong>condition</strong> logic expression used in <code>JOIN</code> &#8230;&#8203; <code>ON</code> and <code>WHERE</code> statements has the following syntax:</p>
</div>
<div id="condition" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="condition.svg" width="445" height="168"><span class="alt">condition</span></object>
</div>
</div>
<div id="predicate" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="predicate.svg" width="516" height="404"><span class="alt">predicate</span></object>
</div>
</div>
<div id="aggregate" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="aggregate.svg" width="608" height="168"><span class="alt">aggregate</span></object>
</div>
</div>
<div class="paragraph">
<p>It is important to note that the <strong>term</strong> inside a <code>SUM</code> statement must be a number.</p>
</div>
<div id="group_by" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="group_by.svg" width="400" height="136"><span class="alt">group by</span></object>
</div>
</div>
<div class="paragraph">
<p><code>GROUP BY</code> statement is special in CelestaSQL because unlike the common SQL it is necessary to list all not aggregated columns in the selection.</p>
</div>
</div>
<div class="sect3">
<h4 id="create_materialized_view_statement">3.1.9. CREATE MATERIALIZED VIEW Statement</h4>
<div class="paragraph">
<p>Materialized views serve to grant read-only access to aggregated data collected from a single table and grouped using a <code>GROUP BY</code> expression.
For its every materialized view Celesta creates a table in the database which is modified by database triggers on parent table modification.</p>
</div>
<div class="paragraph">
<p>Materialized views are created with the following syntax statement:</p>
</div>
<div id="create_materialized_view" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="create_materialized_view.svg" width="618" height="272"><span class="alt">create materialized view</span></object>
</div>
</div>
<div class="paragraph">
<p>This query key restrictions and differences from SQL queries in various RDBMS are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Queries are formed only on the current grain&#8217;s table.</p>
</li>
<li>
<p><code>SELECT *</code> statement <a href="#no_select_all_fields">is not supported</a>.</p>
</li>
<li>
<p>Selection must include at least one aggregated and one non-aggregated column.</p>
</li>
<li>
<p>Non-aggregated columns must refer to <code>NOT NULL</code> columns in the parent table.</p>
</li>
<li>
<p>If a <code>DATETIME</code> type column is involved in a <code>GROUP BY</code> expression, its values are rounded to days (hours, minutes and more accurate measurements are truncated).</p>
</li>
<li>
<p>Only <code>SUM</code> and <code>COUNT</code> operations are available from the set of all aggregate operations.</p>
</li>
</ol>
</div>
<div id="materialized_aggregate" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="materialized_aggregate.svg" width="543" height="105"><span class="alt">materialized aggregate</span></object>
</div>
</div>
</div>
<div class="sect3">
<h4 id="create_function_statement">3.1.10. CREATE FUNCTION Statement</h4>
<div class="paragraph">
<p>This statement determines functions or parametered views.
They serve to grant read-only access to the data collected from one or several tables using a <code>SELECT</code> SQL query taking into account the given parameters.</p>
</div>
<div class="paragraph">
<p>Functions are created with the following statement:</p>
</div>
<div id="create_function" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="create_function.svg" width="570" height="171"><span class="alt">create function</span></object>
</div>
</div>
<div class="paragraph">
<p>Parameters are declared with the parameter name and type set and are separated with commas as follows:</p>
</div>
<div id="param_definition" class="imageblock">
<div class="content">
<object type="image/svg+xml" data="param_definition.svg" width="363" height="230"><span class="alt">param definition</span></object>
</div>
</div>
<div class="paragraph">
<p>To refer to a parameter in a function expression, a symbol <code>$</code> must be put before the parameter name  (for example, <code>param1</code> is put in query expressions as <code>$param1</code>).</p>
</div>
<div class="paragraph">
<p>This query key restrictions and differences from SQL queries in various RDBMS are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>SELECT *</code> statement <a href="#no_select_all_fields">is not supported</a>.</p>
</li>
<li>
<p>Declaration must contain at least one parameter.</p>
</li>
<li>
<p>All declared parameters must be used.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Otherwise, a parameterized view syntax is similar to common view.</p>
</div>
<div class="paragraph">
<p>Parameterized view example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE FUNCTION pView2(param int, param2 varchar) AS
  select f1, f2, f3 from t1
  where f2 = $param AND f3 = $param2;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="CelestaDoc">3.2. CelestaDoc</h3>
<div class="paragraph">
<p>Just like Java has JavaDoc for object documentation or Python has a documenting constant available in the run time, CelestaSQL has a special tool to document defined database objects: comments in a special format /** &#8230;&#8203; */ (two asterisks after the first slash, instead of a single asterisk in a standard comment).
These comments are called CelestaDoc comments (by analogy with JavaDoc) and can be put in the CelestaSQL script code right before definitions of the corresponding objects as shown in the example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">/**grain description*/
CREATE SCHEMA test1 VERSION '1.0';

/**sequence description*/
CREATE SEQUENCE test_entryno;

/**table description*/
CREATE TABLE table2(
    /**first column description*/
    column1 INT NOT NULL DEFAULT NEXTVAL(test_entryno) PRIMARY KEY,
    /**second column description*/
    column2 INT
);

/**idx1 index description*/
CREATE INDEX idx1 ON  table2 (column2);

/**v1 view description*/
CREATE VIEW v1 AS
  SELECT DISTINCT column2 FROM table2;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Unlike simple comments usable in any part of the CelestaSQL script, CelestaDoc comments can be put only before the definition of the corresponding object, otherwise a syntax error occurs.</p>
</div>
<div class="paragraph">
<p>Parser reads CelestaDoc and this information is available in metadata objects in the run time by using the <strong>getCelestaDoc()</strong> method (see the <a href="#Celesta_metadata">Celesta Metadata</a> section).</p>
</div>
<div class="paragraph">
<p>CelestaDoc comments serve to provide Celesta objects with documentation and additional metainformation during execution, like human-readable field names, information on field representation in UI, etc.</p>
</div>
<div class="paragraph">
<p>Common practise is to use CelestaDoc comments to provide metainformation in a JSON object format.
CelestaDoc also supports plain text, as well as JSON objects.
The <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/CelestaDocUtils.html"><code>CelestaDocUtils</code></a> class <code>getCelestaDocJSON</code> utility method allows to extract first valid JSON object from a CelestaDoc string.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_4_creating_and_testing_data_access_and_modification_code">4. Part 4. Creating and Testing Data Access and Modification Code</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="celesta_instantiation">4.1. Creating an Instance of Celesta</h3>
<div class="sect3">
<h4 id="_celesta_createinstance_methods">4.1.1. <code>Celesta.createInstance</code> Methods</h4>
<div class="paragraph">
<p>In order to start working with Celesta, a <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/Celesta.html"><code>Celesta</code></a> instance should be created.
Normally, there must be a single <code>Celesta</code> object per application, this is why it must be stored as a singleton or managed by Spring framework.</p>
</div>
<div class="paragraph">
<p>If you are using <a href="#quick_start_demo"><code>spring-boot-starter-celesta</code></a>, the <code>Celesta</code> instance is created automatically and is available as a bean.</p>
</div>
<div class="paragraph">
<p>If you want to create and instance of Celesta yourself, you should create <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Properties.html"><code>Properties</code></a> holding the <a href="#basic_settings_section">Celesta settings</a>  and then  utilize one of the following static methods on <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/Celesta.html"><code>Celesta</code></a> class:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><code>Celesta createInstance(Properties properties)</code></dt>
<dd>
<p>Creates Celesta instance with specified properties and Celesta&#8217;s own connection pool.</p>
</dd>
<dt class="hdlist1"><code>Celesta createInstance(Properties properties, DataSource dataSource)</code></dt>
<dd>
<p>Creates Celesta instance with specified properties and a <a href="https://docs.oracle.com/javase/8/docs/api/javax/sql/DataSource.html"><code>DataSource</code></a>. You can use this method if you want to provide a specific connection pool for Celesta.</p>
</dd>
</dl>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="ulist">
<ul>
<li>
<p>The provided connection pool must be configured to return connections with <code>autoCommit</code> set to <code>false</code>.</p>
</li>
<li>
<p>You still have to provide <code>rdbms.connection.url</code> property in order for Celesta to determine the type of the database. Since this parameter will not be used for connection to the database, it&#8217;s enough to provide only the prefix, like <code>jdbc:postgresql</code>, <code>jdbc:sqlserver</code> etc.</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_call_context">4.2. Call Context</h3>
<div class="sect3">
<h4 id="_call_context_creation_and_life_cycle">4.2.1. Call Context Creation and Life Cycle</h4>
<div class="paragraph">
<p>To meet the requirements for granting access rights and action logging, all operations are performed on behalf of a specific user, anonymous operations are impossible.
This is why Celesta code is executed in a certain context determined by a  (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/CallContext.html"><code>CallContext</code></a>) class instance.</p>
</div>
<div class="paragraph">
<p>Call context contain user ID, while links between user IDs and roles determine granting access to tables and allow to log changes made on user&#8217;s behalf.</p>
</div>
<div class="paragraph">
<p>Context calls are created at the controller level, where the ID of the user performing operations is assumed to be known (through a token sent to the query, digital signature or other means).</p>
</div>
<div class="paragraph">
<p>Context is created with a constructor</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">CallContext(String userId)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If there is no need to consider the user ID or grant rights to access the tables, a  <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/SystemCallContext.html"><code>SystemCallContext</code></a> subclass can be used, because its constructor does not require any parameters.
In this case, a "system user" context with full access to all tables is created.</p>
</div>
<div class="paragraph">
<p>Any context created in this way goes through the following life cycle:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>Activation</strong>.
An <code>activate(..)</code> method is called receiving a reference to a <code>Celesta</code> object and a name of an executed procedure.
At this moment an implicit transaction starts in the database and call execution time counting begins.</p>
</li>
<li>
<p><strong>Calling a service method</strong>.
Context is passed as a parameter to a service method and is used to create cursors.</p>
</li>
<li>
<p><strong>Closing</strong>.
A <code>close()</code> method is called committing the transaction and closing all open cursors and freeing all JDBC resources.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Developer <strong>does not</strong> usually need to manually activate and close contexts since Celesta framework performs it automatically.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>When using  <a href="https://github.com/CourseOrchestra/spring-boot-starter-celesta">Celesta Spring Boot starter</a>, cursors are activated and closed when calling methods of services marked by
a <code>@CelestaTransaction</code> annotation.
So for the developer it is enough to pass a nonactivated context to them.
Proxy object created by Spring framework around a service class instance will activate and close context and roll back database transactions if an uncaught exception is thrown.</p>
</li>
<li>
<p>When using <a href="#celestaunit_section">CelestaUnit</a>, an activated system context on the basis of Celesta running with a H2 database in an in-memory mode is passed to test methods' parameters of a <code>CallContext</code> type.
Context closing and commits/rollbacks are performed by CelestaUnit automatically "under the hood".</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_call_context_usage">4.2.2. Call Context Usage</h4>
<div class="paragraph">
<p>Each method in the service layer using Celesta must have an argument of a  <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/CallContext.html"><code>ru.curs.celesta.CallContext</code></a> type.
Call context is intended to be an argument for cursor constructors,
but it also has a number of public methods and properties available, feasible to be used in a service method:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">commit()</dt>
<dd>
<p>Commits the current transaction.
A need in this method occurs only in rare cases when data processing transaction should be split in several parts.
Usually it is not needed as transactions are committed automatically at the end of the procedure.</p>
</dd>
<dt class="hdlist1">rollback()</dt>
<dd>
<p>Rolls back the current transaction.</p>
</dd>
<dt class="hdlist1">getCelesta()</dt>
<dd>
<p>Gets a current instance of a Celesta object.
It can be further used to obtain score metadata.</p>
</dd>
<dt class="hdlist1">getUserId()</dt>
<dd>
<p>Get an ID of the user on whose behalf the actions are performed.</p>
</dd>
<dt class="hdlist1">getStartTime()</dt>
<dd>
<p>Gets a call context creation time (the Celesta procedure start time got with <code>System.currentTimeMillis()</code>).</p>
</dd>
<dt class="hdlist1">getDurationNs()</dt>
<dd>
<p>Gets a call context duration in nanoseconds measured as a difference between values returned by <code>System.nanoTime()</code> calls.</p>
</dd>
<dt class="hdlist1">getProcName()</dt>
<dd>
<p>Gets the name of the procedure called initially from the controller (for debugging).</p>
</dd>
<dt class="hdlist1">getDBPid()</dt>
<dd>
<p>Gets PID (process identifier) of the current connection to the database (for debugging).</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect2">
<h3 id="data_accessors_section">4.3. Working with Data Using Data Access Classes (Cursors)</h3>
<div class="sect3">
<h4 id="_access_classes_and_their_standard_methods">4.3.1. Access Classes and Their Standard Methods</h4>
<div class="paragraph">
<p>For each table and view declared in CelestaSQL data access classes are generated.</p>
</div>
<div class="paragraph">
<p>Each instance of a data access class (which are also going to be called "cursors") at each moment holds information about a single database record (row) and every row&#8217;s field of the cursor has a corresponding object field.
It is possible to move cursor across records taking into account filters and ordering.
If a cursor is created from a table, it can also be used to insert, modify or delete data.
View cursors only allow row navigation methods.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="cursors.png" alt="cursors" width="925" height="277">
</div>
</div>
<div class="paragraph">
<p>The UML diagram illustrates data access class hierarchy.
Hierarchy is based on a <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BasicDataAccessor.html"><code>BasicDataAccessor</code></a> class.
Each cursor class inherits from the <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BasicCursor.html"><code>BasicCursor</code></a> class, <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/Sequence.html"><code>Sequence</code></a> class inherits from the <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BasicDataAccessor.html"><code>BasicDataAccessor</code></a>:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1"><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/Cursor.html">Cursor</a></dt>
<dd>
<p>Is used to work with tables.
It inherits all <code>BasicCursor</code> methods and also adds a number of its own methods to allow data modification.</p>
</dd>
<dt class="hdlist1"><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/ViewCursor.html">ViewCursor</a></dt>
<dd>
<p>Is used to work with views.
It does not add any own methods to <code>BasicCursor</code>.</p>
</dd>
<dt class="hdlist1"><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/MaterializedViewCursor.html">MaterializedViewCursor</a></dt>
<dd>
<p>Is used to work with materialized views.
It inherits all <code>BasicCursor</code> methods and also adds a number of its own methods to make possible accessing data by the primary key.</p>
</dd>
<dt class="hdlist1"><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/ParameterizedViewCursor.html">ParameterizedViewCursor</a></dt>
<dd>
<p>Is used to work with functions (parameterized views).
It does not add any own methods to <code>BasicCursor</code> but its constructor differs from the basic one.</p>
</dd>
<dt class="hdlist1"><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/ReadOnlyTableCursor.html">ReadOnlyTableCursor</a></dt>
<dd>
<p>Is used to work with tables declared "WITH READ ONLY".
It does not add any own methods to <code>BasicCursor</code>.</p>
</dd>
<dt class="hdlist1"><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/Sequence.html">Sequence</a></dt>
<dd>
<p>Is used to work with sequences.
It inherits all <code>BasicDataAccessor</code> class methods and adds a <code>nextValue</code> method.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Below <code>Cursor</code> class methods are described, but the methods that are inherited from <code>BasicCursor</code> (and can be used when working with views and read-only tables) are marked with a <span class="icon"><i class="fa fa-search"></i></span> symbol.</p>
</div>
<div class="sect4">
<h5 id="_cursor_fields_metadata">Cursor Fields' Metadata</h5>
<div class="paragraph">
<p>A <code>Columns</code> companion class is generated for each cursor class to participate in invocation of certain cursor&#8217;s methods and to make it easier to obtain the information about available cursor&#8217;s fields in the run time.
Companion is an inner static class inside the cursor.
For example, for <code>FooCursor</code> class the companion is <code>FooCursor.Columns</code>.</p>
</div>
<div class="paragraph">
<p>Each cursor field has a corresponding method in a <code>Columns</code> class returning the <a href="#Celesta_metadata">metadata</a> of a corresponding column as illustrated in the diagram:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="cursormeta.png" alt="cursormeta" width="240" height="266">
</div>
</div>
<div class="paragraph">
<p>A corresponding instance of a <code>Columns</code> class is available in each cursor instance through a <code>public final Columns COLUMNS</code> field.
In addition, the <code>Columns</code> class of each cursor can be instantiated independent of the cursor  its constructor has an <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/ICelesta.html"><code>ICelesta</code></a> parameter.</p>
</div>
<div class="paragraph">
<p>Using code generated <code>Columns</code> class methods to get table field references ensures code integrity when changing data schema (for example, when deleting or renaming fields in the database).</p>
</div>
</div>
<div class="sect4">
<h5 id="_cursor_constructor">Cursor Constructor</h5>
<div class="paragraph">
<p>Constructors of each cursor require a <code>CallContext context</code> parameter which in turn is given to each service layer method.
Context use allows to work with different system tables as part of a single transaction and then commit all changes in a unified manner.
Context variable also contains information on the current user, which is used by logging and permission management systems.</p>
</div>
<div class="paragraph">
<p>For classes inherited from <code>Cursor</code>, <code>ViewCursor</code>, <code>MaterializedViewCursor</code> and <code>ReadOnlyTableCursor</code> types the constructor can take the following form:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">ACursor a = new ACursor(context);</code></pre>
</div>
</div>
<div id="too_many_accessors_warning" class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Maximum number of cursors a single instance of <code>CallContext</code> can create is 1023.
Exceeding the limit results in an error "Too many data accessors".</p>
</div>
<div class="paragraph">
<p>This does not restrict sensible scenarios of working with data in the database and prevents JDBC resource leakage, for example if cursors are created in a loop.
When creating cursor in a loop it must be closed explicitly.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect5">
<h6 id="limit_columns">Limiting the Number of Columns Fetched</h6>
<div class="paragraph">
<p>Tables often have many defined fields, but only a few of them are needed for tasks at hand.
There is a way to query only necessary column values from the database when creating cursors to prevent transferring unnecessary information between the database and the application server and increase performance.
To do it, a list of fields for querying must be passed as a cursor&#8217;s constructor optional "varargs" parameters.
Fields excluded from the list take <code>null</code> values when the cursor navigates database records.</p>
</div>
<div class="paragraph">
<p>Let us assume the database has <code>table1</code> filled with data:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">create table table1 (
  id int not null primary key,
  numb int not null,
  numb2 int,
  varr varchar(2) not null
);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assume the developed solution does not need to select data from the "varr" column.
In this case, to create a cursor it is possible to indicate the needed columns.
Cursor creation will look as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//initiate companion object containing information on columns
Table1Cursor.Columns columns = new Table1Cursor.Columns(context.getCelesta());
//transfer a list of desired columns in additional arguments of the constructor
Table1Cursor tableCursor = new Table1Cursor(context, columns.numb(), columns.numb2());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now Celesta will not select <code>varr</code> columns when requesting data from the database <code>varr</code> column, and <code>varr</code> field of the <code>tableCursor</code> will always have a value of <code>null</code>.</p>
</div>
<div class="paragraph">
<p>Peculiarities of limiting columns in a selection are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Columns of a primary key always get into cursor from the database regardless of whether they are on the list of fields.
It ensures correct operation of the cursor navigation methods when limiting columns.</p>
</li>
<li>
<p>Columns mentioned in a "group by" materialized view expression always get into cursor from the database.</p>
</li>
<li>
<p>When passing empty field list or if there is no list, all the columns are selected.</p>
</li>
<li>
<p>Use of <a href="#BLOB_fields"><code>BLOB</code></a> columns does not change.
By default, data from these fields is never read from database during navigation and this data can always be retrieved by calling a separate method.</p>
</li>
</ol>
</div>
</div>
<div class="sect5">
<h6 id="_passing_parameters_to_functions_parameterized_views">Passing Parameters to Functions (Parameterized Views)</h6>
<div class="paragraph">
<p>It is necessary to note that the  <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/ParameterizedViewCursor.html"><code>ParameterizedViewCursor</code></a> cursor has its own version of a constructor that contains function arguments.</p>
</div>
<div class="paragraph">
<p>Let us assume that there is a table and a function for selecting from it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE table t1 (
  id INT NOT NULL IDENTITY PRIMARY KEY,
  f1 int,
  f2 int,
  f3 VARCHAR (2)
);</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE FUNCTION pView1(p int) AS
  select sum (f1) as sumv, f3 as f3
  from t1 as t1
  where f2 = $p
  group by f3;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To create a cursor for a function with a parameter p = 5 the following code must be executed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">PView1Cursor pView1 = new PView1Cursor(context, 5);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Passing parameters to a function can be combined with limiting the fetched fields set.
In order to do it first it is necessary to pass the parameters corresponding to mandatory cursor arguments and then the list of fields for selection as "varargs" arguments.</p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_changing_cursor_fields">Changing Cursor Fields</h5>
<div class="paragraph">
<p>Cursor class have fields containing getters and setters for each declared table fields allowing to read and write information.
For instance, if foo table is defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE TABLE foo (
  a INT NOT NULL PRIMARY KEY,
  b VARCHAR(10),
  c DATETIME,
  d BIT
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>then to insert a record in it the following code can be utilized:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooCursor foo = new FooCursor(context);
foo.setA(1);
foo.setB("text");
foo.setC(new GregorianCalendar(year, month, day).getTime());
foo.insert();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Correspondence between CelestaSQL and Java data types is described in the <a href="#datatypes_mapping">table</a>.</p>
</div>
<div class="paragraph">
<p>Note the <code>Date</code> class use when writing date value: this is a JDBC API restriction.
If needed to fill the "" field with current date and time the following expression can be utilized:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">foo.setC(new Date());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Changing the BLOB field values is described in the <a href="#BLOB_fields">BLOB Fields</a> section.</p>
</div>
<div class="paragraph">
<p>Special <code>getRecversion()</code> attribute in the cursor exists for "recversion" system field value which is necessary for the <a href="#Lost_updates_protection">lost update prevention</a> mechanism.</p>
</div>
<div class="paragraph">
<p>Every cursor has the following methods (<span class="icon"><i class="fa fa-search"></i></span> symbol indicates methods inherited from <code>BasicCursor</code> and usable when working with read-only views and tables):</p>
</div>
</div>
<div class="sect4">
<h5 id="_cursor_closing">Cursor Closing</h5>
<div class="ulist">
<ul>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>close()</strong>  cursor closing (implements a <code>close</code> method of <code>java.io.Closeable</code> interface).
This method frees all JDBC resources allocated during the cursors&#8217;s existence.
A navigation or update method invocation on a closed cursor causes an error.
This method is not necessary to call since it is called automatically after closing <code>CallContext</code> on all cursors created with it.
In general, good practice in programming is to create as few cursors as possible during the procedure and use them repeatedly.
Still if a need arises to create more cursors, e. g. in a loop, one should use <code>close()</code> method at the moment the instance of a cursor is not needed.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_record_navigation_methods">Record Navigation Methods</h5>
<div class="ulist">
<ul>
<li>
<p><strong>tryGet(&#8230;&#8203;)</strong> conducts searching for the record by given key fields and returns <code>true</code> if the record is found or <code>false</code> if the table contains no record with the given primary key.
This method&#8217;s arguments must specify primary key field values and number of arguments must match the number of primary key fields in the table.</p>
</li>
<li>
<p><strong>get(&#8230;&#8203;)</strong>  same as <code>tryGet</code> but throws an exception if the record is not found.</p>
</li>
<li>
<p><strong>tryGetCurrent()</strong>   retrieves a record from the database that corresponds to the fields of current primary key.</p>
</li>
</ul>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>get</code>, <code>tryGet</code> and <code>tryGetCurrent</code> methods do not account for any filters applied to the table.
If needed to find a record while considering filters, use <code>[try]First</code> method.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>navigate(command)</strong>  moves around records relative to the current position.
Returns <code>true</code> if the movement is successful and <code>false</code> if the record is not found.
The <code>command</code> string can be an set of the following symbol commands in any order, executed consecutively until the record is found (or all commands are executed):</p>
<div class="ulist">
<ul>
<li>
<p>- (minus)  go to the first record matching the filter criteria;</p>
</li>
<li>
<p>+ (plus)  go to the last record;</p>
</li>
<li>
<p>&gt;  go to the next record relative to the current matching filter criteria;</p>
</li>
<li>
<p>&lt;  go the the previous record;</p>
</li>
<li>
<p>=  update the current record if it matches current filter criteria.</p>
</li>
</ul>
</div>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>tryFirst()</strong>  same as <code>navigate('-')</code>.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>first()</strong>  same as <code>tryFirst()</code>, but throws an exception if the record is not found.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>tryLast()</strong>  same as <code>navigate('+')</code>.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>last()</strong>  same as <code>tryLast()</code>, but throws an exception if the record is not found.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>next()</strong>  same as <code>navigate('&gt;')</code>.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>previous()</strong>  same as <code>navigate('&lt;')</code>.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>tryFindSet()</strong>  opens a record set (<code>ResultSet</code>) and sets a cursor in its beginning.
Returns <code>true</code> if the opened set is not empty and <code>false</code> if there are no records in the set.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>findSet()</strong>  same as <code>tryFindSet()</code>, but throws an exception if the movement has failed.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>nextInSet()</strong>  go to the next record in the current set.
If the set has not been opened, calling this method equals calling <code>tryFindSet()</code>.
Returns <code>true</code> if the movement is successful and <code>false</code> if the end of the set is reached.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>iterator()</strong>  returns an iterator allowing to perform a full iteration across the whole set of records.
Implements the corresponding <code>java.lang.Iterable</code> interface method.
For example, if <code>rec</code> variable contains an instance of a cursor, the full iteration using <code>iterate()</code> method can be performed as follows:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java"> for (FooCursor r: rec): {
         /* the cycle contains everything
          you want to do with records r */
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>and it will be entirely similar to the following code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (cursor.tryFindSet()) {
    while (cursor.nextInSet()) {
        //cycle
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="dlist">
<dl>
<dt class="hdlist1"><em>What is the difference between <code>[try]First()</code> and <code>[try]FindSet()</code>?</em></dt>
<dd>
<p>The difference is the queries sent to the database. The <code>[try]First()</code> (and <code>navigate()</code>, <code>next()</code> and <code>last()</code>&#8230;&#8203;) execute <code>SELECT TOP 1</code> kind of query, request a single record and immediately close the JDBC ResultSet.
The <code>findSet()</code> method opens ResultSet and keeps it open so it&#8217;s possible to traverse it with the <code>iterate()</code> method.</p>
</dd>
<dt class="hdlist1"><em>What is the difference between <code>navigate("=")</code> and <code>tryGetCurrent()</code>?</em></dt>
<dd>
<p>The <code>navigate()</code> method accounts for current filters while <code>get&#8230;&#8203;()</code> methods do not.
Record with the current primary key value might not get into the filter, so <code>navigate('=')</code> might return <code>false</code> when <code>tryGetCurrent()</code> returns <code>true</code>.</p>
</dd>
<dt class="hdlist1"><em>What does <code>navigate("=&gt;&lt;")</code> mean?</em></dt>
<dd>
<p>This command prescribes the following algorithm: "Try to find the current record.
If the record is found, exit and return <code>true</code>.
If the record does not exist anymore (deleted), go forward.
If the record is found, exit and return <code>true</code>.
If there is nothing there, go back.
If the record is found, exit and return <code>true</code>, if not  <code>false</code>.</p>
</dd>
</dl>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_ranging_and_filtering_methods">Ranging and Filtering Methods</h5>
<div id="set_range_usage" class="ulist">
<ul>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>setRange(ColumnMeta&lt;?&gt; column)</strong>  resets any filter in the field.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>setRange(ColumnMeta&lt;? super T&gt; column, T value)</strong>  sets a single-value range in the field.
Passing <code>null</code> as an argument causes setting an 'IS NULL' filter in that field.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>setRange(ColumnMeta&lt;? super T&gt; column, T valueFrom, T valueTo)</strong>  sets range "from &#8230;&#8203; to and including" in the field (at the SQL language level corresponds to a BETWEEN operator).
It is not allowed to use <code>null</code> as an argument.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>setFilter(ColumnMeta&lt;?&gt; column, String value)</strong>  sets a filter in the field, filter expressions are described  <a href="#setFilter_usage">below</a>.</p>
</li>
</ul>
</div>
<div id="set_complex_filter_usage" class="ulist">
<ul>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>setComplexFilter(String value)</strong>  sets a complex filter to the table.
Corresponds to a <code>WHERE</code> condition for queries in CelestaSQL.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>setIn(BasicCursor auxiliaryCursor)</strong>  sets a filter with a nested query.
<code>setIn</code> use is described <a href="#setIn_usage">below</a>.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>limit(long skip, long limit)</strong>  sets limits to the returned row range.
Parameters must be non-negative integers.
The <code>skip</code> parameter is the number of rows skipped before returning (<code>skip = 0</code>  start from the very beginning), the <code>limit</code> parameter is the maximum number of returned rows, where <code>limit = 0</code> indicates that <strong>all</strong> rows are returned.
Call <code>limit(0, 0)</code> to reset limits to the returned row range.
Limits set using the <code>limit()</code> method are not accounted for when calling the <code>count()</code> method.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>orderBy(ColumnMeta&lt;?&gt;&#8230;&#8203; columns)</strong>  set sorting.
Parameters are a set of fields for sorting.
To specify ascending or descending sorting use an <code>asc()</code> or <code>desc()</code> method for respective fields.
If the <code>asc()</code> or <code>desc()</code> method is not called explicitly, ascending sorting is performed.
It is allowed to call <strong>orderBy()</strong> without arguments to reset all previous sortings to default.
The field can be specified only in not more than one <strong>orderBy(&#8230;&#8203;)</strong> method arguments.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Keep in mind that Celesta does not operate unsorted data sets: Celesta data sets are always sorted by primary key fields by default.
Celesta implicitly adds the primary key fields to every field set defined in <code>orderBy(&#8230;&#8203;)</code>.
For views and <code>WITH READ ONLY</code> tables lacking primary key fields, Celesta uses the <strong>first field</strong> for default sorting.
All of this allows for deterministic iteration over cursor records.</p>
</div>
</div>
<div class="sect4">
<h5 id="_initialization_methods">Initialization Methods</h5>
<div class="ulist">
<ul>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>reset()</strong>  resets filters and sorting without affecting the buffer field values.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>clear()</strong>  resets filters and sorting and performs a full buffer clearing, including key fields.</p>
</li>
<li>
<p><strong>init()</strong>  clears all buffer fields except for key fields.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_copying_methods">Copying Methods</h5>
<div class="ulist">
<ul>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>copyFiltersFrom(BasicCursor c)</strong>  copies all filter values including limit (skip and limit) from the cursor of the same type to the current cursor.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>copyOrderFrom(BasicCursor c)</strong>  copies sorting settings from the cursor of the same type to the current cursor.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>copyFieldsFrom(BasicCursor c)</strong>  copies all fields from the cursor of the same type to the current cursor.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_data_modification_methods">Data Modification Methods</h5>
<div class="ulist">
<ul>
<li>
<p><strong>insert()</strong>  inserts the cursor contents to the database.
If a record with a matching primary key already exists, an error occurs.</p>
</li>
<li>
<p><strong>tryInsert()</strong>  inserts the cursor contents to the database, <code>true</code> if successful, <code>false</code> if a record with a matching primary key already exists.</p>
</li>
<li>
<p><strong>update()</strong>  saves the cursor contents to the database, throws an exception in case a record with such key fields is not found.</p>
</li>
<li>
<p><strong>tryUpdate()</strong>  saves the cursor contents to the database, <code>true</code> if successful, <code>false</code> if a record with a matching primary key does not exist.</p>
</li>
<li>
<p><strong>delete()</strong>  deletes the current record.</p>
</li>
<li>
<p><strong>deleteAll()</strong>  deletes all records matching the filter.
Note: <code>onDelete</code> trigger is not called.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_auxiliary_methods">Auxiliary Methods</h5>
<div class="ulist">
<ul>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>canRead(), canInsert(), canModify(), canDelete()</strong>  returns a Boolean value indicating if the current session has rights to perform a corresponding operation.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>count()</strong>  returns a number of records in a filtered set.
In particular, if there are no filters set for the cursor, it returns the total amount of records in the table.
Record set limits set with a "limit()" method are not taken into account when calling the "count()" method.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>callContext()</strong>  returns the call context that was used to create this cursor.</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>meta()</strong>  returns a table or view description (score, org.javacc.test.celesta.Table/View class instance).</p>
</li>
<li>
<p><span class="icon"><i class="fa fa-search"></i></span> <strong>asCSVLine()</strong>  returns cursor field values as a CSV string.</p>
</li>
<li>
<p><strong>getMaxStrLen(ColumnMeta&lt;String&gt;)</strong>  returns text field length (in characters).
Necessary to determine length to which the sting sent to the database  must be cropped.
Returns -1, if the field is defined as "TEXT".</p>
</li>
<li>
<p><strong>getXRec()</strong>  returns a <a href="#xrec_section">buffer copy</a> containing values received during the latest reading from the database.</p>
</li>
</ul>
</div>
<div id="try_method_notice" class="paragraph">
<p>Please note that <code>get</code>, <code>first</code>, <code>insert</code> and <code>update</code> methods have two versions: without a <code>try</code> prefix (simply <code>get(&#8230;&#8203;)</code>, etc.) and with it (<code>tryGet(&#8230;&#8203;)</code>, <code>tryFirst(&#8230;&#8203;)</code>, etc.).</p>
</div>
<div class="paragraph">
<p>Methods without a <code>try</code> prefix throw an exception if the database does not contain matching data to perform an action.
For example, <code>first()</code> throws an exception if no records match the filter set for the cursor (or in a degenerated case the table is empty).
The <code>get</code> and <code>update</code> methods throw an exception if the matching record does not exist and the <code>insert</code> method fails if a record with the given set of primary key values already exists.
At the same time, methods with the <code>try</code> prefix do not throw exceptions, returning Boolean values instead, indicating that the respective operation was successful or failed.</p>
</div>
<div class="paragraph">
<p>Good business logic code development practice is to use methods WITHOUT the <code>try</code> prefix whenever possible.
It allows the code to be "self-testing" notifying about errors in logic and/or database data.
For example, if during a procedure development we want the <code>idFoo</code> variable to contain an ID of an entry existing in the <code>foo</code> table when the application runs correctly, to get the record itself we should write <code>foo.get(idFoo)</code>.
In this case, if the programme has a bug causing <code>idFoo</code> to be assigned with a non-existing ID, developers and users will be notified about it the moment the problem occurs.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>"Hiding" possible issues by using <code>try</code>&#8230;&#8203; methods when there is no real need to use them may complicate debugging and destabilize the code.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Certainly, in some situations it is necessary to find out if there is an entry with a certain ID. And <code>tryGet</code> method should be used ONLY in such cases.
This is true for other <code>try</code> methods, their use is justified almost exclusively when it is explicitly intended to use the returned values of these methods.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setFilter_usage">4.3.2. Usage of a setFilter Method</h4>
<div class="paragraph">
<p>In most cases cursor filtering by field value can be implemented using <code>setRange(&#8230;&#8203;)</code> methods with two or three arguments.
This method filters values by "field = value" condition or "field between value1 and value2" condition.</p>
</div>
<div class="paragraph">
<p>When simple comparison and a "between" condition is not enough, <code>setFilter</code> method allows to apply a more complex condition to values in one of the cursor fields.
First <code>setFilter</code> method argument is the field and the second is the filter expression.</p>
</div>
<div class="paragraph">
<p>Correct filter expression can consist of:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>numeric or text literals (depending on the field type);</p>
</li>
<li>
<p>a <code>null</code> literal;</p>
</li>
<li>
<p>logical operators "&amp;", "|" and "!";</p>
</li>
<li>
<p>comparison operators "&lt;", "&gt;" and "..";</p>
</li>
<li>
<p>grouping brackets "(" and ")";</p>
</li>
<li>
<p>special operators "@" and "%" for text fields.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Filter expression cannot be a <code>null</code> or an empty string, call <code>setRange()</code> method without any parameters to reset  filter for the field.
Spaces between literals and operators are ignored.
The filter expression is translated directly without any optimization into a condition for a <code>WHERE</code> expression in SQL language.</p>
</div>
<div class="sect4">
<h5 id="_filter_expressions_for_bit_and_blob_type_fields">Filter Expressions for BIT and BLOB Type Fields</h5>
<div class="paragraph">
<p>It is possible to use null and !null type filter expression for BIT and BLOB type fields, filtering "field is null" and "not (field is null)" values:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="bit_blob_filter.svg" alt="bit blob filter" width="215" height="75">
</div>
</div>
<div class="paragraph">
<p>Other types of filtering are meaningless for BLOB type. The filters for <code>true</code> and <code>false</code> BIT values can be set using a <strong>setRange(&#8230;&#8203;)</strong> method.</p>
</div>
</div>
<div class="sect4">
<h5 id="_filter_expressions_for_integer_and_real_type_fields">Filter Expressions for INTEGER and REAL Type Fields</h5>
<div class="paragraph">
<p>Filter expression for INTEGER and REAL type fields have the following syntax:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="filter.svg" alt="filter" width="386" height="172">
</div>
</div>
<div class="paragraph">
<p>Here</p>
</div>
<div class="ulist">
<ul>
<li>
<p>&amp;  logical AND symbol;</p>
</li>
<li>
<p>|  logical OR symbol;</p>
</li>
<li>
<p>!  logical NOT symbol;</p>
</li>
<li>
<p>( and )  grouping brackets.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <strong>term</strong> expression for numeric fields uses the following syntax:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="filter_numeric_term.svg" alt="filter numeric term" width="566" height="213">
</div>
</div>
<div class="paragraph">
<p>For example, filter expression</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(10|&lt;5)&amp;&gt;0</pre>
</div>
</div>
<div class="paragraph">
<p>for a field named "foo" translates into a condition</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">("foo" = 10 or "foo" &lt; 5) and "foo" &gt; 0</code></pre>
</div>
</div>
<div class="paragraph">
<p>Symbols "&gt;" and "&lt;" set conditions "strictly greater" and "strictly less" respectively and the usage of a symbol ".." allows to set conditions like "greater or equal" and "less or equal".
So the filter</p>
</div>
<div class="listingblock">
<div class="content">
<pre>..0|5..7|10..</pre>
</div>
</div>
<div class="paragraph">
<p>translates into a condition</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">"foo" &lt;= 0 or "foo" between 5 and 7 or "foo" &gt;= 10</code></pre>
</div>
</div>
<div class="paragraph">
<p>(keep in mind that operator "between" in SQL sets range including bounds).</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Note that filter expression requires explicit grouping with brackets of different logical operators, i.e. the following expressions are correct:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>(10|&lt;5)&amp;&gt;0
10|(&lt;5&amp;&gt;0)
10|&lt;5|&gt;0</pre>
</div>
</div>
<div class="paragraph">
<p>but this expression causes an error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>10|&lt;5&amp;&gt;0</pre>
</div>
</div>
<div class="paragraph">
<p>because it lacks grouping brackets explicitly indicating the sequence of calculating OR and AND operators.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect4">
<h5 id="_filter_expressions_for_datetime_type_fields">Filter Expressions for DATETIME Type Fields</h5>
<div class="paragraph">
<p>Filter expressions for DATETIME type fields have the same syntax as numeric fields, but instead of <strong>&lt;numeric literal&gt;</strong> data numeral is used in 'YYYYMMDD' format (a single-quote, eight digits, a single-quote).
So correct filter expressions for date field look as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">'20131124'
'20131124'..'20151211'|'20111111'
(&gt;'20131124'&amp;..'20151211')|'20111111'..</code></pre>
</div>
</div>
<div class="paragraph">
<p>Each RDBMS operates date literals in its own way, but Celesta translates filter expressions into conditions correctly processed in each supported RDBMS.</p>
</div>
</div>
<div class="sect4">
<h5 id="_filter_expressions_for_varcharn_and_text_type_fields">Filter Expressions for VARCHAR(n) and TEXT Type Fields</h5>
<div class="paragraph">
<p>Filter expressions for text fields resemble those for numeric fields.
The only exception is that term expressions contain string literals in single-quotes instead of numerics.
For example, in a text field the <strong>'aa'|'bb'|'cc'</strong> filter is correct, filtering records with filtered field values equal "aa", "bb" or "cc".
At the same time, if it is necessary to filter a text containing a single-quote, the quote should be doubled in its text literal (as is usual in SQL): to filter "John&#8217;s company" values 'John''s company' has to be written.
As with other field types, text fields can be filtered by null / not null value using null/!null terms.</p>
</div>
<div class="paragraph">
<p>It is also possible to filter text field using a LIKE operator with a special symbol "%" meaning any combination of symbols and indicate that filter is independent from the register with a special symbol "@".</p>
</div>
<div class="paragraph">
<p>To be precise, filter terms for text fields have the following syntax:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="filter_text_term.svg" alt="filter text term" width="602" height="280">
</div>
</div>
<div class="paragraph">
<p>So the expression</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">('aaa'&amp;'bb')|(!'ddd'&amp;!null)</code></pre>
</div>
</div>
<div class="paragraph">
<p>translates into</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">(("foo" = 'aaa' and "foo" = 'bb') or (not ("foo" = 'ddd') and not ("foo" is null))</code></pre>
</div>
</div>
<div class="paragraph">
<p>(which is never yields true, obviously  this and the next examples only illustrate filter translation into SQL).</p>
</div>
<div class="paragraph">
<p>Expression</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">@'q'|@..'cC'|@'Ff'..|@'a'..'b'|@%'5a'|'abc'%|! @ %'ef'%|null</code></pre>
</div>
</div>
<div class="paragraph">
<p>with symbols "@" translates into</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">UPPER("foo") = 'Q' or UPPER("foo") &lt;= 'CC' or UPPER("foo") &gt;= 'FF' or UPPER("foo") between 'A' and 'B'
or UPPER("foo") like '%5A' or "foo" like 'abc%' or not (UPPER("foo") like '%EF%') or "foo" is null</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="setIn_usage">4.3.3. Usage of a setIn Method</h4>
<div class="paragraph">
<p>The <strong>setFilter</strong> method allows to filter records with their fields taking values from a predefined set.
For example,</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">myCursor.setFilter(myCursor.COLUMNS.city_id(), "'MSK'|'LON'");</code></pre>
</div>
</div>
<div class="paragraph">
<p>filters records with "city code" equal to MSK or LON.
A call</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">myCursor.setFilter(myCursor.COLUMNS.city_id(), "'M'%");</code></pre>
</div>
</div>
<div class="paragraph">
<p>filters records with city code starting with a Latin "M".</p>
</div>
<div class="paragraph">
<p>But sometimes <strong>setFilter</strong> functionality is not enough: what if records have to be filtered by cities located in a certain region or country?
Here is one of the ways to solve this problem: filter city catalogue by <code>city.setRange(city.COLUMNS.country_id(), "RUS")</code>, then upload the full list of these cities IDs from the database to the memory, group them in a single filter string separated by pipes and apply this filter to another cursor.
Surely this is not an optimal solution if there are too many records matching the filter: it will result in excessive data transmission over the network and a overly long SQL query to the corresponding table.</p>
</div>
<div class="paragraph">
<p>In this case, a <code>setIn</code> method is used, allowing to set a filter with an auxiliary query for the chosen field set.
It is available for <code>Cursor</code> and <code>ViewCursor</code> subclasses.</p>
</div>
<div class="paragraph">
<p>The general schema of the <code>setIn</code> method operation is the following:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>set filters to the target and auxiliary cursors (in the example above <code>myCursor</code> is target and <code>city</code> is auxiliary);</p>
</li>
<li>
<p>couple the fields between target and auxiliary cursors.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Coupling is done with a <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/filter/value/FieldsLookup.html"><code>FieldsLookup</code></a> class, returned as a target cursor <code>setIn</code> method result.
The <code>setIn</code> method receives the auxiliary cursor used to look for data intersection as a single argument.
Preparing the target cursor, gathering pairs of columns and further setting the filter is done this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">TargetCursor a = new TargetCursor(context);
AuxiliaryCursor b = new AuxiliaryCursor(context);
b.setRange(b.COLUMNS.foo(), "bar");
a.setIn(b)
     .add(a.COLUMNS.a1(), b.COLUMNS.b1())
     .add(a.COLUMNS.a2(), b.COLUMNS.b2());</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this example, to access the <code>a</code> cursor records PostgreSQL will generate the following SQL expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT ... FROM Target WHERE ( a1, a2 ) IN (SELECT b1, b2 FROM Auxiliary WHERE Auxiliary.foo = 'bar' )</code></pre>
</div>
</div>
<div class="paragraph">
<p>Any number of auxiliary cursors can be attached to the target using the <code>FieldsLookup</code> class <code>and</code> method.
Auxiliary cursors will not interfere with each other.
An example for setting several auxiliary cursors is given below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">TargetCursor a = new TargetCursor(context);
a.setRange(a.COLUMNS.afoo(), "aBar");
AuxiliaryCursor b = new AuxiliaryCursor(context);
b.setRange(b.COLUMNS.bFoo(), "bBar");
Auxiliary2Cursor c = new Auxiliary2Cursor(context);
c.setRange(c.COLUMNS.cFoo(), "cBar");
a.setIn(b)
     .add(a.COLUMNS.a1(), b.COLUMNS.b1())
     .add(a.COLUMNS.a2(), b.COLUMNS.b2());
.and(c)
     .add(a.COLUMNS.a1(), c.COLUMNS.c1());</code></pre>
</div>
</div>
<div class="paragraph">
<p>For this example, to access the <code>a</code> cursor records in PostgreSQL Celesta will generate the following SQL expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">SELECT ...
FROM Target
WHERE aFoo = 'aBar'
    AND ( a1, a2 ) IN (SELECT b1, b2 FROM Auxiliary WHERE Auxiliary.bFoo = 'bBar' )
    AND (a1) IN (SELECT c1 FROM Auxiliary2 WHERE Auxiliary2.cFoo = 'cBar' )</code></pre>
</div>
</div>
<div class="paragraph">
<p>This filter has a set of restrictions, which, when violated, cause throwing the exceptions during the execution of  <code>FieldsLookup.add</code> and <code>BasicCursor.setIn</code> methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Data types in each pair of compared fields must fully match.</p>
</li>
<li>
<p>Each table must have an index containing all columns from compared column sets: in the example above the <code>Target</code> table must have an <code>I1(a1, a2,..)</code> index and the <code>Auxiliary</code> table  an <code>I2(b1, b2,&#8230;&#8203;)</code> index.</p>
</li>
<li>
<p>For table cursors the corresponding indices should start with compared columns.
In this example, if <code>I1(a1, a2,..)</code> and <code>I2(b1, b2,&#8230;&#8203;)</code> indices are present, the following code throws an exception as <code>a2</code> and <code>b2</code> fields are not in the beginning of <code>I1</code> and <code>I2</code> indices:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">a.setIn(b).add(a.CURSORS.a2(), b.CURSORS.b2());</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sequence_class">4.3.4. Sequence Class</h4>
<div class="paragraph">
<p>The <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/Sequence.html">Sequence</a> class allows to work with sequences.
Unlike other access classes, during its code generation, a <code>Sequence</code> prefix is used instead of <code>Cursor</code>.
Sequence class has a single <code>nextValue</code> method allowing to get the next sequence value as a <code>long</code> integer.</p>
</div>
<div class="paragraph">
<p>Below is an example of using a <code>Sequence</code> access class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE SCHEMA sequences version '1.0';
CREATE SEQUENCE idNumerator START WITH 3;</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">IdNumeratorSequence sq  = new IdNumeratorSequence(ctx);
//prints the next value starting with 3.
System.out.println(sq.nextValue());</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_permissions_management_and_change_logging">4.3.5. Permissions Management and Change Logging</h4>
<div class="paragraph">
<p>Working with data using data access classes not only allows to write universal RDBMS-agnostic code, but also to get around the issues of centralized permissions management and data changes logging.</p>
</div>
<div class="paragraph">
<p>Calling some of the methods requires users to have corresponding permissions for tables, set in system tables <code>celesta.userroles</code> and <code>celesta.permissions</code>, otherwise a  <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/PermissionDeniedException.html"><code>PermissionDeniedException</code></a> exception occurs with a message "There is no &#8230;&#8203; permission for user &#8230;&#8203; on object &#8230;&#8203;".</p>
</div>
<div class="paragraph">
<p>If tables change logging is set up in the <code>celesta.logsetup</code> table, calling certain methods will result in creating entries in the <code>celesta.log</code> table.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 14.2857%;">
<col style="width: 28.5714%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">Method</th>
<th class="tableblock halign-center valign-middle">Required permissions</th>
<th class="tableblock halign-center valign-middle">Change logging</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[try]first()</code>,
<code>[try]get()</code>,
<code>next()</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">read permission (r)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">not logged</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[try]insert()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">insert permission (i)</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>logged if the "i" flag is set.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>oldvalues</code>  empty value.</p>
</li>
<li>
<p><code>newvalues</code>  inserted record.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[try]update()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">modification permission (m)</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>logged if the "m" flag is set.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>oldvalues</code>  record field values before modification.</p>
</li>
<li>
<p><code>newvalues</code>  record field values after modification.</p>
</li>
</ul>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>delete[All]()</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">deletion permission (d)</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>delete()</code> is logged if the "d" flag is set.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>oldvalues</code>  record field values before deletion.</p>
</li>
<li>
<p><code>newvalues</code>  empty value.</p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<code>deleteAll()</code> is not logged and triggers for this method are not executed.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Other methods do not require table access rights and calling them is not logged.
I.e. it is possible to define a cursor, set its filters and even count the number of entries meeting its conditions with a <code>count()</code> method without even a permission to read the table.</p>
</div>
<div class="paragraph">
<p>It is up to the developer to decide whether to use access permission management and logging mechanism or not.
If these features are not used, the potential performance overhead is minimized.</p>
</div>
</div>
<div class="sect3">
<h4 id="BLOB_fields">4.3.6. BLOB Fields</h4>
<div class="paragraph">
<p>BLOB fields allow to store huge amounts of information in table cells, even entire files with documents.
Work with these fields using cursors is different from work with other field types.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Cursor fields corresponding to BLOB fields have a <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BLOB.html"><code>BLOB</code></a> data type.</p>
</li>
<li>
<p>There is only one way to receive an instance of a BLOB class and assign it to a cursor field: by calling a <code>calc&lt;field ID&gt;()</code> method in the cursor.
For example, if the BLOB field is named <code>foo</code>, the corresponding cursor method is named <code>calcfoo()</code> and the corresponding cursor field is assigned a value after this method is called.</p>
</li>
<li>
<p>Unlike fields of other types, when a record is read with <code>get()</code>, <code>next()</code> or other similar methods, BLOB field values are not fetched from the database and are always assigned <code>null</code> instead.
A <code>calc&#8230;&#8203;()</code> method is called to read a BLOB field.
If the cursor&#8217;s primary key fields reference an existing record in the table, calling the <code>calc&#8230;&#8203;()</code> causes reading BLOB contents from the database to RAM.
This is why <code>calc&#8230;&#8203;()</code> should only be called when it is intended to read or modify BLOB contents.</p>
</li>
<li>
<p>A corresponding cursor field is initialized by a <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BLOB.html"><code>BLOB</code></a> type object after calling a <code>calc&lt;field name&gt;()</code> method.
Methods for this object allow to read and modify its contents and are described below.
After modifying BLOB object contents, an <code>update()</code> or <code>insert()</code> method should be used.</p>
</li>
<li>
<p>If BLOB must be deleted from the database and a <code>NULL</code> value assigned to the corresponding table field, a <code>setNull()</code> BLOB object method is used and then <code>update()</code> method is called.
Assigning a <code>null</code> value via a setter will not work, unlike with other field types, because the system will interpret it as if BLOB is not read from the database and <code>update()</code> will not change anything.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BLOB.html"><code>BLOB</code></a> class methods:</p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">getInStream()</dt>
<dd>
<p>Returns a <a href="https://docs.oracle.com/javase/8/docs/api/java/io/InputStream.html"><code>java.io.InputStream</code></a> class instance allowing to read the cursor contents or <code>null</code> if the database table cell contains a NULL value.
This method can be called multiple times and a new stream reading the BLOB from the beginning is created each time.</p>
</dd>
<dt class="hdlist1">getOutStream()</dt>
<dd>
<p>Deletes all BLOB data from the memory (if there were any) and creates a new instance of <a href="https://docs.oracle.com/javase/8/docs/api/java/io/OutputStream.html"><code>java.io.OutputStream</code></a>, in which data for BLOB can be saved.
It is worth mentioning, that every <code>getOutStream()</code> method invocation deletes all data from the BLOB in the memory, even if nothing is going to be written into the resulting stream.
Another important thing is that this method modifies only the data in a BLOB in-memory representation, actual recording in the database is performed only after calling <code>insert()</code> or <code>update()</code> methods on the cursor.</p>
</dd>
<dt class="hdlist1">setNull()</dt>
<dd>
<p>Sets a <code>NULL</code> value for BLOB.</p>
</dd>
<dt class="hdlist1">isModified()</dt>
<dd>
<p>Returns <code>true</code>, if initial object data is modified using <code>getOutStream()</code> or <code>setNull()</code> calls.</p>
</dd>
<dt class="hdlist1">size()</dt>
<dd>
<p>Returns the internal BLOB data size in bytes.</p>
</dd>
</dl>
</div>
<div class="paragraph">
<p>Examples of code for a BLOB field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">OrderLineCursor line = new LineCursor(context);
//Hereinafter line.dat is assumed to be a BLOB field
. . .
//Writing example
line.calcDat();
try(OutputStreamWriter osw = new OutputStreamWriter(
    line.getDat().getOutStream(), StandardCharsets.UTF_8)){
    osw.append("hello, blob field!");
}
. . .
//Reading example
line.calcDat();
InputStream ins = line.getDat().getInStream();
//Keep in mind that the field may contain NULL
if (Objects.nonNull(ins)){
    try ( BufferedReader inr = new BufferedReader(
        new InputStreamReader(ins, StandardCharsets.UTF_8))) {
        //BLOB field contents is sent to the console,
        //for example, 'hello, blob field!'
                System.out.println(inr.readLine());
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="Option_fields">4.3.7. Option Fields</h4>
<div class="paragraph">
<p>Often fields in relational databases can be assigned only a few values from a limited list.
For example, the "state" field may have only "new", "processing", "finished" or "error" values and nothing else.</p>
</div>
<div class="paragraph">
<p>It is not feasible to create a separate reference tables or foreign keys since the list contains only a few values.
Using integer values with specific "meaning" often helps to optimize table size and speed up processing.
Like this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>0  new;</p>
</li>
<li>
<p>1  processing;</p>
</li>
<li>
<p>2  finished;</p>
</li>
<li>
<p>3  error.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Celesta supports simplified work with such fields.</p>
</div>
<div class="paragraph">
<p>To declare that the field is only allowed to have values from a certain list, an <code>option</code> property is set in an integer or text <a href="#CelestaDoc">CelestaDoc</a> field.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">create table foo
  ...
  /**integer state field
  {option: [new, processing, finished, error]}*/
  state int,
  /**text state field
  {option: [created, closed]*/
  state2 varchar(6)</code></pre>
</div>
</div>
<div class="paragraph">
<p>When compiling data access class Celesta reads the <code>option</code> property and generates auxiliary code to facilitate using values from the list.</p>
</div>
<div class="paragraph">
<p>For example, two auxiliary classes are created automatically in the <code>fooCursor</code> class for our <code>foo</code> table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static final class State {
    public static final Integer new = 0;
    public static final Integer processing = 1;
    public static final Integer finished = 2;
    public static final Integer error = 3;
    private State() {}
}
public static final class State2 {
    public static final String created = "created";
    public static final String closed = "closed";
    private State() {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note: possible values for integer fields are numbered automatically and for text fields text values literally match their names.
The solution developer may refer to possible values in the following manner:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooCursor foo = new FooCursor(context)
foo.setRange(foo.COLUMNS.state(), FooCursor.State.finished)
if (FooCursor.State2.closed.equals(foo.getState2()){
    ....
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="dynamic_access">4.3.8. Dynamic Access to Data</h4>
<div class="paragraph">
<p>When writing universal data processing procedures (like export/import procedures) the issue of dynamic access to data arises in case the table/view/sequence name is known not at the stage of code writing but during execution.</p>
</div>
<div class="paragraph">
<p>To create a data access class instance when only a <a href="#Celesta_metadata">metadata</a> object is known, it is possible to use a static factory <code>create</code> method of the corresponding basic data access class, for example:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/Cursor.html#create--"><code>Cursor.create(Table table, CallContext callContext)</code></a></p>
</li>
<li>
<p><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/ViewCursor.html#create--"><code>ViewCursor.create(View view, CallContext callContext)</code></a></p>
</li>
<li>
<p><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/Sequence.html#create--"><code>ViewCursor.create(SequenceElement sequence, CallContext callContext)</code></a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>and so on.
<code>Cursor</code> and <code>ViewCursor</code> classes also have an overloaded version of the <code>create</code> method allowing to create data access object instances <a href="#limit_columns">with limited set of columns</a>.</p>
</div>
<div class="paragraph">
<p>Dynamic access to table or view cursor fields in the <code>BasicCursor</code> class is performed using the following methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BasicCursor.html#getValue--"><code>BasicCursor.getValue(String name)</code></a></p>
</li>
<li>
<p><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/dbutils/BasicCursor.html#setValue--"><code>BasicCursor.setValue(String name, Object value)</code></a></p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="triggers_section">4.4. Triggers</h3>
<div class="paragraph">
<p>Trigger is a (lambda) function, which is written by the solution developer.
It accepts a cursor instance as an argument and is attached to the cursor class.
It is automatically called during record insertion, deletion and modification.
Trigger type looks like this: <a href="https://docs.oracle.com/javase/8/docs/api/index.html?java/util/function/Consumer.html"><code>Consumer&lt;? super YourCursor&gt;</code></a>.</p>
</div>
<div class="paragraph">
<p>When <code>insert()</code>, <code>update()</code> or <code>delete()</code> actions are performed, the system calls certain solution developer-defined pre- and post-triggers (performed, respectively, before and after modifying the data in the database).
This means there are six trigger types in total:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">pre-triggers</th>
<th class="tableblock halign-center valign-middle">post-triggers</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">onPreInsert</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">onPostInsert</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">onPreUpdate</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">onPostUpdate</p></td>
</tr>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">onPreDelete</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">onPostDelete</p></td>
</tr>
</tbody>
</table>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
It often makes sense to use pre-triggers to perform certain action before the update is sent to the database.
Note that since <code>onPreInsert</code> trigger is executed before sending cursor contents to the database, values of fields with <code>DEFAULT</code> or <code>GETDATE()</code> properties are not filled in at the moment of its execution.
Assign a <code>null</code> value to them to automatically assign them with values computed by the database.
During the <code>onPostInsert</code> trigger execution these fields are already assigned.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It is convenient to use <a href="#xrec_section">xRec objects</a> in <code>onPreUpdate</code> triggers to determine exactly what fields are going to be modified in the table.
Using <code>xRec</code> in <code>onPreDelete</code> trigger does not make sense because by the time the trigger is called it becomes equal to the current buffer.</p>
</div>
<div class="paragraph">
<p>Tables may have any number of triggers of each type.
For every table triggers can be set with <strong>static</strong> <code>onPreInsert</code>, <code>onPreDelete</code> and other methods of cursor classes.
Defining triggers with static methods makes them "global", i.e. they get executed at every interaction with the table.</p>
</div>
<div class="paragraph">
<p>Since the trigger registration method requires specifying the <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/Celesta.html"><code>Celesta</code></a> class instance, it is convenient to use <code>@PostConstruct</code> method to register triggers in Spring applications:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Service
public class MyService {

    @Autowired
    private ICelesta celesta;

    @PostConstruct
    public void init(){
        MyCursor.onPreInsert(celesta, c -&gt;
                System.out.printf("Record %s is going to be inserted!%n", c.getId()));
    }

    . . .
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>MyCursor</code> code generated class has the following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public static void onPreInsert(ICelesta celesta, Consumer&lt;? super MyCursor&gt; cursorConsumer)</code></pre>
</div>
</div>
<div class="paragraph">
<p>System cursors (from the <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/syscursors/package-summary.html"><code>ru.curs.celesta.syscursors</code></a> package) also support trigger registration.</p>
</div>
</div>
<div class="sect2">
<h3 id="xrec_section">4.5. xRec Object</h3>
<div class="paragraph">
<p><code>xRec</code> object returned by the <code>getXRec()</code> method is used primarily in <code>onPreUpdate</code> <a href="#triggers_section">triggers</a>.
It is possible to see what exactly has changed in the record by comparing <code>xRec</code> fields with the current values.</p>
</div>
<div class="paragraph">
<p><code>xRec</code> stores field values received during the latest reading of the cursor from the database (unlike main buffer, which fields are equal to <code>xRec&#8217;s fields, but then change when user assigns them new values).
`xRec</code> object is updated only during the following operations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>[try]first()</code>;</p>
</li>
<li>
<p><code>[try]get()</code>;</p>
</li>
<li>
<p><code>next()</code>;</p>
</li>
<li>
<p><code>[try]insert()</code> (the system essentially executes a <code>get()</code> operations for the cursor to read values issued by the database to <code>IDENITY</code>, <code>GETDATE()</code> and <code>DEFAULT</code> fields to simultaneously update the main buffer and <code>xRec</code>);</p>
</li>
<li>
<p><code>[try]update()</code> (after an update in the database <code>xRec</code> becomes a copy of the current cursor);</p>
</li>
<li>
<p><code>delete()</code> (after an update in the database <code>xRec</code> is filled with the buffer value as it was before deletion).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Note that <code>xRec</code> values in pre- and post-triggers differ!</p>
</div>
</div>
<div class="sect2">
<h3 id="Lost_updates_protection">4.6. Lost Updates Prevention</h3>
<div class="sect3">
<h4 id="_what_are_lost_updates">4.6.1. What are Lost Updates?</h4>
<div class="paragraph">
<p>Let us consider the following scenario to illustrate the lost update notion.</p>
</div>
<div class="paragraph">
<p>Assume the application has a table listing clients and users allowed to edit that table using form-cards.
Assume the events occur as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>User  opens a client&#8217;s card to edit its postal index.</p>
</li>
<li>
<p>User B opens the client&#8217;s card on it own device independently from user A to edit the client&#8217;s credit limit.</p>
</li>
<li>
<p>User B changes the "credit limit" field value and saves the card.
Information from user B is recorded in the database, but user A is still working with their copy of the card where the "credit limit" field value is still not updated.</p>
</li>
<li>
<p>User A finishes editing the client&#8217;s postal index and saves their copy of the card.
All fields are saved to the database, including the old credit limit.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This means the work of user B is lost!</p>
</div>
<div class="paragraph">
<p>This is the most common example, but in practice a developer might face lost updates in much more trivial cases not involving multiuser operation.
Assume that a single table is modified by two cursors:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooTableCursor rec1 = new FooTableCursor(context);
FooTableCursor rec2 = new FooTableCursor(context);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assume that at a certain moment both cursors receive data of the same record as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">rec1.get(1);
rec2.copyFieldsFrom(rec1);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Assume the <code>FooTable</code> table entry has an "id = 1" and consists only of three fields:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 20%;">
<col style="width: 40%;">
<col style="width: 40%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-middle">id</th>
<th class="tableblock halign-center valign-middle">field1</th>
<th class="tableblock halign-center valign-middle">field2</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-center valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">oldvalue</p></td>
<td class="tableblock halign-center valign-top"><p class="tableblock">oldvalue</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>And now both cursors perform entry modification:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">rec1.setField1("newvalue");
rec1.update();
//the record already exists in rec1 and in the database 1 | newvalue | oldvalue
//but in rec2 there is still                 1 | oldvalue | oldvalue
rec2.setField2("newvalue");
rec2.update();
//now the database has an entry 1 | oldvalue | newvalue ???</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we see, bad code may cause lost updates even during single-user operation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_methods_of_preventing_lost_updates">4.6.2. Methods of Preventing Lost Updates</h4>
<div class="paragraph">
<p>Generally, there are two approaches to prevent lost updates:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Pessimistic lock: when editing entries somewhere in the application, entry is first marked as locked and no other script or user can work with it until previous editor finishes their work by updating the entry or by cancelling the editing.</p>
</li>
<li>
<p>Optimistic lock: any user and any script can start editing the entry, but the moment the entry is read from the database, the entry version number is also fetched.
During saving, the number of the version being saved is checked against the number in the database.
If the number matches, the entry is saved and the version number in the database gets incremented; if the saved version number is lower than the one in the database, the user gets an error, a message that someone has changed the entry before them and an advise to read the entry again.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Naturally, every method has its drawbacks.</p>
</div>
<div class="paragraph">
<p>The main optimistic lock drawback is that the user cannot write the result of their work to the database if somebody else managed to update the entry before they did.
Still, it rarely happens in practice and only the most sluggish users who take too long to edit entries suffer from it.</p>
</div>
<div class="paragraph">
<p>Main pessimistic lock drawback is that the user is expected to explicitly commit or cancel editing to unlock the entry.
But in practice when the editing goes on for excessive periods of time it is impossible to guess if the user is going to properly end editing or some external intervention by administrators is needed to explicitly unlock the entry, otherwise other users will not be able to work with it.</p>
</div>
<div class="paragraph">
<p>In general, for systems like Celesta pessimistic lock drawbacks are much more severe, so Celesta uses optimistic lock to prevent lost updates.</p>
</div>
</div>
<div class="sect3">
<h4 id="_lost_update_prevention_in_celesta">4.6.3. Lost Update Prevention in Celesta</h4>
<div class="paragraph">
<p>By default, every table in Celesta is supplied with a <code>INT NOT NULL</code> type <code>recversion</code> system field.</p>
</div>
<div class="paragraph">
<p>This field is created automatically, so the developer should not include it in the <code>CREATE TABLE</code> script.
The developer also cannot create their own field named <code>recversion</code>.
Access to the field is provided by a <code>getRecversion()</code> method just like to any ordinary field.</p>
</div>
<div class="paragraph">
<p>When inserting a new record the <code>recversion</code> field assumes a default value 1 (one).</p>
</div>
<div class="paragraph">
<p>When updating the record a special database trigger checks if the new value matches the value in the database: the field is incremented if the values match and an error is generated if not:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs"> Cannot update &lt;grain and table name&gt; ([&lt;primary key field values&gt;]): this record has been already modified by someone. Please start updating again.</code></pre>
</div>
</div>
<div class="paragraph">
<p>In examples above Celesta will throw an exception and will not allow to save the record which causes lost update to the database.</p>
</div>
<div class="paragraph">
<p>Sometimes it is necessary to disable the lost update prevention, for example when the table is intended to be read and appended only or just read-only.
In this case a <code>WITH NO VERSION CHECK</code> <a href="#table_options">option</a> must be used after the table definition in CelestaSQL language.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="celestaunit_section">4.7. CelestaUnit</h3>
<div class="paragraph">
<p>Usually, autotesting for data-modifying system poses certain difficulties and requires resorting to special techniques (like deploying database in a container).
Such tests are usually slow to perform and developers try to avoid them.</p>
</div>
<div class="paragraph">
<p>Testing data-editing methods in Celesta is performed at the level of fast unit tests and a <a href="https://junit.org/junit5/">JUnit5</a> extension is developed for it.
In Celesta, unit tests run on an embedded H2 database operating in an in-memory mode.
This database does not require installation, takes only a moment to start and vanishes after testing is complete.</p>
</div>
<div class="paragraph">
<p>Running a unit test under H2 is sufficient to ensure method correctness in production databases, because Celesta guarantees uniform data access class behaviour for all supported RDBMS (Celesta&#8217;s own testing includes going through scenarios in real RDBMS).</p>
</div>
<div class="paragraph">
<p>To employ these functions, add a CelestaUnit Maven dependency:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;dependency&gt;
    &lt;groupId&gt;ru.curs&lt;/groupId&gt;
    &lt;artifactId&gt;celesta-unit&lt;/artifactId&gt;
    &lt;version&gt;...&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A JUnit5 dependency must also be added to the test scope of the project (see the <a href="https://junit.org/junit5/docs/current/user-guide/#dependency-metadata-junit-jupiter-samples">Junit5 Documentation</a> for examples).</p>
</div>
<div class="sect3">
<h4 id="_usage_example">4.7.1. Usage Example</h4>
<div class="paragraph">
<p>The easiest way to use it is to add a <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celestaunit/CelestaTest.html"><code>@CelestaTest</code></a> annotation to the test class and use <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/CallContext.html"><code>CallContext</code></a> parameters in tests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/*CelestaTest annotation plugs in a JUnit5 extension class ru.curs.celestaunit.CelestaUnitExtension,
  allowing to use CallContext parameters in test methods.*/
@CelestaTest
public class DocumentServiceTest {

    /*Service can be created directly or using DI */

    DocumentService srv = new DocumentService();

    @BeforeEach
    void setUp(CallContext context) {
        //Set up data needed for each test here
    }

    @Test
    /*CallContext parameter will be injected automatically
    based on a temporary H2 database*/
    void documentIsPutToDb(CallContext context) throws ParseException {
        /*Call the service*/
        srv.postOrder(context, ...);
        /*Check if the data got to the database*/
        OrderHeaderCursor header = new OrderHeaderCursor(context);
        header.tryFirst();
        assertEquals("no1", header.getId());
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This means every test can receive an active <code>CallContext</code> as a parameter.
This context is generated based on H2 database, to which a Celesta score is deployed and can be used to create cursors.
When <code>@BeforeEach</code>-annotated methods are used, the same <code>CallContext</code> will be provided in the setup method and test method.</p>
</div>
</div>
<div class="sect3">
<h4 id="_changing_celestaunit_default_settings">4.7.2. Changing CelestaUnit Default Settings</h4>
<div class="paragraph">
<p>CelestaUnit has the following defaults:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>score path: <code>src/main/resources/score</code>;</p>
</li>
<li>
<p>reference integrity check (with foreign keys) is enabled;</p>
</li>
<li>
<p>table clearing before each test is enabled;</p>
</li>
<li>
<p>sequence resetting before each test is enabled.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Defaults can be changed by using <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celestaunit/CelestaTest.html"><code>@CelestaTest</code></a> annotation parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CelestaTest(scorePath = DocumentServiceTest.SCORE_PATH,
    referentialIntegrity = true,
    truncateTables = false,
    resetSequences = false)
public class DocumentServiceTest {
    public static final String SCORE_PATH = "src/test/resources/score";</code></pre>
</div>
</div>
<div class="paragraph">
<p>In some cases it might help to disable reference integrity check to simplify adding test data to tables linked by foreign keys to other tables.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_part_5_working_with_metadata">5. Part 5. Working with Metadata</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="Celesta_metadata">5.1. Metadata</h3>
<div class="sect3">
<h4 id="_metadata_and_dynamic_metadata_modification">5.1.1. Metadata and Dynamic Metadata Modification</h4>
<div class="paragraph">
<p>A <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/Celesta.html"><code>Celesta</code></a> class instance is available with a <strong>getCelesta()</strong> method of a <code><a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/CallContext.html">CallContext</a> context</code> variable sent as an argument to every data processing procedure.</p>
</div>
<div class="paragraph">
<p>The <strong>getScore()</strong> method provides the solution developer access to the system score built during parsing of CelestaSQL files.
Score access is necessary to receive information on current database structure when executing business logic code, including metadata bound to database objects using <a href="#CelestaDoc">CelestaDoc</a>.</p>
</div>
<div class="paragraph">
<p>Score objects are not immutable, current score state can be saved to CelestaSQL files using a <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/GrainSaver.html"><code>GrainSaver</code></a> class.</p>
</div>
<div class="paragraph">
<p>Score mutability must be used to develop tools that can read and generate CelestaSQL, for example, for integration with database visual design tools.
Changing the score during the Celesta run time is not allowed and may cause non-determinate system behaviour.</p>
</div>
</div>
<div class="sect3">
<h4 id="_score_composition">5.1.2. Score Composition</h4>
<div class="paragraph">
<p>The score (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/Score.html"><code>Score</code></a>) is divided into grains (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/Grain.html"><code>Grain</code></a>) consisting of tables (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/Table.html"><code>Table</code></a>),  indices (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/Index.html"><code>Index</code></a>) and views (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/View.html"><code>View</code></a>).</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tables consist of columns (see <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/Column.html"><code>Column</code></a>) and contain foreign keys.</p>
</li>
<li>
<p>Indices belong to tables and contain their columns.</p>
</li>
<li>
<p>Views contain (<a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/ViewColumnMeta.html"><code>ViewColumnMeta</code></a>) view columns that differ from table columns, but share some properties with them.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A class diagram that describes the <code>Score</code> classes is presented below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="metaclasses.png" alt="metaclasses" width="696" height="607">
</div>
</div>
<div class="paragraph">
<p>The <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/ColumnMeta.html"><code>ColumnMeta&lt;V&gt;</code></a> interface is basic for table and view columns (<code>V</code> type parameter corresponds to the Java type stored in the column value), which allows to determine the Celesta column data type, column nullability and <a href="#CelestaDoc">CelestaDoc</a> bound to it.
This interface is implemented by <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/ViewColumnMeta.html"><code>ViewColumnMeta&lt;V&gt;</code></a> class to describe view fields and <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/View.html"><code>Column&lt;V&gt;</code></a> to describe table fields.</p>
</div>
<div class="paragraph">
<p>The <code>Column&lt;V&gt;</code> class is abstract and has subclasses for six field types supported in Celesta:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="columnclasses.png" alt="columnclasses" width="1101" height="407">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_score_modification">5.1.3. Score Modification</h4>
<div class="paragraph">
<p>Score modification is used only to develop CelestaSQL code generating tools.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Score modification when a Celesta-based application is running may cause non-determinate system behaviour.
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>To <strong>create</strong> new score objects constructors are used.
Some links to other elements are passed as parameters, for example,  <code>IntegerColumn(table, name)</code> creates an integer field named <code>name</code> in the <code>table</code>.</p>
</li>
<li>
<p>To <strong>remove</strong> objects <code>delete()</code> methods are used defined in most of score classes.</p>
</li>
<li>
<p>Each <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/NamedElement.html"><code>NamedElement</code></a> subclass has <code>getCelestaDoc()</code> and <code>setCelestaDoc()</code> methods to read and set CelestaDoc documenting string.
CelestaDoc comments are saved when dynamically modified Celesta score is saved to the file.</p>
</li>
<li>
<p>See the corresponding  <a href="https://courseorchestra.github.io/celesta/apidocs/index.html?ru/curs/celesta/score/package-summary.html">API Documentation</a> for information on work with score objects.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_appendix">6. Appendix</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="best_practices">6.1. Best Practices</h3>
<div class="paragraph">
<p>These advises help avoid some common mistakes when writing code to work with RDBMS using Celesta and describe some proven patterns.</p>
</div>
<div class="sect3">
<h4 id="_close_the_cursors_created_in_the_iteration_explicitly">6.1.1. Close the Cursors Created in the Iteration Explicitly</h4>
<div class="paragraph">
<p>Cursor is an object containing JDBC PreparedStatements and ResultSets necessary to execute cursor methods.
These resources must be closed after use.
Besides, the cursors and the objects constituting its inner state are not threadsafe, so the cursor must not be stored as a shared resource.
Cursor closing, loosing a link to it and transaction completion must normally happen simultaneously.</p>
</div>
<div class="paragraph">
<p>Cursor life cycle is limited to <code>CallContext</code> life cycle it was created with.
Calling <code>close()</code> on <code>CallContext</code> results in closing all cursors created in that context, so normally it is not necessary to explicitly close cursors in the code.</p>
</div>
<div class="paragraph">
<p>Still in some situations, when the cursor is created in an iteration, it must be closed explicitly.</p>
</div>
<div class="paragraph">
<p>CallContext <a href="#too_many_accessors_warning">does not allow to create more than 1023 cursors</a> (otherwise it throws an exception).
If a cursor can be created in an iteration, it must be closed (in the next point the code will be improved):</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">BAD</th>
<th class="tableblock halign-center valign-top">OK</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CelestaTransaction
void doSomething(CallContext context) {
  for (int i = 0; i &lt; 2000; i++)
    doSomethingElse(context);
}

void doSomethingElse(CallContext context) {
  //Exception: too many data accessors
  FooCursor foo = new FooCursor (context);
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CelestaTransaction
void doSomething(CallContext context) {
  for (int i = 0; i &lt; 2000; i++)
    doSomethingElse(context);
}

void doSomethingElse(CallContext context) {
  try(FooCursor foo = new FooCursor (context)){
  /*no exception thrown, but
  we can do better!*/
  }
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_avoid_creating_cursors_in_iterations">6.1.2. Avoid Creating Cursors in Iterations</h4>
<div class="paragraph">
<p>Opening and closing cursors in iterations results in multiple opening and closing JDBC PreparedStatements which is not optimal.
The best solution is to design code where cursors are created in the beginning of the service method and then reused:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">OK</th>
<th class="tableblock halign-center valign-top">CORRECT</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CelestaTransaction
void doSomething(CallContext context) {
  for (int i = 0; i &lt; 2000; i++)
    doSomethingElse(context);
}

void doSomethingElse(CallContext context) {
  try(FooCursor foo = new FooCursor (context)){
  /*no exception thrown, but
  we can do better!*/
  }
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@CelestaTransaction
void doSomething(CallContext context) {
  FooCursor foo = new FooCursor (context);
  for (int i = 0; i &lt; 2000; i++)
   doSomethingElse(foo);
}
void doSomethingElse(FooCursor foo) {
  /*now we do not create-and-close
  the cursor in each iteration*/
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_limit_the_set_of_the_columns_fetched_by_cursor">6.1.3. Limit the Set of the Columns Fetched by Cursor</h4>
<div class="paragraph">
<p>If the table being read has many columns, but only some of them are worked with, <a href="#limit_columns">define the needed columns explicitly</a> to speed it up.
It can significantly reduce the amount of data transferred from the database.</p>
</div>
</div>
<div class="sect3">
<h4 id="_methods_not_addressing_the_database_are_fast">6.1.4. Methods not Addressing the Database are Fast</h4>
<div class="paragraph">
<p>Cursor methods can be divided in three categories:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Not addressing the database</th>
<th class="tableblock halign-left valign-top">Reading</th>
<th class="tableblock halign-left valign-top">Updating</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p>setting / field reading</p>
</li>
<li>
<p><code>setRange</code></p>
</li>
<li>
<p><code>setFilter</code></p>
</li>
<li>
<p><code>setComplexFilter</code></p>
</li>
<li>
<p><code>setIn</code></p>
</li>
<li>
<p><code>limit</code></p>
</li>
<li>
<p><code>orderBy</code></p>
</li>
<li>
<p><code>reset</code></p>
</li>
<li>
<p><code>clear</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><code>[try]Get</code></p>
</li>
<li>
<p><code>[try]First</code></p>
</li>
<li>
<p><code>[try]Last</code></p>
</li>
<li>
<p><code>[try]FindSet</code></p>
</li>
<li>
<p><code>next</code></p>
</li>
<li>
<p><code>navigate</code></p>
</li>
<li>
<p><code>count</code></p>
</li>
</ul>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="ulist">
<ul>
<li>
<p><code>[try]Insert</code></p>
</li>
<li>
<p><code>[try]Update</code></p>
</li>
<li>
<p><code>delete</code></p>
</li>
<li>
<p><code>deleteAll</code></p>
</li>
</ul>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Calling methods of the first category does not result in sending any queries to the database.
For example, <code>orderBy</code> does not range entries at the moment the call happens, it only forms the cursor state to be used for forming SQL queries during the second and third category methods execution.</p>
</div>
<div class="paragraph">
<p>So the right pattern is to "prepare" the cursor as much as possible by setting all necessary limits using the first category methods before executing reading methods.</p>
</div>
</div>
<div class="sect3">
<h4 id="_understand_the_get_method_semantics">6.1.5. Understand the <code>get(&#8230;&#8203;)</code> Method Semantics</h4>
<div class="paragraph">
<p>The <code>get(&#8230;&#8203;)</code> method extracts a single record from the database by its known primary key.
It is a reliably fast (because the primary key always has an index) and the most demanded operation in practice.
The <code>get(&#8230;&#8203;)</code> method <em>does not account for</em> existence of any filters set for the cursor, so in rare cases when it is necessary to check if a record with a known key is in the range set by filters, a <code>navigate("=")</code> method must be used.</p>
</div>
</div>
<div class="sect3">
<h4 id="_do_not_read_before_deleting_if_not_necessary">6.1.6. Do not Read before Deleting if not Necessary</h4>
<div class="paragraph">
<p>If the primary key of an entry for deletion is known, do not read it from the database using <code>get</code> or <code>find</code>.
Filling the primary key fields with correct values is enough for the <code>delete()</code> method.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">WRONG</th>
<th class="tableblock halign-center valign-top">CORRECT</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (foo.tryGet(idForDeletion)) {
	foo.delete();
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">foo.setId(idForDeletion);
foo.delete();</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_do_not_use_count_only_to_determine_if_the_data_range_is_not_empty">6.1.7. Do not Use <code>count()</code> Only to Determine if the Data Range is not Empty</h4>
<div class="paragraph">
<p>Common mistake is to check the range for emptiness using the <code>count()</code> method.
Counting all the records in the database only to determine if there are any at all is a bad idea.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">WRONG</th>
<th class="tableblock halign-center valign-top">CORRECT</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (fooCursor.count() &gt; 0) {
	...
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (fooCursor.tryFirst()) {
	...
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_use_sorting_at_the_database_level_to_find_min_max_values">6.1.8. Use Sorting at the Database Level to Find Min./Max. Values</h4>
<div class="paragraph">
<p>If the search can be done in the database itself, better do that instead of sending the whole record set to the application to search using the application&#8217;s resources:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">WRONG</th>
<th class="tableblock halign-left valign-top">CORRECT</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Iterating entries to find the maximum <code>bar</code> field value.</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">foo.orderBy(foo.COLUMNS.bar().desc());
foo.first();</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_use_the_correct_filter_type">6.1.9. Use the Correct Filter Type</h4>
<div class="paragraph">
<p>There are four data filtering methods in Celesta, ranged from the simplest to the most complex:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>setRange</code></p>
</li>
<li>
<p><code>setFilter</code></p>
</li>
<li>
<p><code>setComplexFilter</code></p>
</li>
<li>
<p><code>setIn</code></p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Do not use more complex filters if the simpler one suffice!</strong></p>
</div>
<div class="paragraph">
<p>The <a href="#set_range_usage"><code>setRange</code></a> method is applicable in most practical tasks to filter a field by a single value or a of range values:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>cursor.setRange(cursor.COLUMNS.foo(), value)</code> creates a query in a <code>WHERE foo = value</code> format;</p>
</li>
<li>
<p><code>cursor.setRange(cursor.COLUMNS.foo(), from, to)</code> creates a query in a <code>WHERE foo BETWEEN from AND to</code> format.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<code>cursor.setRange(cursor.COLUMNS.foo())</code> (no parameters) removes a filter for the <code>foo</code> field created earlier by <code>setRange</code> or <code>setFilter</code>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <a href="#setFilter_usage"><code>setFilter</code></a> method is used in rare cases when a field value range to be filtered needs to be set as a complex expression.
A single field can have either a filter set by <code>setRange</code> or by <code>setFilter</code>, so calling these methods for the same field "replaces" the previously set filter.</p>
</div>
<div class="paragraph">
<p><code>setRange</code> must be used whenever possible so Celesta can reuse JDBC <code>PreparedStatement</code> statements to greatly increase performance during the iteration:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">WRONG</th>
<th class="tableblock halign-center valign-top">CORRECT</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooCursor foo = new FooCursor(context);
BarCursor bar = new BarCursor(context);
for (FooCursor c: foo){
  bar.setFilter("baz", ""+c.getBaz()+"");
  /* PreparedStatements are
  re-created in each iteration :-(( */
  ...
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooCursor foo = new FooCursor(context);
BarCursor bar = new BarCursor(context);
for (FooCursor c: foo){
  bar.setRange(baz, c.getBaz());
  /* PreparedStatement is created
  only once and is being reused :-)*/
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Also <code>setRange</code> is preferred because its API allows to control types sent as arguments for the method.</p>
</div>
<div class="paragraph">
<p>The <a href="#set_complex_filter_usage"><code>setComplexFilter</code></a> method allows to add "a piece of SQL" to a <code>WHERE</code> expression setting the cursor entry set.
After any <code>setComplexFilter</code> call all JDBC <code>PreparedStatement</code> statements must be recreated, so as with <code>setFilter</code>, it is not efficient to call it in an iteration.
Main use for this method is to set conditions involving two or more fields, for example: <code>a &gt;= b</code>.
In other cases <code>setRange</code>/<code>setFilter</code> should be used.</p>
</div>
<div class="paragraph">
<p>The <a href="#setIn_usage"><code>setIn</code></a> method is instrumental in situations when the set of filtered values is determined dynamically from other data in the database.</p>
</div>
</div>
<div class="sect3">
<h4 id="_use_indices">6.1.10. Use Indices</h4>
<div class="paragraph">
<p>A general point for all RDBMS.
In Celesta, usually the following is true: if a <code>setRange</code> method is called for a cursor field, create an index for that field.</p>
</div>
</div>
<div class="sect3">
<h4 id="_ensure_efficient_caching_when_working_in_iterations">6.1.11. Ensure Efficient Caching when Working in Iterations</h4>
<div class="paragraph">
<p>Querying data in iterations is a common pattern.
It is possible to significantly reduce the number of queries to the database and increase speed by using the simplest caching: there is no need to call <code>get</code> for the cursor if the requested value of the primary key already matches the one requested earlier:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">//mind possible nulls!
if (!Objects.equals(bar.getId(), c.getBarId()))
		bar.get(c.getBarId());
//use newly fetched or cached bar here...</code></pre>
</div>
</div>
<div class="paragraph">
<p>This idea can be developed in a very efficient pattern: it is possible to drastically reduce the number of queries for <code>bar</code> entries to the database by sorting the <code>c</code> cursor by the <code>barId</code> field:</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">WRONG</th>
<th class="tableblock halign-center valign-top">CORRECT</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooCursor foo = new FooCursor(context);
BarCursor bar = new BarCursor(context);
for (FooCursor c: foo){
  bar.get(c.getBarId());
/*fetching data
  in each iteration :-(*/
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">FooCursor foo = new FooCursor(context);
/*note the orderBy!!!*/
foo.orderBy(foo.COLUMNS.barId());
BarCursor bar = new BarCursor(context);
for (FooCursor c: foo){
  if (!Objects.equals(bar.getId(), c.getBarId()))
	/*minimum number of fetches*/
	bar.get(c.getBarId());
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_do_not_use_try_methods_unless_necessary">6.1.12. Do not Use <code>try</code> Methods Unless Necessary</h4>
<div class="paragraph">
<p>Many cursor methods have two versions: with and without a <code>try</code> prefix.
They act the same as far as processing speed is concerned, but from the perspective of code design (fail-fast approach) it is preferable to use methods without <code>try</code> if the returned Boolean value is not going to be used.
See this <a href="#try_method_notice">explained in the documentation</a>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_use_iteration_instead_of_navigation_in_cycles">6.1.13. Use Iteration instead of Navigation in Cycles</h4>
<div class="paragraph">
<p>Two groups of methods exists to move between records in a cursor: navigation and iteration.</p>
</div>
<div class="paragraph">
<p>Navigation methods are <code>tryFirst()</code>, <code>next()</code>, <code>previous()</code> and <code>navigate(&#8230;&#8203;)</code> which allow to move to a different record according to specific rules.</p>
</div>
<div class="paragraph">
<p>Iteration methods are a <code>tryFindSet()</code>  <code>nextInSet()</code> pair and an <code>iterator()</code> method implementing the respective <code>java.lang.Iterable</code> interface method.</p>
</div>
<div class="paragraph">
<p>Navigation methods send a query to the database per each call so they should be utilized when only a single entry is needed.</p>
</div>
<div class="paragraph">
<p>Iteration methods send queries and open JDBC <code>ResultSet</code> used for further movement between records.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-center valign-top">WRONG</th>
<th class="tableblock halign-center valign-top">CORRECT</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">if (foo.tryFirst()){
  do {
     ...
  } while (foo.next());
  /*new query in each iteration :-(*/
}</code></pre>
</div>
</div></div></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">/*only one query! :-)*/
for (FooCursor c: foo) {
  ...
}</code></pre>
</div>
</div></div></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect2">
<h3 id="RDBMS_peculiarities">6.2. Notes on Using Supported RDBMS in Celesta</h3>
<div class="paragraph">
<p>The system supports MS SQL Server, Oracle, Postgre SQL, Firebird and H2 ensuring uniform work of any application written in Celesta with any of the supported RDBMS.</p>
</div>
<div class="paragraph">
<p>Celesta solutions are easily transferable between different RDBMS, but each of them have their own configuration peculiarities.
Besides, different Celesta features are implemented differently in different RDBMS.
This section covers these issues.</p>
</div>
<div class="paragraph">
<p>Correspondence between Celesta data types and RDBMS is given in the <a href="#datatypes_mapping">Celesta-SQL Language: Data Types</a>.</p>
</div>
<div class="imageblock left">
<div class="content">
<img src="images/Mssql.jpg" alt="Mssql" width="80">
</div>
</div>
<div class="sect3">
<h4 id="_ms_sql_server">6.2.1. MS SQL Server</h4>
<div class="sect4">
<h5 id="_usage_features">Usage Features</h5>
<div class="paragraph">
<p>Versions lower than MS SQL Server 2011 do not support the <code>CREATE SEQUENCE</code> statement.</p>
</div>
<div class="imageblock left">
<div class="content">
<img src="images/Ora.jpg" alt="Ora" width="80">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_oracle">6.2.2. Oracle</h4>
<div class="sect4">
<h5 id="_configuration_features">Configuration Features</h5>
<div class="paragraph">
<p><strong>ORA-12705 Error: Cannot access NLS data files&#8230;&#8203;</strong> If an error "ORA-12705: Cannot access NLS data files or invalid environment specified" occurs when launching Celesta on Oracle Express Edition, the following parameter must be set in JVM arguments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">-Duser.country=US</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is a common problem for the Oracle XE + JDBC and is relevant only for Oracle Express Edition, it is never encountered in other (production) Oracle Database versions.</p>
</div>
<div class="paragraph">
<p>Minimal settings for USER access rights to the <strong>Oracle 11g</strong> database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">GRANT
	CONNECT,
	RESOURCE,
	CREATE TABLE,
	CREATE PROCEDURE,
	CREATE VIEW,
	CREATE SEQUENCE,
	CREATE TRIGGER,
	SELECT ANY DICTIONARY
	TO &lt;USER&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Some organizations do not grant the SELECT ANY DICTIONARY permission by default, which results in an error "ORA-00942: table or view does not exist" when deploying Celesta system grain.</p>
</div>
</div>
<div class="sect4">
<h5 id="_implementation_features">Implementation Features</h5>
<div class="ulist">
<ul>
<li>
<p>Grain is a prefix in the table name separated with an underscore symbol, and the Oracle limit for the table name length (30 characters) applies.
Schemas in Oracle are somewhat different from those in other RDMBS and creating schemas is linked to creating new users, but in practice administrators of Oracle enterprise database servers cannot grant applications rights to create new users.</p>
</li>
<li>
<p>Oracle by itself does not support the <code>FOREIGN KEY &#8230;&#8203; ON UPDATE/DELETE SET NULL</code> statement, so it is emulated using triggers.</p>
</li>
</ul>
</div>
<div class="imageblock left">
<div class="content">
<img src="images/postgresql.svg" alt="postgresql" width="120">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_postgresql">6.2.3. PostgreSQL</h4>
<div class="sect4">
<h5 id="_usage_features_2">Usage Features</h5>
<div class="paragraph">
<p>A problem with "uuid" type fields may occur when Celesta is used to access preexisting (and not created and updated in Celesta) database.
Celesta does not support "uuid" data type but can work with it via VARCHAR(36) type fields.
This does not lead to problems in MS SQL Server but for Celesta to work in Postgres it is necessary to explicitly define an operator to compare "varchar" to "uuid" and implicitly change types when assigning:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">CREATE OR REPLACE FUNCTION celesta.uuidequal(a1 uuid, a2 CHARACTER VARYING)
  RETURNS BOOLEAN AS 'select a1::varchar = a2'
  LANGUAGE SQL IMMUTABLE;
CREATE OPERATOR = (
    LEFTARG = uuid,
    RIGHTARG = CHARACTER VARYING,
    PROCEDURE = celesta.uuidequal
);
CREATE CAST (character varying AS uuid)
    WITH  INOUT AS ASSIGNMENT;</code></pre>
</div>
</div>
<div class="imageblock left">
<div class="content">
<img src="images/firebird.svg" alt="firebird" width="120">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_firebird">6.2.4. Firebird</h4>
<div class="sect4">
<h5 id="_implementation_features_2">Implementation Features</h5>
<div class="ulist">
<ul>
<li>
<p>Grain is a prefix in the table name separated with an underscore symbol and the limitation on the identifier length applies.
This is because schemas as is do not exist in Firebird.</p>
</li>
<li>
<p>Firebird starts to support the <code>TIMESTAMP WITH TIMEZONE</code> data type only in the 4th version.</p>
</li>
</ul>
</div>
<div class="imageblock left">
<div class="content">
<img src="images/H2.png" alt="H2" width="120">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_h2">6.2.5. H2</h4>
<div class="sect4">
<h5 id="_configuration_features_2">Configuration Features</h5>
<div class="ulist">
<ul>
<li>
<p>To simplify the in-memory database startup it is possible to add a <code>h2.in-memory=true</code> setting in the <a href="#basic_settings_section">configuration settings</a>.
In this case the JDBC connection string as well as the user&#8217;s login and password set by other settings is ignored.</p>
</li>
<li>
<p>Configuration settings have a <code>h2.referential.integrity=false(by default)/true</code> setting.
The <code>false</code> values means that foreign key type limitations are going to be ignored when recording in the database.
When enabled, these limitation are going to be proceeded just like in other RDBMS.
To set this not in the in-memory database the user must have administrator rights (the "ADMIN" field in the "INFORMATION_SCHEMA.USERS" table). This setting activates only once on the application startup and to update it a restart is needed.</p>
</li>
</ul>
</div>
</div>
<div class="sect4">
<h5 id="_implementation_features_3">Implementation Features</h5>
<div class="ulist">
<ul>
<li>
<p>The <code>recversion</code> field is controlled by a trigger written in Java which implements an <a href="https://www.h2database.com/javadoc/org/h2/api/Trigger.html"><code>org.h2.api.Trigger</code></a> interface. H2 does not support triggers with logic in procedural SQL.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="DBSchema">6.3. Celesta Database Design in DBSchema</h3>
<div class="sect3">
<h4 id="_synchronyzing_celesta_score_and_dbschema_project">6.3.1. Synchronyzing Celesta Score and DBSchema Project</h4>
<div class="paragraph">
<p><a href="https://dbschema.com/">DBSchema</a> is a convenient tool for database visual design.
It is possible to fully simulate all Celesta information on the database structure (tables, fields, keys and indices) in DBSchema or to turn an existing Celesta score into a DBSchema diagram.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/800px-Dbschemascreen.png" alt="800px Dbschemascreen" width="100%">
</div>
</div>
<div class="sect4">
<h5 id="_system_configuration">System Configuration</h5>
<div class="paragraph">
<p>Required software:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://dbschema.com/">DBSchema</a> (proprietary program).</p>
</li>
<li>
<p><a href="https://github.com/courseorchestra/dbschemasync"><code>dbschemasync</code></a> utility.
Up-to-date version of the <code>dbschemasync</code> utility can be acquired <a href="https://artifactory.corchestra.ru/artifactory/list/libs-release-local/ru/curs/dbschemasync/">here</a>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Extract files from the zip-archive and move the Celesta folder containing DBSchema settings to <code>%userprofile%\.DbSchema\config\rdbms\</code>.</p>
</div>
<div class="paragraph">
<p>An executable <code>dbschemasync</code> file is in the <code>/bin</code> folder of the archive.</p>
</div>
</div>
<div class="sect4">
<h5 id="_launching_synchronization">Launching Synchronization</h5>
<div class="paragraph">
<p>The <code>dbschemasync</code> utility accepts two settings:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>score path;</p>
</li>
<li>
<p>DBS file name (of the DBSchema project).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The direction of synchronization is determined by the argument sequence: if the score path is first, synchronization goes from the score to the DBSchema project and vice versa.</p>
</div>
<div class="paragraph">
<p>An example of a command to synchronize from the score to the schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dbschemasync "c:/temp/dbschema/score/" "c:/temp/dbschema/schema.dbs"</code></pre>
</div>
</div>
<div class="paragraph">
<p>An example of synchronization from the schema to the score:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">dbschemasync "c:/temp/dbschema/schema.dbs" "c:/temp/dbschema/score/"</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_features_of_designing_database_structure">Features of Designing Database Structure</h5>
<div class="paragraph">
<p>All contents of <a href="#CelestaDoc">CelestaDoc</a> are converted into DBSchema Documentation fields and vice versa.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/800px-Dbschemascreen3.png" alt="800px Dbschemascreen3" width="100%">
</div>
</div>
<div class="paragraph">
<p>Table options (<code>WITH (NO) VERSION CHECK</code>, <code>WITH READ ONLY</code>&#8230;&#8203;) are in the "Storage" tab:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/Dbschemascreen4.png" alt="Dbschemascreen4" width="80%">
</div>
</div>
<div class="paragraph">
<p>To set a grain version in DBSchema, it is necessary to modify a fake "stored procedure" with the same name as the grain (obviously, DBScema does not simulate the stored procedures for Celesta):</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/Dbschemascreen2.png" alt="Dbschemascreen2" width="80%">
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creating_celestasql_scripts_based_on_the_structure_of_an_existing_database">6.3.2. Creating CelestaSQL Scripts Based on the Structure of an Existing Database</h4>
<div class="paragraph">
<p>Everybody who need to create CelestaSQL scripts for an existing database are encouraged to use this technology.
Other options (like uploading the SQL script from the database and its manual "cleaning") proved to be much more labor intensive.</p>
</div>
<div class="paragraph">
<p>DBSchema program with an installed Celesta support helps here.
Here are the steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Connect DBSchema to the necessary database using a "Reverse Engineering" method, upload the required structure (at this stage it is possible to upload only the tables and foreign keys required in Celesta).
Make sure you "took" all the tables you need, because at later steps you will have to "disconnect" the project from the database and it will not be possible to automatically acquire information about the tables.</p>
</li>
<li>
<p>Disconnect DBSchema from the database (offline) and change the database type from SQL Server to Celesta in the Project&#8594;Project Settings menu (DBSchema is expected to have a pre-installed add-on for synchronization with Celesta).
DBSchema will open a window and offer to compare types.
It is necessary to carefully set type correspondence for Celesta: for SQL Server, for example, <code>VARCHAR(MAX)</code> must be converted to <code>TEXT</code>, <code>UUID</code> to <code>VARCHAR(36)</code> and so on.</p>
</li>
<li>
<p>By pressing the OK button we get a Celesta-oriented DBSchema project.
At this moment it can be saved at a separate location: it is no longer connected to the source database.
Still it is not a correct project as it lacks grain division, grains are not assigned declarations and there are a lot of features foreign to Celesta.
At this stage grains (schemas) must be created manually and tables put in them.</p>
</li>
<li>
<p>The "schemasync.jar" utility will most likely cause error prompts if activated, because the project is still incorrect.
So we need to use a Schema&#8594;Generate Schema Script command to save all tables in a single SQL file.
The resulting script will be very similar to a Celesta script and it is easy to do finishing touches by hand, e.g. remove the functions Celesta does not support, divide the script into files, somehow fix the names exceeding 30 characters, etc.</p>
</li>
<li>
<p>It is time to try to launch Celesta with your scripts.</p>
</li>
<li>
<p>If you want to further use DBSchema, it is recommended to use the "schemasync.jar" to link to a completely empty DBSchema project (you can delete the intermediate DBSchema project), but only when Celesta "agrees" to work with your script.
This is because the "schemasync.jar" utility incorporates a Celesta SQL script parser and it cannot process what Celesta itself cannot process.</p>
</li>
</ol>
</div>
</div>
<div class="sect3">
<h4 id="_export_to_plantuml">6.3.3. Export to PlantUML</h4>
<div class="paragraph">
<p>On the start of <code>dbschemasync</code> in convertation mode from DBSchema to score, the third command line option <code>-adoc</code> simultaneously generates diagrams in <a href="https://plantuml.com">PlantUML</a> format for each DBSchema digram.
Diagram file names match names of DBSchema sheets with diagrams.</p>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2024-03-16 22:04:32 UTC
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>